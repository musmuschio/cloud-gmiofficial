<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Administrator Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-white text-gray-800">

  <!-- Navigation Bar -->
  <div class="flex items-center justify-between bg-gray-100 px-4 py-2 shadow">
    <!-- Left SPA Buttons -->
    <div class="flex gap-2">
      <button onclick="loadSPA('spectate')" class="spa-btn bg-blue-600 text-white px-3 py-1 rounded">Spectate</button>
      <button onclick="loadSPA('jurnalist')" class="spa-btn bg-green-600 text-white px-3 py-1 rounded">News</button>
      <button onclick="loadSPA('mcs')" class="spa-btn bg-purple-600 text-white px-3 py-1 rounded">MCS</button>
      <button onclick="loadSPA('moa')" class="spa-btn bg-red-600 text-white px-3 py-1 rounded">MOA</button>
    </div>
    <!-- Right Token Info & Countdown -->
    <div class="text-right">
      <div>Token: <span id="tokenDisplay" class="font-mono font-semibold text-blue-700"></span></div>
      <div class="text-sm text-gray-600">Sisa waktu: <span id="timer" class="font-semibold"></span></div>
    </div>
  </div>

  <!-- Content Iframes -->
  <div class="grid grid-cols-2 gap-1 h-[calc(100vh-60px)]">
    <iframe id="frame1" class="w-full h-full border-none"></iframe>
    <iframe id="frame2" class="w-full h-full border-none"></iframe>
  </div>

  <!-- Firebase & Logic -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let activeToken = localStorage.getItem('admin_token');
    let expiryTime;

    async function validateToken() {
      if (!activeToken) {
        window.location.href = 'kloterAdmin.html';
        return;
      }

      const query = await db.collection('token').where('value', '==', activeToken).get();
      if (query.empty) {
        window.location.href = 'kloterAdmin.html';
        return;
      }

      const doc = query.docs[0];
      const data = doc.data();
      const createdAt = data.createdAt?.toDate();
      if (!createdAt) {
        window.location.href = 'kloterAdmin.html';
        return;
      }

      expiryTime = new Date(createdAt.getTime() + 6 * 60 * 60 * 1000);
      const now = new Date();
      if (now > expiryTime) {
        localStorage.removeItem('admin_token');
        window.location.href = 'kloterAdmin.html';
      }

      document.getElementById('tokenDisplay').textContent = activeToken;
      startCountdown();
      loadSPA('spectate');
    }

    function startCountdown() {
      const timerEl = document.getElementById('timer');
      const interval = setInterval(() => {
        const now = new Date();
        const diff = expiryTime - now;

        if (diff <= 0) {
          clearInterval(interval);
          localStorage.removeItem('admin_token');
          alert("Token kedaluwarsa!");
          window.location.href = 'kloterAdmin.html';
        }

        const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
        const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
        const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');

        timerEl.textContent = `${h}:${m}:${s}`;
      }, 1000);
    }

    function loadSPA(mode) {
      const frame1 = document.getElementById('frame1');
      const frame2 = document.getElementById('frame2');

      switch (mode) {
        case 'spectate':
          frame1.src = 'users.html';
          frame2.src = 'statues.html';
          break;
        case 'jurnalist':
          frame1.src = 'jurnalis.html';
          frame2.src = 'news.html';
          break;
        case 'mcs':
          frame1.src = 'mcs.html';
          frame2.src = 'informasi.html';
          break;
        case 'moa':
          frame1.src = 'affiliate.html';
          frame2.src = 'affiliate-spect.html';
          break;
        default:
          frame1.src = '';
          frame2.src = '';
      }
    }

    // Start on load
    validateToken();
  </script>
</body>
</html>
