<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrator Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23",
      storageBucket: "gmi-enterprise23.firebasestorage.app",
      messagingSenderId: "974090028804",
      appId: "1:974090028804:web:43ae563ffd9433463c7251",
      measurementId: "G-S27YB5Z8PR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.addEventListener("load", () => {
      const tokenTextEl = document.getElementById("token-text");
      const countdownEl = document.getElementById("countdown-timer");
      const frame1 = document.getElementById("frame1");
      const frame2 = document.getElementById("frame2");

      const btnSpectate = document.getElementById("btn-spectate");
      const btnNews = document.getElementById("btn-news");
      const btnMcs = document.getElementById("btn-mcs");
      const btnMoa = document.getElementById("btn-moa");

      const spaMenus = {
        spectate: {
          frame1: "users.html",
          frame2: "statues.html",
        },
        news: {
          frame1: "jurnalis.html",
          frame2: "news.html",
        },
        mcs: {
          frame1: "mcs.html",
          frame2: "informasi.html",
        },
        moa: {
          frame1: "affiliate.html",
          frame2: "affiliate-spect.html",
        },
      };

      let currentMenu = "spectate";

      function updateFrames(menu) {
        if (!spaMenus[menu]) return;
        frame1.src = spaMenus[menu].frame1;
        frame2.src = spaMenus[menu].frame2;
        currentMenu = menu;
        updateButtonStates();
      }

      function updateButtonStates() {
        [btnSpectate, btnNews, btnMcs, btnMoa].forEach((btn) => {
          btn.setAttribute("aria-pressed", "false");
          btn.classList.remove("text-blue-600", "font-bold");
          btn.classList.add("text-gray-700", "font-semibold");
        });
        let activeBtn;
        switch (currentMenu) {
          case "spectate":
            activeBtn = btnSpectate;
            break;
          case "news":
            activeBtn = btnNews;
            break;
          case "mcs":
            activeBtn = btnMcs;
            break;
          case "moa":
            activeBtn = btnMoa;
            break;
        }
        if (activeBtn) {
          activeBtn.setAttribute("aria-pressed", "true");
          activeBtn.classList.remove("text-gray-700", "font-semibold");
          activeBtn.classList.add("text-blue-600", "font-bold");
        }
      }

      btnSpectate.addEventListener("click", () => updateFrames("spectate"));
      btnNews.addEventListener("click", () => updateFrames("news"));
      btnMcs.addEventListener("click", () => updateFrames("mcs"));
      btnMoa.addEventListener("click", () => updateFrames("moa"));

      let countdownInterval = null;

      function formatTime(seconds) {
        const h = Math.floor(seconds / 3600)
          .toString()
          .padStart(2, "0");
        const m = Math.floor((seconds % 3600) / 60)
          .toString()
          .padStart(2, "0");
        const s = (seconds % 60).toString().padStart(2, "0");
        return `${h}:${m}:${s}`;
      }

      function redirectToLogin() {
        window.location.href = "kloterAdmin.html";
      }

      async function validateToken() {
        const token = localStorage.getItem("tokenAdmin");
        if (!token) {
          redirectToLogin();
          return;
        }

        try {
          const docRef = doc(db, "tokens", token);
          const docSnap = await getDoc(docRef);

          if (!docSnap.exists()) {
            redirectToLogin();
            return;
          }

          const data = docSnap.data();
          if (!data.expiresAt) {
            redirectToLogin();
            return;
          }

          let expiresAt;
          if (data.expiresAt instanceof Timestamp) {
            expiresAt = data.expiresAt.toDate();
          } else if (data.expiresAt._seconds) {
            // fallback if Timestamp object is plain
            expiresAt = new Date(data.expiresAt._seconds * 1000);
          } else {
            expiresAt = new Date(data.expiresAt);
          }

          const now = new Date();

          if (expiresAt <= now) {
            redirectToLogin();
            return;
          }

          tokenTextEl.textContent = `Token: ${token}`;

          startCountdown(expiresAt);

        } catch {
          redirectToLogin();
        }
      }

      function startCountdown(expiresAt) {
        if (countdownInterval) clearInterval(countdownInterval);

        function update() {
          const now = new Date();
          const diff = Math.floor((expiresAt - now) / 1000);
          if (diff <= 0) {
            countdownEl.textContent = "00:00:00";
            redirectToLogin();
            clearInterval(countdownInterval);
            return;
          }
          countdownEl.textContent = formatTime(diff);
        }

        update();
        countdownInterval = setInterval(update, 1000);
      }

      validateToken();
      updateButtonStates();
      updateFrames(currentMenu);
    });
  </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <nav
    class="flex items-center justify-between bg-white shadow px-4 sm:px-6 lg:px-8 h-14 select-none"
    role="navigation"
    aria-label="Main navigation"
  >
    <div class="flex items-center space-x-2 sm:space-x-4">
      <button
        id="btn-spectate"
        class="text-gray-700 hover:text-blue-600 font-semibold px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        type="button"
        aria-pressed="true"
      >
        Spectate
      </button>
      <button
        id="btn-news"
        class="text-gray-700 hover:text-blue-600 font-semibold px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        type="button"
        aria-pressed="false"
      >
        News
      </button>
      <button
        id="btn-mcs"
        class="text-gray-700 hover:text-blue-600 font-semibold px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        type="button"
        aria-pressed="false"
      >
        MCS
      </button>
      <button
        id="btn-moa"
        class="text-gray-700 hover:text-blue-600 font-semibold px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        type="button"
        aria-pressed="false"
      >
        MOA
      </button>
    </div>
    <div class="flex items-center space-x-4 text-gray-700 font-mono text-sm sm:text-base select-text">
      <div id="token-text" aria-live="polite" aria-atomic="true" class="whitespace-nowrap"></div>
      <div id="countdown-timer" aria-live="polite" aria-atomic="true" class="font-semibold text-red-600 tabular-nums"></div>
    </div>
  </nav>

  <main class="flex-1 flex flex-col sm:flex-row border-t border-gray-200">
    <iframe
      id="frame1"
      src="users.html"
      title="Frame 1 content"
      class="w-full sm:w-1/2 h-[calc(100vh-56px)] border-r border-gray-200"
      frameborder="0"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
    ></iframe>
    <iframe
      id="frame2"
      src="statues.html"
      title="Frame 2 content"
      class="w-full sm:w-1/2 h-[calc(100vh-56px)]"
      frameborder="0"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
    ></iframe>
  </main>

</body>
</html>
