<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrator Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="flex h-screen">
    <!-- Navigation -->
    <nav class="w-64 bg-white shadow-md p-4 space-y-2">
      <button onclick="loadSPA('spectate')" class="w-full bg-blue-500 text-white py-2 rounded">Spectate</button>
      <button onclick="loadSPA('jurnalist')" class="w-full bg-green-500 text-white py-2 rounded">News</button>
      <button onclick="loadSPA('mcs')" class="w-full bg-yellow-500 text-white py-2 rounded">MCS</button>
      <button onclick="loadSPA('moa')" class="w-full bg-purple-500 text-white py-2 rounded">MOA</button>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
      <!-- Token Info -->
      <div class="flex justify-between items-center p-4 bg-gray-200">
        <div id="tokenLabel" class="font-bold"></div>
        <div id="timer" class="text-red-600 font-mono"></div>
      </div>

      <!-- Frames -->
      <div class="flex flex-1">
        <iframe id="frame1" class="w-1/2 h-full border-r"></iframe>
        <iframe id="frame2" class="w-1/2 h-full"></iframe>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tokenKey = 'adminToken';
    let expiryTimestamp = null;

    async function checkToken() {
      const token = localStorage.getItem(tokenKey);
      if (!token) {
        return redirectToTokenInput();
      }

      const snapshot = await db.collection('token').where('value', '==', token).get();
      if (snapshot.empty) {
        return redirectToTokenInput();
      }

      const doc = snapshot.docs[0];
      const createdAt = doc.data().createdAt?.toDate();
      if (!createdAt) return redirectToTokenInput();

      expiryTimestamp = createdAt.getTime() + 6 * 60 * 60 * 1000;
      const now = new Date().getTime();
      if (now > expiryTimestamp) {
        localStorage.removeItem(tokenKey);
        return redirectToTokenInput();
      }

      document.getElementById('tokenLabel').textContent = `Token: ${token}`;
      startCountdown(expiryTimestamp - now);
    }

    function redirectToTokenInput() {
      const input = prompt("Masukkan Token Admin:");
      if (!input) return location.reload();
      validateToken(input);
    }

    async function validateToken(input) {
      const snapshot = await db.collection('token').where('value', '==', input).get();
      if (snapshot.empty) return alert('Token tidak valid');

      const doc = snapshot.docs[0];
      const createdAt = doc.data().createdAt?.toDate();
      if (!createdAt) return alert('Token tidak valid');

      const now = new Date().getTime();
      const expire = createdAt.getTime() + 6 * 60 * 60 * 1000;

      if (now > expire) return alert('Token sudah kedaluwarsa');

      localStorage.setItem(tokenKey, input);
      location.reload();
    }

    function startCountdown(duration) {
      const timerEl = document.getElementById('timer');
      let remaining = duration;

      const interval = setInterval(() => {
        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
        timerEl.textContent = `${hours.toString().padStart(2, '0')}:${
          minutes.toString().padStart(2, '0')}:${
          seconds.toString().padStart(2, '0')}`;

        remaining -= 1000;
        if (remaining <= 0) {
          clearInterval(interval);
          alert('Token expired');
          localStorage.removeItem(tokenKey);
          location.reload();
        }
      }, 1000);
    }

    function loadSPA(type) {
      const frame1 = document.getElementById('frame1');
      const frame2 = document.getElementById('frame2');

      switch (type) {
        case 'spectate':
          frame1.src = 'users.html';
          frame2.src = 'statues.html';
          break;
        case 'jurnalist':
          frame1.src = 'jurnalis.html';
          frame2.src = 'news.html';
          break;
        case 'mcs':
          frame1.src = 'mcs.html';
          frame2.src = 'informasi.html';
          break;
        case 'moa':
          frame1.src = 'affiliate.html';
          frame2.src = 'affiliate-spect.html';
          break;
      }
    }

    window.onload = checkToken;
  </script>
</body>
</html>
