import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
  authDomain: "gmi-enterprise23.firebaseapp.com",
  projectId: "gmi-enterprise23",
  storageBucket: "gmi-enterprise23.firebasestorage.app",
  messagingSenderId: "974090028804",
  appId: "1:974090028804:web:43ae563ffd9433463c7251",
  measurementId: "G-S27YB5Z8PR"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.cekToken = async function () {
  const inputToken = document.getElementById("kirimtoken").value.trim();
  const submitBtn = document.querySelector('button[onclick="cekToken()"]');

  if (!inputToken) {
    alert("Token tidak boleh kosong");
    document.getElementById("kirimtoken").focus();
    return;
  }

  try {
    // Disable tombol submit selama pengecekan token berlangsung
    submitBtn.disabled = true;
    submitBtn.textContent = "Checking...";

    const tokenRef = doc(db, "tokenAdmin", "tokenDoc");
    const tokenSnap = await getDoc(tokenRef);

    if (!tokenSnap.exists()) {
      alert("Token belum tersedia. Hubungi operator.");
      return;
    }

    const tokenData = tokenSnap.data();

    if (tokenData.token !== inputToken) {
      alert("Token salah atau tidak terdaftar.");
      return;
    }

    // Validasi expiry token dengan cek tipe data timestamp dan waktu sekarang
    if (!tokenData.expiry || !(tokenData.expiry.toDate instanceof Function)) {
      alert("Token tidak valid. Hubungi operator.");
      return;
    }

    const expiryDate = tokenData.expiry.toDate();
    const now = new Date();

    if (expiryDate.getTime() < now.getTime()) {
      alert("Token sudah kadaluarsa. Silakan minta token baru.");
      return;
    }

    // Simpan token ke localStorage sebagai tanda login
    localStorage.setItem("adminToken", inputToken);

    alert("Login berhasil! Mengalihkan ke halaman administrator...");
    window.location.href = "administrator.html";
  } catch (err) {
    console.error("Error saat cek token:", err);
    alert("Terjadi kesalahan saat memeriksa token.");
  } finally {
    // Enable tombol kembali dan reset teks
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit";
  }
};
