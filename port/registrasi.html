<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>Form Pendaftaran Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center px-4 py-10">
  <main class="bg-white w-full max-w-md rounded-lg shadow-md p-8">

    <form id="registerForm" class="space-y-6" novalidate>
      <!-- Step 1 -->
      <section data-step="1" class="step-section">
        <div>
          <label for="fullname" class="block text-gray-700 font-semibold mb-1">Nama Lengkap</label>
          <input
            type="text"
            id="fullname"
            placeholder="Pastikan gunakan nama asli"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="name"
          />
        </div>
        <div>
          <label for="email" class="block text-gray-700 font-semibold mb-1">Email</label>
          <input
            type="email"
            id="email"
            placeholder="Masukkan email aktif anda"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="email"
          />
        </div>
        <div>
          <label for="password" class="block text-gray-700 font-semibold mb-1">Kata Sandi</label>
          <input
            type="password"
            id="password"
            placeholder="Kata sandi"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="new-password"
          />
          <p class="mt-1 text-sm text-red-600 font-semibold">
            <i class="fas fa-exclamation-circle mr-1"></i> Jangan gunakan kata sandi yang sama dengan akun email dan sosmed
          </p>
        </div>
        <div>
          <label for="whatsapp" class="block text-gray-700 font-semibold mb-1">WhatsApp</label>
          <input
            type="text"
            id="whatsapp"
            placeholder="Contoh: 08xx - xxxx - xxxx"
            required
            pattern="^0\d{8,15}$"
            title="Masukkan nomor WhatsApp dengan format 08xx - xxxx - xxxx"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="tel"
          />
        </div>
      </section>

      <!-- Step 2 -->
      <section data-step="2" class="step-section hidden">
        <div>
          <label for="desa" class="block text-gray-700 font-semibold mb-1">Desa/Perumahan</label>
          <input
            type="text"
            id="desa"
            placeholder="Desa atau Perumahan"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="address-level3"
          />
        </div>
        <div>
          <label for="kecamatan" class="block text-gray-700 font-semibold mb-1">Kecamatan</label>
          <input
            type="text"
            id="kecamatan"
            placeholder="Kecamatan"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="address-level2"
          />
        </div>
        <div>
          <label for="kabupaten" class="block text-gray-700 font-semibold mb-1">Kabupaten</label>
          <input
            type="text"
            id="kabupaten"
            placeholder="Kabupaten"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="address-level1"
          />
        </div>
        <div>
          <label for="provinsi" class="block text-gray-700 font-semibold mb-1">Provinsi</label>
          <input
            type="text"
            id="provinsi"
            placeholder="Provinsi"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="region"
          />
        </div>
      </section>

      <!-- Step 3 -->
      <section data-step="3" class="step-section hidden">
        <div>
          <label for="referralInput" class="block text-gray-700 font-semibold mb-1">Kode Referral</label>
          <input
            type="text"
            id="referralInput"
            placeholder="Opsional"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            autocomplete="off"
          />
          <p class="mt-1 text-sm text-green-600 font-semibold flex items-center">
            <i class="fas fa-info-circle mr-1"></i> Jika anda memasukkan kode referral milik kerabat anda akan mendapatkan 100 point
          </p>
        </div>
        <div class="flex items-center mt-6">
          <input
            type="checkbox"
            id="termsCheck"
            required
            class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500"
          />
          <label for="termsCheck" class="ml-3 text-gray-700 font-semibold select-none cursor-pointer">
            Anda siap mematuhi persyaratan layanan ini
          </label>
        </div>
      </section>

      <!-- Navigation Buttons -->
      <div class="flex justify-between mt-8">
        <button
          type="button"
          id="prevBtn"
          class="bg-gray-300 text-gray-700 font-semibold py-2 px-5 rounded-md hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Sebelumnya
        </button>
        <button
          type="button"
          id="nextBtn"
          class="bg-green-600 text-white font-semibold py-2 px-5 rounded-md hover:bg-green-700 transition"
        >
          Selanjutnya
        </button>
        <button
          type="submit"
          id="submitBtn"
          class="bg-green-600 text-white font-semibold py-2 px-5 rounded-md hover:bg-green-700 transition hidden"
        >
          Daftar Sekarang
        </button>
      </div>
    </form>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDocs,
      updateDoc,
      collection,
      query,
      where,
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

     const firebaseConfig = {
    apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
    authDomain: "gmi-enterprise23.firebaseapp.com",
    projectId: "gmi-enterprise23",
    storageBucket: "gmi-enterprise23.firebasestorage.app",
    messagingSenderId: "974090028804",
    appId: "1:974090028804:web:43ae563ffd9433463c7251",
    measurementId: "G-S27YB5Z8PR"
  };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function generateReferralCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    const form = document.getElementById("registerForm");
    const steps = Array.from(document.querySelectorAll(".step-section"));
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    let currentStep = 0;

    function showStep(step) {
      steps.forEach((section, i) => {
        section.classList.toggle("hidden", i !== step);
      });
      prevBtn.disabled = step === 0;
      nextBtn.classList.toggle("hidden", step === steps.length - 1);
      submitBtn.classList.toggle("hidden", step !== steps.length - 1);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function validateStep(step) {
      const inputs = Array.from(steps[step].querySelectorAll("input[required]"));
      for (const input of inputs) {
        if (input.type === "checkbox") {
          if (!input.checked) return false;
        } else if (!input.value.trim()) {
          return false;
        }
        if (input.id === "whatsapp") {
          // Validate WhatsApp format: 08xx - xxxx - xxxx or 08xxxxxxxxxx (digits only)
          const val = input.value.trim();
          // Accept digits, spaces, dashes
          const cleaned = val.replace(/[\s-]/g, "");
          if (!/^08\d{8,13}$/.test(cleaned)) return false;
        }
      }
      return true;
    }

    nextBtn.addEventListener("click", () => {
      if (!validateStep(currentStep)) {
        alert("Mohon lengkapi semua field yang wajib diisi dengan benar sebelum melanjutkan.");
        return;
      }
      currentStep++;
      showStep(currentStep);
    });

    prevBtn.addEventListener("click", () => {
      currentStep--;
      showStep(currentStep);
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!validateStep(currentStep)) {
        alert("Mohon lengkapi semua field yang wajib diisi dengan benar.");
        return;
      }

      // Ambil semua nilai input
      const fullName = document.getElementById("fullName").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const whatsappRaw = document.getElementById("whatsapp").value.trim();
      // Normalize WhatsApp number: remove spaces and dashes, convert leading 0 to +62
      let whatsapp = whatsappRaw.replace(/[\s-]/g, "");
      if (whatsapp.startsWith("0")) {
        whatsapp = "+62" + whatsapp.slice(1);
      }
      const desa = document.getElementById("desa").value.trim();
      const kecamatan = document.getElementById("kecamatan").value.trim();
      const kabupaten = document.getElementById("kabupaten").value.trim();
      const provinsi = document.getElementById("provinsi").value.trim();
      const referralInput = document.getElementById("referralInput").value.trim().toUpperCase();
      const termsCheck = document.getElementById("termsCheck").checked;
      const ownReferral = generateReferralCode();

      if (!termsCheck) {
        alert("Anda harus menyetujui persyaratan layanan untuk melanjutkan.");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;

        let referredBy = "";
        let points = 0;

        if (referralInput !== "") {
          const q = query(collection(db, "users"), where("referral", "==", referralInput));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            referredBy = referralInput;
            points += 100;

            for (const docSnap of querySnapshot.docs) {
              const refUserRef = doc(db, "users", docSnap.id);
              const refData = docSnap.data();
              const currentPoints = refData.points || 0;

              await updateDoc(refUserRef, {
                points: currentPoints + 200,
              });
            }
          } else {
            alert("Kode referral tidak ditemukan. Pendaftaran tetap diproses.");
          }
        }

        await setDoc(doc(db, "users", uid), {
          fullName,
          email,
          whatsapp,
          desa,
          kecamatan,
          kabupaten,
          provinsi,
          referral: ownReferral,
          referredBy,
          points,
        });

        alert("Pendaftaran berhasil! Selamat datang.");
        window.location.href = "index.html";
      } catch (error) {
        console.error("Error:", error);
        alert("Terjadi kesalahan: " + error.message);
      }
    });

    showStep(currentStep);
  </script>
</body>
</html>
