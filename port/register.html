<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registrasi - GMI Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrhBBX1CIt5JzCh25tPUwqHJjIVIeyef8",
      authDomain: "gmi-official21-74326.firebaseapp.com",
      projectId: "gmi-official21-74326",
      storageBucket: "gmi-official21-74326.appspot.com",
      messagingSenderId: "496607636364",
      appId: "1:496607636364:web:5c0428ccad6952faa544a9",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function generateReferralCode(name = "") {
      const token = Math.random().toString(36).substring(2, 6).toUpperCase();
      return (name.replace(/\s+/g, "").substring(0, 4) + "-" + token).toUpperCase();
    }

    window.registerUser = async function(event) {
      event.preventDefault();

      const username = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const alamat = document.getElementById("alamat").value.trim();
      const referralInput = document.getElementById("referral").value.trim();

      if (!username || !email || !password || !alamat) {
        alert("Harap lengkapi semua data.");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const uid = user.uid;

        const referralCode = generateReferralCode(username);

        let point = 0;
        const referredBy = referralInput || null;

        if (referredBy) {
          const usersRef = collection(db, "users");
          const q = query(usersRef, where("referralCode", "==", referredBy));
          const snap = await getDocs(q);

          if (!snap.empty) {
            const referrerDoc = snap.docs[0];
            const referrerRef = referrerDoc.ref;

            const referrerData = referrerDoc.data();
            await updateDoc(referrerRef, {
              point: (referrerData.point || 0) + 500
            });

            const referralDbRef = doc(db, "referrals", referrerDoc.id);
            const referralSnap = await getDoc(referralDbRef);
            if (referralSnap.exists()) {
              const rdata = referralSnap.data();
              await updateDoc(referralDbRef, {
                point: (rdata.point || 0) + 500
              });
            }

            point = 100;
          }
        }

        await setDoc(doc(db, "users", uid), {
          uid,
          username,
          email,
          alamat,
          point,
          referralCode,
          referredBy,
          createdAt: new Date()
        });

        await setDoc(doc(db, "referrals", uid), {
          uid,
          username,
          referralCode,
          point
        });

        alert("Registrasi berhasil!");
        window.location.href = "forum.html";
      } catch (error) {
        console.error("Gagal registrasi:", error.message);
        alert("Registrasi gagal: " + error.message);
      }
    };

    window.addEventListener('DOMContentLoaded', () => {
      const steps = Array.from(document.querySelectorAll('.step'));
      const btnNext = document.getElementById('btn-next');
      const btnPrev = document.getElementById('btn-prev');
      const btnSubmit = document.getElementById('btn-submit');
      let currentStep = 0;

      function showStep(index) {
        steps.forEach((step, i) => {
          step.classList.toggle('hidden', i !== index);
        });
        btnPrev.disabled = index === 0;
        btnNext.classList.toggle('hidden', index === steps.length - 1);
        btnSubmit.classList.toggle('hidden', index !== steps.length - 1);
      }

      btnNext.addEventListener('click', () => {
        if (validateStep(currentStep)) {
          currentStep++;
          showStep(currentStep);
          window.scrollTo({top:0, behavior:'smooth'});
        }
      });

      btnPrev.addEventListener('click', () => {
        currentStep--;
        showStep(currentStep);
        window.scrollTo({top:0, behavior:'smooth'});
      });

      function validateStep(step) {
        let valid = true;
        if (step === 0) {
          const username = document.getElementById('username');
          if (!username.value.trim()) {
            alert('Nama Pengguna wajib diisi.');
            valid = false;
          }
        } else if (step === 1) {
          const email = document.getElementById('email');
          const password = document.getElementById('password');
          if (!email.value.trim()) {
            alert('Email wajib diisi.');
            valid = false;
          } else if (!password.value.trim()) {
            alert('Kata Sandi wajib diisi.');
            valid = false;
          }
        } else if (step === 2) {
          const alamat = document.getElementById('alamat');
          if (!alamat.value.trim()) {
            alert('Alamat wajib diisi.');
            valid = false;
          }
        }
        return valid;
      }

      showStep(currentStep);
    });
  </script>
</head>
<body class="bg-white min-h-screen flex items-center justify-center px-4 py-10" style="color:#16a34a;">
  <form onsubmit="registerUser(event)" class="rounded-xl shadow-lg p-8 w-full max-w-md" style="color:#16a34a;">
    <h2 class="text-2xl font-semibold mb-6 text-center" style="color:#16a34a;">Registrasi GMI Forum</h2>

    <div class="step" id="step-1">
      <label for="username" class="block text-sm font-medium mb-1" style="color:#16a34a;">Nama Pengguna</label>
      <input type="text" id="username" placeholder="Nama Pengguna" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" style="color:#16a34a;" />
    </div>

    <div class="step hidden" id="step-2">
      <label for="email" class="block text-sm font-medium mb-1" style="color:#16a34a;">Email</label>
      <input type="email" id="email" placeholder="Email" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 mb-4" style="color:#16a34a;" />
      <label for="password" class="block text-sm font-medium mb-1" style="color:#16a34a;">Kata Sandi</label>
      <input type="password" id="password" placeholder="Kata Sandi" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" style="color:#16a34a;" />
    </div>

    <div class="step hidden" id="step-3">
      <label for="alamat" class="block text-sm font-medium mb-1" style="color:#16a34a;">Alamat</label>
      <input type="text" id="alamat" placeholder="Alamat" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" style="color:#16a34a;" />
    </div>

    <div class="step hidden" id="step-4">
      <label for="referral" class="block text-sm font-medium mb-1" style="color:#16a34a;">Kode Referral (opsional)</label>
      <input type="text" id="referral" placeholder="Kode Referral (opsional)" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" style="color:#16a34a;" />
    </div>

    <div class="flex justify-between mt-8">
      <button type="button" id="btn-prev" class="bg-gray-300 font-semibold py-2 px-6 rounded-md disabled:opacity-50 flex items-center text-[#16a34a]" disabled>
        <i class="fas fa-arrow-left mr-2"></i> Sebelumnya
      </button>
      <button type="button" id="btn-next" class="font-semibold py-1 px-4 rounded-md text-sm flex items-center text-white" style="background-color:#16a34a;">
        Selanjutnya <i class="fas fa-arrow-right ml-2 text-xs"></i>
      </button>
      <button type="submit" id="btn-submit" class="bg-green-600 hover:bg-green-700 font-semibold py-2 px-6 rounded-md hidden text-white">
        Daftar <i class="fas fa-check ml-2"></i>
      </button>
    </div>
  </form>
</body>
</html>
