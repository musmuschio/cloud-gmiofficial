<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Update Status</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>Update Status</h2>
  <form id="statusForm">
    <input type="text" id="nama" placeholder="Nama Anda" required><br><br>
    <textarea id="status" placeholder="Tulis status Anda..." required></textarea><br><br>
    <input type="file" id="gambar"><br><br>
    <button type="submit">Kirim</button>
  </form>

  <script>
    const supabase = supabase.createClient(
      'https://uvmwcpbaxrrwxkadjpzj.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2bXdjcGJheHJyd3hrYWRqcHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNDM3MTIsImV4cCI6MjA2MTkxOTcxMn0.xE9TkZxDxEbvL2rsHBq5XETlwLTUVv18OvYcMNiZlK4'
    );

    document.getElementById('statusForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const nama = document.getElementById('nama').value.trim();
      const status = document.getElementById('status').value.trim();
      const file = document.getElementById('gambar').files[0];

      if (!nama || !status) {
        alert("Nama dan status wajib diisi.");
        return;
      }

      let gambarUrl = null;

      if (file) {
        const { data, error: uploadError } = await supabase.storage
          .from('public')
          .upload(`gambar/${Date.now()}_${file.name}`, file);

        if (uploadError) {
          alert('Gagal upload gambar!');
          return;
        }

        const { data: publicUrl } = supabase.storage
          .from('public')
          .getPublicUrl(data.path);
          
        gambarUrl = publicUrl.publicUrl;
      }

      const { error } = await supabase
        .from('forum')
        .insert([{ nama, status, gambar: gambarUrl }]);

      if (error) {
        console.error("Insert error:", error);
        alert("Gagal mengirim status.");
      } else {
        alert("Berhasil kirim status!");
        window.location.href = "forum.html";
      }
    });
  </script>
</body>
</html>
