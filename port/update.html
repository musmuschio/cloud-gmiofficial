<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Posting Status</title>
</head>
<body>

<h2>Posting Status</h2>
<textarea id="description" placeholder="Tulis deskripsi..."></textarea>
<br>
<input type="file" id="imageInput">
<br>
<button onclick="postStatus()">Posting</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBrhBBX1CIt5JzCh25tPUwqHJjIVIeyef8",
    authDomain: "gmi-official21-74326.firebaseapp.com",
    projectId: "gmi-official21-74326",
    storageBucket: "gmi-official21-74326.firebasestorage.app",
    messagingSenderId: "496607636364",
    appId: "1:496607636364:web:5c0428ccad6952faa544a9",
    measurementId: "G-KJ0X8CY03M"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
    } else {
      alert("Harap login terlebih dahulu!");
      window.location.href = "forum.html";
    }
  });

  async function postStatus() {
    const deskripsi = document.getElementById("description").value.trim();
    const file = document.getElementById("imageInput").files[0];

    if (!deskripsi) {
      alert("Deskripsi tidak boleh kosong.");
      return;
    }

    let imageUrl = null;

    if (file) {
      const base64 = await fileToBase64(file);
      const ext = file.name.split('.').pop();
      const token = Math.random().toString(36).substring(2, 8);
      const tanggal = new Date().toISOString().replace(/[:.]/g, '-');
      const namaUser = currentUser.email.split('@')[0];
      const namaFile = `${namaUser}-${tanggal}-${token}.${ext}`;

      const response = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID 1c6ad60250b3421"
        },
        body: new URLSearchParams({
          image: base64,
          type: "base64",
          name: namaFile,
          title: namaFile
        })
      });

      const result = await response.json();
      if (result.success) {
        imageUrl = result.data.link;
      } else {
        alert("Gagal mengupload gambar ke Imgur");
        return;
      }
    }

    await addDoc(collection(db, "statuses"), {
      name: currentUser.email,
      description: deskripsi,
      imageUrl: imageUrl,
      createdAt: serverTimestamp()
    });

    alert("Status berhasil diposting!");
    document.getElementById("description").value = "";
    document.getElementById("imageInput").value = "";
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(",")[1]);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }
</script>

</body>
</html>
