<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Token Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

  <div class="bg-white p-6 rounded shadow max-w-md w-full text-center">
    <h2 class="text-2xl font-bold mb-4">Token Admin (8 frasa, berlaku 3 jam)</h2>

    <button onclick="generateToken()" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 w-full">
      üîê Buat Token Baru
    </button>

    <div id="tokenWrapper" class="mt-4 hidden">
      <p class="text-sm text-gray-600 mb-1">Token Anda:</p>
      <div id="tokenResult" class="bg-gray-100 p-3 rounded text-sm font-mono break-all"></div>
      <button onclick="copyToken()" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
        üìã Salin Token
      </button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "API_KEY_ANDA",
      authDomain: "PROJECT_ID.firebaseapp.com",
      projectId: "PROJECT_ID",
      storageBucket: "PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Random karakter generator
    function getRandomChunk(length) {
      const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+[]{}";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function generateComplexToken() {
      let parts = [];
      for (let i = 0; i < 8; i++) {
        parts.push(getRandomChunk(4 + Math.floor(Math.random() * 3)));
      }
      return parts.join("--");
    }

    // Salin token ke clipboard
    function copyToken() {
      const tokenText = document.getElementById("tokenResult").innerText;
      navigator.clipboard.writeText(tokenText).then(() => {
        Swal.fire("Disalin!", "Token telah disalin ke clipboard.", "success");
      });
    }

    // Hapus token lebih dari 3 jam
    async function deleteExpiredTokens() {
      const now = new Date();
      const threshold = new Date(now.getTime() - (3 * 60 * 60 * 1000)); // 3 jam lalu

      const snapshot = await db.collection("adminTokens").get();
      snapshot.forEach(doc => {
        const createdAt = doc.data().createdAt?.toDate?.();
        if (createdAt && createdAt < threshold) {
          db.collection("adminTokens").doc(doc.id).delete();
        }
      });
    }

    // Generate dan simpan token
    async function generateToken() {
      await deleteExpiredTokens();

      const token = generateComplexToken();
      const timestamp = firebase.firestore.FieldValue.serverTimestamp();

      try {
        await db.collection("adminTokens").doc(token).set({ createdAt: timestamp });

        document.getElementById("tokenWrapper").classList.remove("hidden");
        document.getElementById("tokenResult").innerText = token;

        Swal.fire("Sukses!", "Token berhasil dibuat dan akan berlaku selama 3 jam.", "success");
      } catch (err) {
        console.error(err);
        Swal.fire("Gagal!", "Tidak bisa menyimpan token ke database.", "error");
      }
    }
  </script>
</body>
</html>
