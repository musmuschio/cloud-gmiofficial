<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate Token Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
    <h2 class="text-3xl font-extrabold mb-6 text-gray-800">Token Admin (8 frasa, berlaku 3 jam)</h2>

    <button onclick="generateToken()" class="flex items-center justify-center gap-2 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition w-full text-lg font-semibold">
      <i class="fas fa-lock"></i> Buat Token Baru
    </button>

    <div id="tokenWrapper" class="mt-6 hidden">
      <p class="text-sm text-gray-600 mb-2">Token Anda:</p>
      <div id="tokenResult" class="bg-gray-100 p-4 rounded font-mono text-sm break-words select-all text-gray-900"></div>
      <button onclick="copyToken()" class="mt-4 flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition mx-auto text-sm font-medium">
        <i class="fas fa-clipboard"></i> Salin Token
      </button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "API_KEY_ANDA",
      authDomain: "PROJECT_ID.firebaseapp.com",
      projectId: "PROJECT_ID",
      storageBucket: "PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Random karakter generator
    function getRandomChunk(length) {
      const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+[]{}";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function generateComplexToken() {
      let parts = [];
      for (let i = 0; i < 8; i++) {
        parts.push(getRandomChunk(4 + Math.floor(Math.random() * 3)));
      }
      return parts.join("--");
    }

    // Salin token ke clipboard
    function copyToken() {
      const tokenText = document.getElementById("tokenResult").innerText;
      navigator.clipboard.writeText(tokenText).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Disalin!',
          text: 'Token telah disalin ke clipboard.',
          timer: 1500,
          showConfirmButton: false
        });
      });
    }

    // Hapus token lebih dari 3 jam
    async function deleteExpiredTokens() {
      const now = new Date();
      const threshold = new Date(now.getTime() - (3 * 60 * 60 * 1000)); // 3 jam lalu

      const snapshot = await db.collection("adminTokens").get();
      snapshot.forEach(doc => {
        const createdAt = doc.data().createdAt?.toDate?.();
        if (createdAt && createdAt < threshold) {
          db.collection("adminTokens").doc(doc.id).delete();
        }
      });
    }

    // Generate dan simpan token
    async function generateToken() {
      await deleteExpiredTokens();

      const token = generateComplexToken();
      const timestamp = firebase.firestore.FieldValue.serverTimestamp();

      try {
        await db.collection("adminTokens").doc(token).set({ createdAt: timestamp });

        document.getElementById("tokenWrapper").classList.remove("hidden");
        document.getElementById("tokenResult").innerText = token;

        Swal.fire({
          icon: 'success',
          title: 'Sukses!',
          text: 'Token berhasil dibuat dan akan berlaku selama 3 jam.',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Gagal!',
          text: 'Tidak bisa menyimpan token ke database.'
        });
      }
    }
  </script>
</body>
</html>
