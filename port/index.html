<html class="scroll-smooth" lang="id">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   GMI Official App
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
  <style>
   body {
      font-family: 'Inter', sans-serif;
    }
  </style>
 </head>
 <body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="flex justify-between items-center bg-white shadow px-4 py-3 sticky top-0 z-50">
   <div class="flex items-center space-x-2">
    <img alt="Logo GMI Official, a stylized letter G and M in blue and green" class="w-10 h-10 object-contain" height="40" src="https://storage.googleapis.com/a1aa/image/9816c4e0-4724-4b7a-8562-afa70e525edd.jpg" width="40"/>
    <span class="font-semibold text-xl text-gray-800 select-none">
     gmi official
    </span>
   </div>
   <div class="relative">
    <button aria-label="Open menu options" class="text-2xl text-gray-700 hover:text-gray-900 focus:outline-none" id="menuToggleBtn">
     <i class="fas fa-ellipsis-v">
     </i>
    </button>
    <div class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50" id="menuOptions">
     <nav class="flex flex-col divide-y divide-gray-200">
      <a class="px-4 py-3 hover:bg-gray-100 text-gray-800 font-medium" data-spa-link="settings" href="#settings">
       Settings
      </a>
      <a class="px-4 py-3 hover:bg-gray-100 text-gray-800 font-medium" data-spa-link="contact" href="#contact">
       Contact
      </a>
      <a class="px-4 py-3 hover:bg-gray-100 text-gray-800 font-medium" data-spa-link="aboutapp" href="#aboutapp">
       About Apps (@aboutapp)
      </a>
      <a class="px-4 py-3 hover:bg-gray-100 text-gray-800 font-medium" data-spa-link="rateus" href="#rateus">
       Rate Us
      </a>
      <a class="px-4 py-3 hover:bg-gray-100 text-gray-800 font-medium" data-spa-link="newsupdates" href="#newsupdates">
       News or Updates
      </a>
     </nav>
    </div>
   </div>
  </header>
  <!-- Main SPA container -->
  <main class="flex-grow overflow-auto relative" id="app">
   <!-- Content will be injected here by SPA navigation -->
  </main>
  <!-- Footer Navigation -->
  <footer class="bg-white border-t border-gray-300 fixed bottom-0 left-0 right-0 flex justify-around items-center h-16 z-40">
   <button aria-label="Beranda" class="flex flex-col items-center justify-center text-gray-700 hover:text-blue-600 focus:outline-none" id="btnHome">
    <i class="fas fa-home text-xl">
    </i>
    <span class="text-xs mt-0.5">
     Beranda
    </span>
   </button>
   <button aria-label="Forum" class="flex flex-col items-center justify-center text-gray-700 hover:text-blue-600 focus:outline-none" id="btnForum">
    <i class="fas fa-comments text-xl">
    </i>
    <span class="text-xs mt-0.5">
     Forum
    </span>
   </button>
   <button aria-label="Informasi" class="flex flex-col items-center justify-center text-gray-700 hover:text-blue-600 focus:outline-none" id="btnInfo">
    <i class="fas fa-info-circle text-xl">
    </i>
    <span class="text-xs mt-0.5">
     Informasi
    </span>
   </button>
   <button aria-label="Tentang" class="flex flex-col items-center justify-center text-gray-700 hover:text-blue-600 focus:outline-none" id="btnAbout">
    <i class="fas fa-users text-xl">
    </i>
    <span class="text-xs mt-0.5">
     Tentang
    </span>
   </button>
   <button aria-label="Profil" class="flex flex-col items-center justify-center text-gray-700 hover:text-blue-600 focus:outline-none" id="btnProfile">
    <i class="fas fa-user-circle text-xl">
    </i>
    <span class="text-xs mt-0.5">
     Profil
    </span>
   </button>
  </footer>
  <!-- Modal for Comments -->
  <div aria-labelledby="commentModalTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="commentModal" role="dialog">
   <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto p-4 flex flex-col">
    <header class="flex justify-between items-center mb-3">
     <h2 class="text-lg font-semibold text-gray-800" id="commentModalTitle">
      Komentar
     </h2>
     <button aria-label="Close comments modal" class="text-gray-600 hover:text-gray-900 focus:outline-none text-2xl" id="closeCommentModal">
      ×
     </button>
    </header>
    <div class="flex-grow overflow-y-auto space-y-3 mb-3" id="commentList">
     <!-- Comments will be dynamically inserted here -->
    </div>
    <form class="flex space-x-2" id="commentForm">
     <input class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="commentInput" placeholder="Tulis komentar..." required="" type="text"/>
     <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none" type="submit">
      Kirim
     </button>
    </form>
   </div>
  </div>
  <!-- Modal for Report -->
  <div aria-labelledby="reportModalTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="reportModal" role="dialog">
   <div class="bg-white rounded-lg max-w-md w-full p-6 flex flex-col space-y-4">
    <header class="flex justify-between items-center">
     <h2 class="text-lg font-semibold text-gray-800" id="reportModalTitle">
      Laporkan Postingan
     </h2>
     <button aria-label="Close report modal" class="text-gray-600 hover:text-gray-900 focus:outline-none text-2xl" id="closeReportModal">
      ×
     </button>
    </header>
    <form class="flex flex-col space-y-4" id="reportForm">
     <label class="font-medium text-gray-700" for="reportReason">
      Pilih alasan laporan:
     </label>
     <select class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="reportReason" required="">
      <option disabled="" selected="" value="">
       -- Pilih alasan --
      </option>
      <option value="spam">
       Spam
      </option>
      <option value="verbal_violence">
       Kekerasan Verbal
      </option>
      <option value="hate_speech">
       Ujaran Kebencian
      </option>
      <option value="other">
       Lainnya
      </option>
     </select>
     <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 focus:outline-none" type="submit">
      Kirim Laporan
     </button>
    </form>
   </div>
  </div>
  <!-- Modal for Update Post -->
  <div aria-labelledby="updateModalTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="updateModal" role="dialog">
   <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto p-6 flex flex-col">
    <header class="flex justify-between items-center mb-4">
     <h2 class="text-lg font-semibold text-gray-800" id="updateModalTitle">
      Buat Postingan Baru
     </h2>
     <button aria-label="Close update modal" class="text-gray-600 hover:text-gray-900 focus:outline-none text-2xl" id="closeUpdateModal">
      ×
     </button>
    </header>
    <form class="flex flex-col space-y-4" id="updateForm">
     <textarea class="border border-gray-300 rounded px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" id="postText" placeholder="Tulis sesuatu..." required="" rows="4"></textarea>
     <label class="block text-gray-700 font-medium cursor-pointer" for="postImage">
      Upload Gambar (opsional):
     </label>
     <input accept="image/*" class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="postImage" type="file"/>
     <div class="flex justify-end space-x-2">
      <button class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100 focus:outline-none" id="cancelPostBtn" type="button">
       Batal
      </button>
      <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none" type="submit">
       Posting
      </button>
     </div>
    </form>
   </div>
  </div>
  <!-- Login Page Template -->
  <template id="loginPageTemplate">
   <div class="min-h-screen flex flex-col justify-center items-center bg-gradient-to-b from-blue-100 to-blue-50 px-4">
    <div aria-label="Halaman Login" class="bg-white rounded-lg shadow-lg max-w-md w-full p-8 space-y-6" role="main">
     <h1 class="text-2xl font-semibold text-center text-gray-800 mb-4">
      Masuk ke GMI Official
     </h1>
     <form class="space-y-4" id="loginForm" novalidate="">
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="loginUsername">
        Username
       </label>
       <input autocomplete="username" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="loginUsername" name="username" required="" type="text"/>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="loginPassword">
        Password
       </label>
       <input autocomplete="current-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="loginPassword" name="password" required="" type="password"/>
      </div>
      <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 focus:outline-none" type="submit">
       Masuk
      </button>
     </form>
     <div class="flex justify-center">
      <button class="flex items-center justify-center space-x-2 border border-gray-300 rounded w-full py-2 hover:bg-gray-100 focus:outline-none" id="googleLoginBtn">
       <img alt="Google logo, multicolor G letter" class="w-5 h-5" height="20" src="https://storage.googleapis.com/a1aa/image/f95263ab-ccfc-45f5-803d-570cd7db9a04.jpg" width="20"/>
       <span class="text-gray-700 font-medium">
        Masuk dengan Google
       </span>
      </button>
     </div>
     <p class="text-center text-gray-600 mt-4">
      Belum punya akun?
      <button class="text-blue-600 font-semibold hover:underline focus:outline-none" id="goToRegisterBtn">
       Klik di sini!
      </button>
     </p>
    </div>
   </div>
  </template>
  <!-- Register Page Template -->
  <template id="registerPageTemplate">
   <div class="min-h-screen flex flex-col justify-center items-center bg-gradient-to-b from-green-100 to-green-50 px-4">
    <div aria-label="Halaman Registrasi" class="bg-white rounded-lg shadow-lg max-w-md w-full p-8 space-y-6" role="main">
     <h1 class="text-2xl font-semibold text-center text-gray-800 mb-4">
      Daftar Akun Baru
     </h1>
     <form class="space-y-4" id="registerForm" novalidate="">
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="registerFullName">
        Nama Lengkap
       </label>
       <input autocomplete="name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="registerFullName" name="fullname" required="" type="text"/>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="registerAddress">
        Alamat
       </label>
       <textarea class="w-full border border-gray-300 rounded px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-green-500" id="registerAddress" name="address" required="" rows="2"></textarea>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="registerPassword">
        Password
       </label>
       <input autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="registerPassword" name="password" required="" type="password"/>
       <p class="text-xs text-red-600 mt-1">
        Tidak disarankan menggunakan sandi yang sama seperti sandi email
              atau sosial media.
       </p>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="registerPasswordVerify">
        Verifikasi Password
       </label>
       <input autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="registerPasswordVerify" name="passwordVerify" required="" type="password"/>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="registerWhatsapp">
        Nomor WhatsApp
       </label>
       <input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="registerWhatsapp" name="whatsapp" pattern="^\+?62[0-9]{8,15}$" placeholder="+6281234567890" required="" type="tel"/>
      </div>
      <button class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 focus:outline-none" type="submit">
       Daftar
      </button>
     </form>
     <p class="text-center text-gray-600 mt-4">
      Sudah punya akun?
      <button class="text-green-600 font-semibold hover:underline focus:outline-none" id="goToLoginBtn">
       Klik di sini!
      </button>
     </p>
    </div>
   </div>
  </template>
  <!-- SPA Pages Templates -->
  <!-- Settings Page -->
  <template id="settingsPageTemplate">
   <section class="p-6 max-w-4xl mx-auto">
    <h1 class="text-2xl font-semibold mb-4 text-gray-800">
     Settings
    </h1>
    <p class="text-gray-700">
     Pengaturan aplikasi akan tersedia di sini.
    </p>
   </section>
  </template>
  <!-- Contact Page -->
  <template id="contactPageTemplate">
   <section class="p-6 max-w-4xl mx-auto">
    <h1 class="text-2xl font-semibold mb-4 text-gray-800">
     Contact
    </h1>
    <p class="text-gray-700">
     Hubungi kami melalui email:
     <a class="text-blue-600 underline" href="mailto:contact@gmi-official.id">
      contact@gmi-official.id
     </a>
    </p>
    <p class="text-gray-700 mt-2">
     Atau WhatsApp:
     <a class="text-blue-600 underline" href="https://wa.me/628119118047" rel="noopener" target="_blank">
      +62 811-9118-047
     </a>
    </p>
   </section>
  </template>
  <!-- About Apps Page (@aboutapp) -->
  <template id="aboutAppPageTemplate">
   <section class="p-6 max-w-4xl mx-auto space-y-6">
    <h1 class="text-2xl font-semibold text-gray-800">
     About Apps (@aboutapp)
    </h1>
    <article>
     <h2 class="text-xl font-semibold text-gray-700 mb-1">
      Privacy Policy (Kebijakan Privasi)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Menjelaskan bagaimana data pengguna dikumpulkan, digunakan, dan dilindungi. Kami berkomitmen untuk menjaga privasi Anda dan hanya menggunakan data untuk keperluan layanan.
     </p>
    </article>
    <article>
     <h2 class="text-xl font-semibold text-gray-700 mb-1">
      Terms of Service / Terms and Conditions (Syarat dan Ketentuan)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Menetapkan aturan dan batasan penggunaan layanan. Dengan menggunakan aplikasi ini, Anda setuju untuk mematuhi syarat dan ketentuan yang berlaku.
     </p>
    </article>
    <article>
     <h2 class="text-xl font-semibold text-gray-700 mb-1">
      Cookie Policy
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Informasi tentang penggunaan cookie, pelacakan, dan opsi persetujuan pengguna. Kami menggunakan cookie untuk meningkatkan pengalaman pengguna.
     </p>
    </article>
    <article>
     <h2 class="text-xl font-semibold text-gray-700 mb-1">
      Disclaimer (Penafian)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Menjelaskan batas tanggung jawab, terutama untuk layanan informasi atau konsultasi. Informasi yang disediakan tidak menggantikan nasihat profesional.
     </p>
    </article>
    <article>
     <h2 class="text-xl font-semibold text-gray-700 mb-1">
      End-User License Agreement (EULA)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Perjanjian lisensi antara pengembang dan pengguna akhir aplikasi. Penggunaan aplikasi ini tunduk pada perjanjian lisensi yang berlaku.
     </p>
    </article>
   </section>
  </template>
  <!-- Rate Us Page -->
  <template id="rateUsPageTemplate">
   <section class="p-6 max-w-4xl mx-auto">
    <h1 class="text-2xl font-semibold mb-4 text-gray-800">
     Rate Us
    </h1>
    <p class="text-gray-700 mb-4">
     Berikan penilaian dan ulasan Anda untuk membantu kami meningkatkan aplikasi.
    </p>
    <div class="flex space-x-2 text-yellow-400 text-4xl cursor-pointer select-none" id="starRating">
     <i class="far fa-star" data-star="1">
     </i>
     <i class="far fa-star" data-star="2">
     </i>
     <i class="far fa-star" data-star="3">
     </i>
     <i class="far fa-star" data-star="4">
     </i>
     <i class="far fa-star" data-star="5">
     </i>
    </div>
    <textarea class="w-full mt-4 border border-gray-300 rounded px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-yellow-400" id="rateReview" placeholder="Tulis ulasan Anda di sini..." rows="4"></textarea>
    <button class="mt-4 bg-yellow-400 text-gray-900 font-semibold px-6 py-2 rounded hover:bg-yellow-500 focus:outline-none" id="submitRatingBtn">
     Kirim
    </button>
   </section>
  </template>
  <!-- News or Updates Page -->
  <template id="newsUpdatesPageTemplate">
   <section class="p-6 max-w-4xl mx-auto space-y-6">
    <h1 class="text-2xl font-semibold text-gray-800 mb-4">
     News or Updates
    </h1>
    <article class="bg-white rounded shadow p-4">
     <h2 class="text-lg font-semibold text-blue-600 mb-2">
      Update 1: Peluncuran Fitur Baru
     </h2>
     <p class="text-gray-700">
      Kami baru saja meluncurkan fitur forum untuk berinteraksi antar pengguna secara real-time.
     </p>
    </article>
    <article class="bg-white rounded shadow p-4">
     <h2 class="text-lg font-semibold text-blue-600 mb-2">
      Update 2: Perbaikan Bug
     </h2>
     <p class="text-gray-700">
      Memperbaiki beberapa bug kecil untuk meningkatkan performa aplikasi.
     </p>
    </article>
    <article class="bg-white rounded shadow p-4">
     <h2 class="text-lg font-semibold text-blue-600 mb-2">
      Update 3: Kebijakan Privasi Diperbarui
     </h2>
     <p class="text-gray-700">
      Kami memperbarui kebijakan privasi untuk transparansi lebih baik dalam pengelolaan data pengguna.
     </p>
    </article>
   </section>
  </template>
  <!-- Forum Page -->
  <template id="forumPageTemplate">
   <section class="p-4 max-w-4xl mx-auto flex flex-col space-y-4">
    <div>
     <button aria-label="Katakan sesuatu..." class="w-full text-left border border-gray-300 rounded px-4 py-3 text-gray-600 hover:bg-gray-100 focus:outline-none" id="openUpdateModalBtn">
      Katakan sesuatu...
     </button>
    </div>
    <div class="space-y-6" id="postsContainer">
     <!-- Posts will be dynamically inserted here -->
    </div>
   </section>
  </template>
  <!-- Profile Page -->
  <template id="profilePageTemplate">
   <section class="p-6 max-w-4xl mx-auto">
    <h1 class="text-2xl font-semibold mb-4 text-gray-800">
     Profil Saya
    </h1>
    <div class="bg-white rounded shadow p-6 space-y-4">
     <p>
      <span class="font-semibold">
       Nama Lengkap:
      </span>
      <span id="profileFullName">
      </span>
     </p>
     <p>
      <span class="font-semibold">
       Email:
      </span>
      <span id="profileEmail">
      </span>
     </p>
     <p>
      <span class="font-semibold">
       Nomor WhatsApp:
      </span>
      <span id="profileWhatsapp">
      </span>
     </p>
     <p>
      <span class="font-semibold">
       Kode Referral:
      </span>
      <span id="profileReferral">
      </span>
     </p>
     <p>
      <span class="font-semibold">
       Saldo Point:
      </span>
      <span id="profilePoints">
       0
      </span>
     </p>
    </div>
   </section>
  </template>
  <!-- Iframe container for Beranda, Informasi, Tentang -->
  <div class="hidden fixed inset-0 bg-white z-40 flex flex-col" id="iframeContainer">
   <div class="flex justify-between items-center border-b border-gray-300 p-3">
    <h2 class="text-lg font-semibold text-gray-800" id="iframeTitle">
    </h2>
    <button aria-label="Close iframe" class="text-gray-600 hover:text-gray-900 focus:outline-none text-2xl" id="closeIframeBtn">
     ×
    </button>
   </div>
   <iframe class="flex-grow w-full" frameborder="0" id="iframeContent" sandbox="allow-scripts allow-same-origin allow-forms" src="" title="Embedded content">
   </iframe>
  </div>
  <!-- Firebase and App Script -->
  <script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut,
      updateProfile,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      setDoc,
      query,
      where,
      orderBy,
      limit,
      onSnapshot,
      updateDoc,
      deleteDoc,
      serverTimestamp,
      Timestamp,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23",
      storageBucket: "gmi-enterprise23.firebasestorage.app",
      messagingSenderId: "974090028804",
      appId: "1:974090028804:web:43ae563ffd9433463c7251",
      measurementId: "G-S27YB5Z8PR",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Imgur API credentials
    const IMGUR_CLIENT_ID = "0f3d0dc555fdb38";

    // DOM Elements
    const appContainer = document.getElementById("app");
    const menuToggleBtn = document.getElementById("menuToggleBtn");
    const menuOptions = document.getElementById("menuOptions");

    // Footer buttons
    const btnHome = document.getElementById("btnHome");
    const btnForum = document.getElementById("btnForum");
    const btnInfo = document.getElementById("btnInfo");
    const btnAbout = document.getElementById("btnAbout");
    const btnProfile = document.getElementById("btnProfile");

    // Iframe container
    const iframeContainer = document.getElementById("iframeContainer");
    const iframeContent = document.getElementById("iframeContent");
    const iframeTitle = document.getElementById("iframeTitle");
    const closeIframeBtn = document.getElementById("closeIframeBtn");

    // Modals
    const commentModal = document.getElementById("commentModal");
    const closeCommentModalBtn = document.getElementById("closeCommentModal");
    const commentList = document.getElementById("commentList");
    const commentForm = document.getElementById("commentForm");
    const commentInput = document.getElementById("commentInput");

    const reportModal = document.getElementById("reportModal");
    const closeReportModalBtn = document.getElementById("closeReportModal");
    const reportForm = document.getElementById("reportForm");
    const reportReason = document.getElementById("reportReason");

    const updateModal = document.getElementById("updateModal");
    const closeUpdateModalBtn = document.getElementById("closeUpdateModal");
    const updateForm = document.getElementById("updateForm");
    const postText = document.getElementById("postText");
    const postImage = document.getElementById("postImage");
    const cancelPostBtn = document.getElementById("cancelPostBtn");

    // State
    let currentUser = null;
    let currentPage = null;
    let currentPostIdForComments = null;
    let postsUnsubscribe = null;
    let commentsUnsubscribe = null;
    let starRatingValue = 0;

    // Utility: Generate random referral code
    function generateReferralCode(length = 8) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < length; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Utility: Format date and time
    function formatDateTime(timestamp) {
      const date = timestamp.toDate();
      return (
        date.toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        }) +
        " " +
        date.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" })
      );
    }

    // Utility: Check if post is expired (older than 24 hours)
    function isPostExpired(timestamp) {
      const now = new Date();
      const postDate = timestamp.toDate();
      return now - postDate > 24 * 60 * 60 * 1000;
    }

    // Show/hide menu options
    menuToggleBtn.addEventListener("click", () => {
      menuOptions.classList.toggle("hidden");
    });

    // Close menu if clicked outside
    document.addEventListener("click", (e) => {
      if (
        !menuToggleBtn.contains(e.target) &&
        !menuOptions.contains(e.target)
      ) {
        menuOptions.classList.add("hidden");
      }
    });

    // SPA navigation handler
    function navigateTo(page, options = {}) {
      currentPage = page;
      menuOptions.classList.add("hidden");
      if (postsUnsubscribe) {
        postsUnsubscribe();
        postsUnsubscribe = null;
      }
      if (commentsUnsubscribe) {
        commentsUnsubscribe();
        commentsUnsubscribe = null;
      }
      iframeContainer.classList.add("hidden");
      iframeContent.src = "";
      iframeTitle.textContent = "";

      switch (page) {
        case "login":
          renderLoginPage();
          break;
        case "register":
          renderRegisterPage();
          break;
        case "settings":
          renderSettingsPage();
          break;
        case "contact":
          renderContactPage();
          break;
        case "aboutapp":
          renderAboutAppPage();
          break;
        case "rateus":
          renderRateUsPage();
          break;
        case "newsupdates":
          renderNewsUpdatesPage();
          break;
        case "beranda":
          renderBerandaPage();
          break;
        case "forum":
          renderForumPage();
          break;
        case "informasi":
          openIframe("informasi.html", "Informasi");
          break;
        case "tentang":
          openIframe("tentang.html", "Tentang");
          break;
        case "profile":
          renderProfilePage();
          break;
        default:
          renderLoginPage();
          break;
      }
    }

    // Render Login Page
    function renderLoginPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("loginPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);

      const loginForm = document.getElementById("loginForm");
      const googleLoginBtn = document.getElementById("googleLoginBtn");
      const goToRegisterBtn = document.getElementById("goToRegisterBtn");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = loginForm.loginUsername.value.trim();
        const password = loginForm.loginPassword.value;

        if (!username || !password) {
          alert("Username dan password harus diisi.");
          return;
        }

        try {
          // Firebase email login expects email, so we try to find user email by username
          // For demo, assume username is email
          await signInWithEmailAndPassword(auth, username, password);
          // On success, user state will be handled by onAuthStateChanged
        } catch (error) {
          alert("Gagal login: " + error.message);
        }
      });

      googleLoginBtn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          // On success, user state will be handled by onAuthStateChanged
        } catch (error) {
          alert("Gagal login dengan Google: " + error.message);
        }
      });

      goToRegisterBtn.addEventListener("click", () => {
        navigateTo("register");
      });
    }

    // Render Register Page
    function renderRegisterPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("registerPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);

      const registerForm = document.getElementById("registerForm");
      const goToLoginBtn = document.getElementById("goToLoginBtn");

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fullname = registerForm.registerFullName.value.trim();
        const address = registerForm.registerAddress.value.trim();
        const password = registerForm.registerPassword.value;
        const passwordVerify = registerForm.registerPasswordVerify.value;
        const whatsapp = registerForm.registerWhatsapp.value.trim();

        if (
          !fullname ||
          !address ||
          !password ||
          !passwordVerify ||
          !whatsapp
        ) {
          alert("Semua field harus diisi.");
          return;
        }
        if (password !== passwordVerify) {
          alert("Password dan verifikasi password tidak cocok.");
          return;
        }
        // Validate WhatsApp number pattern (Indonesia)
        const waPattern = /^\+?62[0-9]{8,15}$/;
        if (!waPattern.test(whatsapp)) {
          alert(
            "Nomor WhatsApp harus diawali dengan kode negara +62 dan diikuti nomor yang valid."
          );
          return;
        }

        try {
          // For demo, use fullname + random domain as email (since Firebase needs email)
          // In real app, user should input email or use Google login
          const email = fullname.toLowerCase().replace(/\s+/g, "") + "@gmi-official.id";

          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          // Update displayName
          await updateProfile(user, { displayName: fullname });

          // Generate referral code
          const referralCode = generateReferralCode();

          // Save user data to Firestore
          await setDoc(doc(db, "users", user.uid), {
            fullname,
            address,
            whatsapp,
            email,
            referralCode,
            createdAt: serverTimestamp(),
            points: 0,
          });

          alert("Registrasi berhasil. Silakan login.");
          navigateTo("login");
        } catch (error) {
          alert("Gagal registrasi: " + error.message);
        }
      });

      goToLoginBtn.addEventListener("click", () => {
        navigateTo("login");
      });
    }

    // Render Settings Page
    function renderSettingsPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("settingsPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);
    }

    // Render Contact Page
    function renderContactPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("contactPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);
    }

    // Render About App Page
    function renderAboutAppPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("aboutAppPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);
    }

    // Render Rate Us Page
    function renderRateUsPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("rateUsPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);

      const stars = document.querySelectorAll("#starRating i");
      const reviewTextarea = document.getElementById("rateReview");
      const submitBtn = document.getElementById("submitRatingBtn");

      starRatingValue = 0;

      stars.forEach((star) => {
        star.classList.remove("fas");
        star.classList.add("far");
        star.addEventListener("click", () => {
          starRatingValue = parseInt(star.dataset.star);
          updateStarRatingUI();
        });
      });

      function updateStarRatingUI() {
        stars.forEach((star) => {
          if (parseInt(star.dataset.star) <= starRatingValue) {
            star.classList.remove("far");
            star.classList.add("fas");
          } else {
            star.classList.remove("fas");
            star.classList.add("far");
          }
        });
      }

      submitBtn.addEventListener("click", async () => {
        if (starRatingValue === 0) {
          alert("Silakan pilih bintang rating.");
          return;
        }
        const review = reviewTextarea.value.trim();

        try {
          await addDoc(collection(db, "ratings"), {
            userId: currentUser.uid,
            rating: starRatingValue,
            review,
            createdAt: serverTimestamp(),
          });
          alert("Terima kasih atas penilaian Anda!");
          reviewTextarea.value = "";
          starRatingValue = 0;
          updateStarRatingUI();
        } catch (error) {
          alert("Gagal mengirim penilaian: " + error.message);
        }
      });
    }

    // Render News or Updates Page
    function renderNewsUpdatesPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("newsUpdatesPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);
    }

    // Render Beranda Page (iframe)
    function renderBerandaPage() {
      openIframe("home.html", "Beranda");
    }

    // Render Informasi Page (iframe)
    function renderInformasiPage() {
      openIframe("informasi.html", "Informasi");
    }

    // Render Tentang Page (iframe)
    function renderTentangPage() {
      openIframe("tentang.html", "Tentang");
    }

    // Open iframe with given src and title
    function openIframe(src, title) {
      iframeContent.src = src;
      iframeTitle.textContent = title;
      iframeContainer.classList.remove("hidden");
      appContainer.innerHTML = "";
    }

    closeIframeBtn.addEventListener("click", () => {
      iframeContainer.classList.add("hidden");
      iframeContent.src = "";
      // After closing iframe, default to Beranda
      navigateTo("beranda");
    });

    // Render Forum Page
    function renderForumPage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("forumPageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);

      const postsContainer = document.getElementById("postsContainer");
      const openUpdateModalBtn = document.getElementById("openUpdateModalBtn");

      openUpdateModalBtn.addEventListener("click", () => {
        openUpdateModal();
      });

      // Listen to posts collection, order by createdAt desc, only posts not expired
      const postsRef = collection(db, "posts");
      const q = query(postsRef, orderBy("createdAt", "desc"));

      postsUnsubscribe = onSnapshot(q, async (snapshot) => {
        postsContainer.innerHTML = "";
        const now = new Date();

        // Filter posts that are not expired (24 hours)
        const validPosts = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.createdAt && !isPostExpired(data.createdAt)) {
            validPosts.push({ id: docSnap.id, ...data });
          } else if (data.createdAt && isPostExpired(data.createdAt)) {
            // Delete expired post
            deleteDoc(doc(db, "posts", docSnap.id));
          }
        });

        if (validPosts.length === 0) {
          postsContainer.innerHTML =
            '<p class="text-center text-gray-500">Belum ada postingan.</p>';
          return;
        }

        for (const post of validPosts) {
          const postElement = await createPostElement(post);
          postsContainer.appendChild(postElement);
        }
      });
    }

    // Create post element for forum
    async function createPostElement(post) {
      const postDiv = document.createElement("article");
      postDiv.className =
        "bg-white rounded shadow p-4 space-y-2 border border-gray-200";

      // User data
      let userData = null;
      try {
        const userDoc = await getDoc(doc(db, "users", post.userId));
        if (userDoc.exists()) {
          userData = userDoc.data();
        }
      } catch {
        userData = null;
      }

      // Header: user name, date, time
      const headerDiv = document.createElement("div");
      headerDiv.className = "flex justify-between items-center text-gray-700 text-sm";

      const userNameSpan = document.createElement("span");
      userNameSpan.textContent = userData?.fullname || "Pengguna";

      const dateSpan = document.createElement("span");
      dateSpan.textContent = post.createdAt
        ? formatDateTime(post.createdAt)
        : "";

      headerDiv.appendChild(userNameSpan);
      headerDiv.appendChild(dateSpan);

      // Content text
      const contentP = document.createElement("p");
      contentP.className = "text-gray-800 whitespace-pre-wrap";
      contentP.textContent = post.text || "";

      postDiv.appendChild(headerDiv);
      postDiv.appendChild(contentP);

      // Image if exists
      if (post.imageUrl) {
        const img = document.createElement("img");
        img.src = post.imageUrl;
        img.alt = `Gambar postingan oleh ${userData?.fullname || "pengguna"}`;
        img.className = "w-full max-h-96 object-contain rounded";
        postDiv.appendChild(img);
      }

      // Actions: Like, Comment, Report
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "flex space-x-4 text-gray-600 text-sm";

      // Like button
      const likeBtn = document.createElement("button");
      likeBtn.className = "flex items-center space-x-1 hover:text-blue-600 focus:outline-none";
      likeBtn.setAttribute("aria-label", "Like postingan");
      const likeIcon = document.createElement("i");
      likeIcon.className = "far fa-thumbs-up";
      const likeCountSpan = document.createElement("span");
      likeCountSpan.textContent = post.likes ? Object.keys(post.likes).length : 0;
      likeBtn.appendChild(likeIcon);
      likeBtn.appendChild(likeCountSpan);

      likeBtn.addEventListener("click", async () => {
        if (!currentUser) {
          alert("Silakan login untuk menyukai postingan.");
          return;
        }
        const postRef = doc(db, "posts", post.id);
        const likes = post.likes || {};
        if (likes[currentUser.uid]) {
          // Unlike
          delete likes[currentUser.uid];
        } else {
          likes[currentUser.uid] = true;
        }
        await updateDoc(postRef, { likes });
      });

      // Comment button
      const commentBtn = document.createElement("button");
      commentBtn.className = "flex items-center space-x-1 hover:text-blue-600 focus:outline-none";
      commentBtn.setAttribute("aria-label", "Komentar postingan");
      const commentIcon = document.createElement("i");
      commentIcon.className = "far fa-comment";
      const commentCountSpan = document.createElement("span");
      commentCountSpan.textContent = post.comments ? Object.keys(post.comments).length : 0;
      commentBtn.appendChild(commentIcon);
      commentBtn.appendChild(commentCountSpan);

      commentBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("Silakan login untuk mengomentari postingan.");
          return;
        }
        openCommentModal(post.id);
      });

      // Report button
      const reportBtn = document.createElement("button");
      reportBtn.className = "flex items-center space-x-1 hover:text-red-600 focus:outline-none";
      reportBtn.setAttribute("aria-label", "Laporkan postingan");
      const reportIcon = document.createElement("i");
      reportIcon.className = "fas fa-flag";
      reportBtn.appendChild(reportIcon);
      const reportText = document.createElement("span");
      reportText.textContent = "Report";
      reportText.className = "sr-only";
      reportBtn.appendChild(reportText);

      reportBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("Silakan login untuk melaporkan postingan.");
          return;
        }
        openReportModal(post.id);
      });

      actionsDiv.appendChild(likeBtn);
      actionsDiv.appendChild(commentBtn);
      actionsDiv.appendChild(reportBtn);

      postDiv.appendChild(actionsDiv);

      return postDiv;
    }

    // Open Comment Modal for a post
    function openCommentModal(postId) {
      currentPostIdForComments = postId;
      commentList.innerHTML = "";
      commentInput.value = "";
      commentModal.classList.remove("hidden");

      // Listen to comments on this post
      const postRef = doc(db, "posts", postId);
      commentsUnsubscribe = onSnapshot(postRef, (docSnap) => {
        if (!docSnap.exists()) {
          commentList.innerHTML =
            '<p class="text-center text-gray-500">Postingan tidak ditemukan.</p>';
          return;
        }
        const data = docSnap.data();
        const comments = data.comments || {};
        commentList.innerHTML = "";

        // Sort comments by timestamp ascending
        const sortedComments = Object.entries(comments).sort(
          (a, b) => a[1].createdAt?.toMillis() - b[1].createdAt?.toMillis()
        );

        for (const [commentId, comment] of sortedComments) {
          const commentDiv = createCommentElement(commentId, comment, postId);
          commentList.appendChild(commentDiv);
        }
      });
    }

    // Create comment element with replies
    function createCommentElement(commentId, comment, postId) {
      const div = document.createElement("div");
      div.className = "border border-gray-200 rounded p-2";

      const header = document.createElement("div");
      header.className = "flex justify-between items-center text-sm text-gray-700";

      const userSpan = document.createElement("span");
      userSpan.textContent = comment.userName || "Pengguna";

      const timeSpan = document.createElement("span");
      timeSpan.textContent = comment.createdAt
        ? formatDateTime(comment.createdAt)
        : "";

      header.appendChild(userSpan);
      header.appendChild(timeSpan);

      const contentP = document.createElement("p");
      contentP.className = "mt-1 text-gray-800 whitespace-pre-wrap";
      contentP.textContent = comment.text;

      div.appendChild(header);
      div.appendChild(contentP);

      // Replies container
      const repliesDiv = document.createElement("div");
      repliesDiv.className = "ml-4 mt-2 space-y-2";

      if (comment.replies) {
        // Sort replies by timestamp ascending
        const sortedReplies = Object.entries(comment.replies).sort(
          (a, b) => a[1].createdAt?.toMillis() - b[1].createdAt?.toMillis()
        );
        for (const [replyId, reply] of sortedReplies) {
          const replyDiv = document.createElement("div");
          replyDiv.className =
            "border border-gray-300 rounded p-2 bg-gray-50 text-sm";

          const replyHeader = document.createElement("div");
          replyHeader.className =
            "flex justify-between items-center text-xs text-gray-600";

          const replyUserSpan = document.createElement("span");
          replyUserSpan.textContent = reply.userName || "Pengguna";

          const replyTimeSpan = document.createElement("span");
          replyTimeSpan.textContent = reply.createdAt
            ? formatDateTime(reply.createdAt)
            : "";

          replyHeader.appendChild(replyUserSpan);
          replyHeader.appendChild(replyTimeSpan);

          const replyContentP = document.createElement("p");
          replyContentP.className = "mt-1 whitespace-pre-wrap";
          replyContentP.textContent = reply.text;

          replyDiv.appendChild(replyHeader);
          replyDiv.appendChild(replyContentP);

          repliesDiv.appendChild(replyDiv);
        }
      }

      div.appendChild(repliesDiv);

      // Reply button
      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Reply";
      replyBtn.className =
        "mt-2 text-blue-600 text-sm hover:underline focus:outline-none";
      replyBtn.addEventListener("click", () => {
        openReplyInput(div, commentId, postId);
      });

      div.appendChild(replyBtn);

      return div;
    }

    // Open reply input under a comment
    function openReplyInput(commentDiv, commentId, postId) {
      // Prevent multiple reply inputs
      if (commentDiv.querySelector(".reply-input")) return;

      const replyForm = document.createElement("form");
      replyForm.className = "reply-input mt-2 flex space-x-2";

      const replyInput = document.createElement("input");
      replyInput.type = "text";
      replyInput.placeholder = "Tulis balasan...";
      replyInput.required = true;
      replyInput.className =
        "flex-grow border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500";

      const sendBtn = document.createElement("button");
      sendBtn.type = "submit";
      sendBtn.textContent = "Kirim";
      sendBtn.className =
        "bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 focus:outline-none";

      replyForm.appendChild(replyInput);
      replyForm.appendChild(sendBtn);

      replyForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = replyInput.value.trim();
        if (!text) return;

        try {
          const postRef = doc(db, "posts", postId);
          const postSnap = await getDoc(postRef);
          if (!postSnap.exists()) {
            alert("Postingan tidak ditemukan.");
            return;
          }
          const postData = postSnap.data();
          const comments = postData.comments || {};

          if (!comments[commentId]) {
            alert("Komentar tidak ditemukan.");
            return;
          }

          if (!comments[commentId].replies) {
            comments[commentId].replies = {};
          }

          const replyId = Date.now().toString();

          comments[commentId].replies[replyId] = {
            userId: currentUser.uid,
            userName: currentUser.displayName || "Pengguna",
            text,
            createdAt: Timestamp.now(),
          };

          await updateDoc(postRef, { comments });

          replyInput.value = "";
          replyForm.remove();
        } catch (error) {
          alert("Gagal mengirim balasan: " + error.message);
        }
      });

      commentDiv.appendChild(replyForm);
      replyInput.focus();
    }

    // Close comment modal
    closeCommentModalBtn.addEventListener("click", () => {
      commentModal.classList.add("hidden");
      currentPostIdForComments = null;
      if (commentsUnsubscribe) {
        commentsUnsubscribe();
        commentsUnsubscribe = null;
      }
    });

    // Open Report Modal
    let currentPostIdForReport = null;
    function openReportModal(postId) {
      currentPostIdForReport = postId;
      reportReason.value = "";
      reportModal.classList.remove("hidden");
    }

    // Close report modal
    closeReportModalBtn.addEventListener("click", () => {
      reportModal.classList.add("hidden");
      currentPostIdForReport = null;
    });

    // Submit report form
    reportForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentPostIdForReport) return;
      const reason = reportReason.value;
      if (!reason) {
        alert("Silakan pilih alasan laporan.");
        return;
      }
      // Send report to WhatsApp
      const waNumber = "628119118047";
      const text = encodeURIComponent(
        `Laporan Postingan ID: ${currentPostIdForReport}\nAlasan: ${reason}`
      );
      const waUrl = `https://wa.me/${waNumber}?text=${text}`;
      window.open(waUrl, "_blank");
      alert("Laporan telah dikirim ke WhatsApp admin.");
      reportModal.classList.add("hidden");
      currentPostIdForReport = null;
    });

    // Open Update Modal
    function openUpdateModal() {
      updateModal.classList.remove("hidden");
      postText.value = "";
      postImage.value = "";
    }

    // Close Update Modal
    closeUpdateModalBtn.addEventListener("click", () => {
      updateModal.classList.add("hidden");
    });
    cancelPostBtn.addEventListener("click", () => {
      updateModal.classList.add("hidden");
    });

    // Submit new post
    updateForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Silakan login untuk membuat postingan.");
        return;
      }
      const text = postText.value.trim();
      if (!text) {
        alert("Teks postingan tidak boleh kosong.");
        return;
      }

      updateForm.querySelector("button[type=submit]").disabled = true;

      try {
        let imageUrl = null;
        if (postImage.files.length > 0) {
          const file = postImage.files[0];
          // Upload image to Imgur
          imageUrl = await uploadImageToImgur(file);
        }

        // Save post to Firestore
        await addDoc(collection(db, "posts"), {
          userId: currentUser.uid,
          text,
          imageUrl,
          likes: {},
          comments: {},
          createdAt: serverTimestamp(),
        });

        alert("Postingan berhasil dibuat.");
        updateModal.classList.add("hidden");
      } catch (error) {
        alert("Gagal membuat postingan: " + error.message);
      } finally {
        updateForm.querySelector("button[type=submit]").disabled = false;
      }
    });

    // Upload image to Imgur
    async function uploadImageToImgur(file) {
      const formData = new FormData();
      formData.append("image", file);

      const response = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID " + IMGUR_CLIENT_ID,
        },
        body: formData,
      });

      const data = await response.json();
      if (!data.success) {
        throw new Error("Gagal mengupload gambar ke Imgur.");
      }
      return data.data.link;
    }

    // Render Profile Page
    async function renderProfilePage() {
      appContainer.innerHTML = "";
      const template = document.getElementById("profilePageTemplate");
      const clone = template.content.cloneNode(true);
      appContainer.appendChild(clone);

      const profileFullName = document.getElementById("profileFullName");
      const profileEmail = document.getElementById("profileEmail");
      const profileWhatsapp = document.getElementById("profileWhatsapp");
      const profileReferral = document.getElementById("profileReferral");
      const profilePoints = document.getElementById("profilePoints");

      try {
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          profileFullName.textContent = data.fullname || "";
          profileEmail.textContent = data.email || currentUser.email || "";
          profileWhatsapp.textContent = data.whatsapp || "";
          profileReferral.textContent = data.referralCode || "";
          profilePoints.textContent = data.points || 0;
        }
      } catch {
        profileFullName.textContent = currentUser.displayName || "";
        profileEmail.textContent = currentUser.email || "";
        profileWhatsapp.textContent = "";
        profileReferral.textContent = "";
        profilePoints.textContent = "0";
      }
    }

    // Footer buttons event listeners
    btnHome.addEventListener("click", () => {
      navigateTo("beranda");
    });
    btnForum.addEventListener("click", () => {
      navigateTo("forum");
    });
    btnInfo.addEventListener("click", () => {
      navigateTo("informasi");
    });
    btnAbout.addEventListener("click", () => {
      navigateTo("tentang");
    });
    btnProfile.addEventListener("click", () => {
      navigateTo("profile");
    });

    // On auth state changed
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        // Check if user data exists in Firestore, if not create
        const userDocRef = doc(db, "users", user.uid);
        const userDocSnap = await getDoc(userDocRef);
        if (!userDocSnap.exists()) {
          // Create user data with minimal info
          const referralCode = generateReferralCode();
          await setDoc(userDocRef, {
            fullname: user.displayName || "Pengguna",
            email: user.email || "",
            whatsapp: "",
            referralCode,
            createdAt: serverTimestamp(),
            points: 0,
          });
        }
        // Navigate to Beranda by default
        navigateTo("beranda");
      } else {
        currentUser = null;
        navigateTo("login");
      }
    });

    // SPA menu options click handler
    menuOptions.querySelectorAll("a[data-spa-link]").forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const page = e.target.getAttribute("data-spa-link");
        navigateTo(page);
      });
    });

    // Initial navigation handled by onAuthStateChanged
  </script>
 </body>
</html>
