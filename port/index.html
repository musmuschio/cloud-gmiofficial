<html lang="id" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>GMI Official App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23",
      storageBucket: "gmi-enterprise23.firebasestorage.app",
      messagingSenderId: "974090028804",
      appId: "1:974090028804:web:43ae563ffd9433463c7251",
      measurementId: "G-S27YB5Z8PR",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Utility: Generate referral code (random 8 chars alphanumeric uppercase)
    function generateReferralCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Render Login Page
    function renderLoginPage() {
      document.body.innerHTML = `
      <div class="min-h-screen flex flex-col justify-center items-center bg-gray-50 px-4 py-8">
        <div class="w-full max-w-md bg-white rounded-lg shadow p-8">
          <h1 class="text-2xl font-semibold text-center mb-6 text-gray-800">Login</h1>
          <form class="space-y-5" id="loginForm">
            <div>
              <label for="loginUsername" class="block text-gray-700 font-semibold mb-1">Username</label>
              <input type="text" id="loginUsername" name="username" placeholder="Masukkan username" required autocomplete="username" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label for="loginPassword" class="block text-gray-700 font-semibold mb-1">Password</label>
              <input type="password" id="loginPassword" name="password" placeholder="Masukkan password" required autocomplete="current-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 focus:outline-none">Login</button>
          </form>
          <div class="my-4 flex items-center justify-center space-x-3">
            <span class="border-b border-gray-300 w-1/5"></span>
            <span class="text-gray-500 text-sm">atau</span>
            <span class="border-b border-gray-300 w-1/5"></span>
          </div>
          <button id="googleLoginBtn" class="w-full flex items-center justify-center space-x-3 border border-gray-300 rounded py-2 hover:bg-gray-100 focus:outline-none">
            <img src="https://storage.googleapis.com/a1aa/image/81fcc7a4-0393-4408-0830-db068b1d5010.jpg" alt="Google logo, multicolor G letter" class="w-5 h-5" />
            <span class="text-gray-700 font-semibold">Login dengan Google</span>
          </button>
          <p class="mt-6 text-center text-gray-600 text-sm">
            Belum punya akun?
            <button id="goToRegisterBtn" class="text-blue-600 font-semibold hover:underline focus:outline-none">Klik di sini!</button>
          </p>
        </div>
      </div>
      `;

      const loginForm = document.getElementById("loginForm");
      const googleLoginBtn = document.getElementById("googleLoginBtn");
      const goToRegisterBtn = document.getElementById("goToRegisterBtn");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = loginForm.loginUsername.value.trim();
        const password = loginForm.loginPassword.value;
        if (!username || !password) return alert("Username dan password harus diisi.");

        // Treat username as email for Firebase Auth
        try {
          await signInWithEmailAndPassword(auth, username, password);
        } catch (err) {
          alert("Login gagal: " + err.message);
        }
      });

      googleLoginBtn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
        } catch (err) {
          alert("Login Google gagal: " + err.message);
        }
      });

      goToRegisterBtn.addEventListener("click", () => {
        renderRegisterPage();
      });
    }

    // Render Register Page
    function renderRegisterPage() {
      document.body.innerHTML = `
      <div class="min-h-screen flex flex-col justify-center items-center bg-gray-50 px-4 py-8">
        <div class="w-full max-w-md bg-white rounded-lg shadow p-8">
          <h1 class="text-2xl font-semibold text-center mb-6 text-gray-800">Daftar Akun Baru</h1>
          <form class="space-y-5" id="registerForm">
            <div>
              <label for="registerFullName" class="block text-gray-700 font-semibold mb-1">Nama Lengkap</label>
              <input type="text" id="registerFullName" name="fullname" placeholder="Masukkan nama lengkap" required autocomplete="name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label for="registerAddress" class="block text-gray-700 font-semibold mb-1">Alamat</label>
              <textarea id="registerAddress" name="address" placeholder="Masukkan alamat lengkap" required rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            </div>
            <div>
              <label for="registerPassword" class="block text-gray-700 font-semibold mb-1">Password</label>
              <input type="password" id="registerPassword" name="password" placeholder="Masukkan password" required autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <p class="text-xs text-red-600 mt-1">Tidak disarankan menggunakan sandi yang sama seperti sandi email atau sosial media.</p>
            </div>
            <div>
              <label for="registerPasswordVerify" class="block text-gray-700 font-semibold mb-1">Verifikasi Password</label>
              <input type="password" id="registerPasswordVerify" name="passwordVerify" placeholder="Masukkan ulang password" required autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label for="registerWhatsapp" class="block text-gray-700 font-semibold mb-1">Nomor WhatsApp</label>
              <input type="tel" id="registerWhatsapp" name="whatsapp" placeholder="+6281234567890" pattern="^\\+?62[0-9]{8,15}$" required autocomplete="tel" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <p class="text-xs text-gray-500 mt-1">Format nomor harus diawali +62 dan tanpa spasi.</p>
            </div>
            <div>
              <label for="registerReferral" class="block text-gray-700 font-semibold mb-1">Kode Referral (Opsional)</label>
              <input type="text" id="registerReferral" name="referral" placeholder="Masukkan kode referral jika ada" autocomplete="off" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 focus:outline-none">Daftar</button>
          </form>
          <p class="mt-6 text-center text-gray-600 text-sm">
            Sudah punya akun?
            <button id="goToLoginBtn" class="text-blue-600 font-semibold hover:underline focus:outline-none">Klik di sini!</button>
          </p>
        </div>
      </div>
      `;

      const registerForm = document.getElementById("registerForm");
      const goToLoginBtn = document.getElementById("goToLoginBtn");

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fullname = registerForm.fullname.value.trim();
        const address = registerForm.address.value.trim();
        const password = registerForm.password.value;
        const passwordVerify = registerForm.passwordVerify.value;
        const whatsapp = registerForm.whatsapp.value.trim();
        const referral = registerForm.referral.value.trim();

        if (!fullname || !address || !password || !passwordVerify || !whatsapp) {
          return alert("Semua field wajib diisi kecuali kode referral.");
        }
        if (password !== passwordVerify) {
          return alert("Password dan verifikasi password tidak cocok.");
        }
        if (!/^\+?62[0-9]{8,15}$/.test(whatsapp)) {
          return alert("Nomor WhatsApp harus diawali +62 dan valid.");
        }

        // Create fake email for Firebase Auth (fullname + timestamp)
        const email =
          fullname.toLowerCase().replace(/\s+/g, "") + Date.now() + "@gmiofficial.local";

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          // Create user document in Firestore
          const userDocRef = doc(db, "users", user.uid);
          const userReferralCode = referral || generateReferralCode();

          await setDoc(userDocRef, {
            fullname,
            address,
            whatsapp,
            referralCode: userReferralCode,
            email: email,
            createdAt: serverTimestamp(),
            points: 0,
            id: user.uid,
          });

          alert("Pendaftaran berhasil. Silakan login menggunakan username dan password Anda.");
          renderLoginPage();
        } catch (err) {
          alert("Pendaftaran gagal: " + err.message);
        }
      });

      goToLoginBtn.addEventListener("click", () => {
        renderLoginPage();
      });
    }

    // On load, check auth state and redirect accordingly
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User logged in, redirect to main app page (home.html)
        window.location.href = "app.html";
      } else {
        // Not logged in, show login page
        renderLoginPage();
      }
    });
  </script>
</body>
</html>
