<html class="scroll-smooth" lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>GMI Official App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }
    /* Modal slide up animation */
    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    #commentModal.show {
      animation: slideUp 0.3s ease forwards;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header
    class="flex justify-between items-center bg-white shadow px-4 py-3 sticky top-0 z-30"
  >
    <div class="flex items-center space-x-3">
      <img
        alt="GMI Official Logo, stylized letters G M I in blue and white"
        class="w-10 h-10 rounded"
        height="40"
        src="https://storage.googleapis.com/a1aa/image/e983514a-d83e-4c4f-a8e9-ce67afcf188a.jpg"
        width="40"
      />
      <span class="font-bold text-xl text-blue-700 select-none">gmi official</span>
    </div>
    <div class="relative">
      <button
        aria-label="Open menu options"
        class="text-2xl text-gray-700 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
        id="menuBtn"
      >
        <i class="fas fa-ellipsis-v"></i>
      </button>
      <div
        class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 z-40"
        id="menuOptions"
      >
        <div class="py-1">
          <button
            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-100 hover:text-blue-700"
            onclick="loadPage('settings.html')"
          >
            Settings
          </button>
          <button
            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-100 hover:text-blue-700"
            onclick="loadPage('contact.html')"
          >
            Contact
          </button>
          <button
            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-100 hover:text-blue-700"
            onclick="loadPage('aboutapp.html')"
          >
            About Apps
          </button>
          <button
            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-100 hover:text-blue-700"
            onclick="loadPage('rateus.html')"
          >
            Rate Us
          </button>
          <button
            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-100 hover:text-blue-700"
            onclick="loadPage('news.html')"
          >
            News or Updates
          </button>
        </div>
      </div>
    </div>
  </header>
  <!-- Main Content -->
  <main class="flex-grow flex flex-col">
    <div class="flex-grow relative" id="contentArea">
      <!-- Default to home page iframe -->
      <iframe
        class="w-full h-full border-0"
        id="frame"
        src="home.html"
        title="Main content frame"
      ></iframe>
    </div>
    <!-- Forum SPA (hidden by default) -->
    <section
      class="hidden flex flex-col max-w-3xl mx-auto p-4 space-y-4 overflow-y-auto"
      id="forumSection"
      style="max-height: calc(100vh - 160px)"
    >
      <div class="bg-white rounded shadow p-3">
        <button
          class="w-full text-left text-gray-500 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
          id="openPostBtn"
        >
          Katakan sesuatu...
        </button>
      </div>
      <div class="space-y-4" id="postContainer"></div>
    </section>
  </main>
  <!-- Footer Navigation -->
  <footer
    class="bg-white border-t border-gray-200 flex justify-around items-center py-2 fixed bottom-0 w-full z-30"
  >
    <button
      aria-label="Home"
      class="flex flex-col items-center text-gray-600 hover:text-blue-700 focus:outline-none focus:text-blue-700"
      id="btnHome"
    >
      <i class="fas fa-home fa-lg"></i>
      <span class="text-xs mt-0.5">Beranda</span>
    </button>
    <button
      aria-label="Forum"
      class="flex flex-col items-center text-gray-600 hover:text-blue-700 focus:outline-none focus:text-blue-700"
      id="btnForum"
    >
      <i class="fas fa-comments fa-lg"></i>
      <span class="text-xs mt-0.5">Forum</span>
    </button>
    <button
      aria-label="Informasi"
      class="flex flex-col items-center text-gray-600 hover:text-blue-700 focus:outline-none focus:text-blue-700"
      id="btnInfo"
    >
      <i class="fas fa-info-circle fa-lg"></i>
      <span class="text-xs mt-0.5">Informasi</span>
    </button>
    <button
      aria-label="Tentang"
      class="flex flex-col items-center text-gray-600 hover:text-blue-700 focus:outline-none focus:text-blue-700"
      id="btnAbout"
    >
      <i class="fas fa-users fa-lg"></i>
      <span class="text-xs mt-0.5">Tentang</span>
    </button>
    <button
      aria-label="Profil"
      class="flex flex-col items-center text-gray-600 hover:text-blue-700 focus:outline-none focus:text-blue-700"
      id="btnProfile"
    >
      <i class="fas fa-user fa-lg"></i>
      <span class="text-xs mt-0.5">Profil</span>
    </button>
  </footer>
  <!-- Profile Modal -->
  <div
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    id="profileModal"
  >
    <div
      class="bg-white rounded-lg max-w-sm w-full p-6 space-y-4 relative"
    >
      <button
        aria-label="Close profile modal"
        class="absolute top-3 right-3 text-gray-500 hover:text-red-600 focus:outline-none"
        id="closeProfileModal"
      >
        <i class="fas fa-times fa-lg"></i>
      </button>
      <h2 class="text-2xl font-bold text-blue-700">Profil User</h2>
      <div>
        <p
          class="text-4xl font-extrabold text-center text-green-600"
          id="userPoints"
        >
          0
        </p>
        <p class="text-center text-gray-600">Saldo Point</p>
      </div>
      <div class="space-y-2">
        <p>
          <span class="font-semibold">Nama:</span>
          <span id="userName">-</span>
        </p>
        <p>
          <span class="font-semibold">Email:</span>
          <span id="userEmail">-</span>
        </p>
        <p>
          <span class="font-semibold">Kode Referral:</span>
          <span
            class="select-all cursor-pointer text-blue-600 underline"
            id="userReferral"
          ></span>
          <button
            class="ml-2 text-sm text-gray-500 hover:text-blue-700 focus:outline-none"
            id="copyReferralBtn"
            title="Salin kode referral"
          >
            <i class="fas fa-copy"></i>
          </button>
        </p>
        <p>
          <span class="font-semibold">WhatsApp:</span>
          <span id="userWhatsapp">-</span>
        </p>
        <p>
          <span class="font-semibold">Created At:</span>
          <span id="userCreatedAt">-</span>
        </p>
      </div>
    </div>
  </div>
  <!-- Post Modal -->
  <div
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
    id="postModal"
  >
    <div
      class="bg-white rounded-lg max-w-md w-full p-6 space-y-4 relative"
    >
      <button
        aria-label="Close post modal"
        class="absolute top-3 right-3 text-gray-500 hover:text-red-600 focus:outline-none"
        id="closePostModal"
      >
        <i class="fas fa-times fa-lg"></i>
      </button>
      <h2 class="text-xl font-bold text-blue-700">Buat Postingan Baru</h2>
      <form class="space-y-4" id="postForm">
        <textarea
          class="w-full border border-gray-300 rounded p-2 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
          id="postText"
          placeholder="Tulis sesuatu..."
          required
          rows="4"
        ></textarea>
        <div>
          <label
            class="block mb-1 font-semibold text-gray-700 cursor-pointer"
            for="postImage"
            >Upload Gambar (opsional)</label
          >
          <input accept="image/*" class="w-full" id="postImage" type="file" />
        </div>
        <div class="flex justify-end space-x-2">
          <button
            class="px-4 py-2 rounded border border-gray-300 hover:border-red-500 text-gray-700 hover:text-red-600 focus:outline-none"
            id="cancelPostBtn"
            type="button"
          >
            Batal
          </button>
          <button
            class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none"
            type="submit"
          >
            Posting
          </button>
        </div>
      </form>
      <div class="text-sm text-red-600" id="postStatus"></div>
    </div>
  </div>
  <!-- Comment Modal -->
  <div
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 overflow-auto"
    id="commentModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="commentModalTitle"
  >
    <div
      class="bg-white rounded-lg max-w-3xl w-full p-6 space-y-4 relative max-h-[90vh] flex flex-col"
    >
      <header
        class="flex justify-between items-center border-b border-gray-300 pb-2"
      >
        <h2 class="text-xl font-bold text-blue-700 mx-auto" id="commentModalTitle">
          Komentar
        </h2>
        <button
          aria-label="Close comment modal"
          class="text-gray-500 hover:text-red-600 focus:outline-none"
          id="closeCommentModal"
        >
          <i class="fas fa-times fa-lg"></i>
        </button>
      </header>
      <div
        class="flex-grow overflow-y-auto space-y-4"
        id="commentList"
        tabindex="0"
        aria-live="polite"
        aria-relevant="additions"
      ></div>
      <form class="flex space-x-2 pt-4 border-t border-gray-200" id="commentForm">
        <input
          aria-label="Tulis komentar"
          class="flex-grow border border-gray-300 rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          id="commentInput"
          placeholder="Tulis komentar..."
          required
          type="text"
        />
        <button
          class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none"
          type="submit"
        >
          Kirim
        </button>
      </form>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      onSnapshot,
      deleteDoc,
      doc,
      addDoc,
      serverTimestamp,
      updateDoc,
      getDoc,
      orderBy,
      getDocs,
      setDoc,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23",
      storageBucket: "gmi-enterprise23.firebasestorage.app",
      messagingSenderId: "974090028804",
      appId: "1:974090028804:web:43ae563ffd9433463c7251",
      measurementId: "G-S27YB5Z8PR",
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    const db = getFirestore();

    // Elements
    const menuBtn = document.getElementById("menuBtn");
    const menuOptions = document.getElementById("menuOptions");
    const frame = document.getElementById("frame");
    const btnHome = document.getElementById("btnHome");
    const btnForum = document.getElementById("btnForum");
    const btnInfo = document.getElementById("btnInfo");
    const btnAbout = document.getElementById("btnAbout");
    const btnProfile = document.getElementById("btnProfile");
    const contentArea = document.getElementById("contentArea");
    const forumSection = document.getElementById("forumSection");
    const postContainer = document.getElementById("postContainer");
    const openPostBtn = document.getElementById("openPostBtn");
    const postModal = document.getElementById("postModal");
    const closePostModal = document.getElementById("closePostModal");
    const postForm = document.getElementById("postForm");
    const postText = document.getElementById("postText");
    const postImage = document.getElementById("postImage");
    const postStatus = document.getElementById("postStatus");
    const profileModal = document.getElementById("profileModal");
    const closeProfileModal = document.getElementById("closeProfileModal");
    const userPoints = document.getElementById("userPoints");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const userReferral = document.getElementById("userReferral");
    const userWhatsapp = document.getElementById("userWhatsapp");
    const userCreatedAt = document.getElementById("userCreatedAt");
    const copyReferralBtn = document.getElementById("copyReferralBtn");
    const commentModal = document.getElementById("commentModal");
    const closeCommentModal = document.getElementById("closeCommentModal");
    const commentList = document.getElementById("commentList");
    const commentForm = document.getElementById("commentForm");
    const commentInput = document.getElementById("commentInput");

    let currentUser = null;
    let currentPostId = null;

    // Toggle menu options
    menuBtn.onclick = () => {
      menuOptions.classList.toggle("hidden");
    };

    // Close menu if clicked outside
    document.addEventListener("click", (e) => {
      if (!menuBtn.contains(e.target) && !menuOptions.contains(e.target)) {
        menuOptions.classList.add("hidden");
      }
    });

    // Load SPA pages in iframe
    window.loadPage = function (page) {
      forumSection.classList.add("hidden");
      contentArea.classList.remove("hidden");
      frame.src = page;
    };

    // Navigation buttons
    btnHome.onclick = () => {
      forumSection.classList.add("hidden");
      contentArea.classList.remove("hidden");
      frame.src = "home.html";
    };
    btnInfo.onclick = () => {
      forumSection.classList.add("hidden");
      contentArea.classList.remove("hidden");
      frame.src = "informasi.html";
    };
    btnAbout.onclick = () => {
      forumSection.classList.add("hidden");
      contentArea.classList.remove("hidden");
      frame.src = "tentang.html";
    };
    btnForum.onclick = () => {
      contentArea.classList.add("hidden");
      forumSection.classList.remove("hidden");
      loadForumPosts();
    };
    btnProfile.onclick = () => {
      if (!currentUser) return;
      profileModal.classList.remove("hidden");
      loadUserProfile();
    };

    closeProfileModal.onclick = () => {
      profileModal.classList.add("hidden");
    };

    // Copy referral code
    copyReferralBtn.onclick = () => {
      if (userReferral.textContent) {
        navigator.clipboard.writeText(userReferral.textContent).then(() => {
          alert("Kode referral berhasil disalin!");
        });
      }
    };

    // Open post modal
    openPostBtn.onclick = () => {
      postStatus.textContent = "";
      postText.value = "";
      postImage.value = "";
      postModal.classList.remove("hidden");
    };

    closePostModal.onclick = () => {
      postModal.classList.add("hidden");
    };

    // Comment modal close
    closeCommentModal.onclick = () => {
      commentModal.classList.add("hidden");
      commentList.innerHTML = "";
      commentInput.value = "";
      currentPostId = null;
    };

    // Auth state check and redirect if not logged in
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      // Check if user data exists in Firestore, if not create
      const userDocRef = doc(db, "users", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      if (!userDocSnap.exists()) {
        // Create user data with referral code (random 8 chars)
        const referralCode = generateReferralCode();
        await setUserData(
          user.uid,
          user.displayName || "User",
          user.email || "",
          referralCode
        );
      }
      // Load profile data if profile modal is open
      if (!profileModal.classList.contains("hidden")) {
        loadUserProfile();
      }
      // Load forum posts if forum is active
      if (!forumSection.classList.contains("hidden")) {
        loadForumPosts();
      }
    });

    // Generate random referral code 8 uppercase alphanumeric
    function generateReferralCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Set user data in Firestore
    async function setUserData(uid, name, email, referral) {
      const userDocRef = doc(db, "users", uid);
      await setDoc(userDocRef, {
        fullName: name,
        email: email,
        refferal: referral,
        saldoPoint: 0,
        whatsapp: "",
        createdAt: serverTimestamp(),
      });
    }

    // Load user profile data
    async function loadUserProfile() {
      if (!currentUser) return;
      const userDocRef = doc(db, "users", currentUser.uid);
      const userDocSnap = await getDoc(userDocRef);
      if (userDocSnap.exists()) {
        const data = userDocSnap.data();
        userPoints.textContent = data.saldoPoint ?? 0;
        userName.textContent = data.fullName ?? "-";
        userEmail.textContent = data.email ?? "-";
        userReferral.textContent = data.refferal ?? "-";
        userWhatsapp.textContent = data.whatsapp ?? "-";
        userCreatedAt.textContent = data.createdAt?.toDate
          ? data.createdAt.toDate().toLocaleString()
          : "-";
      }
    }

    // Load forum posts from Firestore
    async function loadForumPosts() {
      postContainer.innerHTML = "";
      const q = query(collection(db, "statuses"), orderBy("timestamp", "desc"));
      onSnapshot(q, async (snapshot) => {
        postContainer.innerHTML = "";
        const now = Date.now();
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const postTime = data.timestamp?.seconds ? data.timestamp.seconds * 1000 : 0;
          const isExpired = now - postTime > 86400000;
          if (isExpired) {
            await deleteDoc(doc(db, "statuses", docSnap.id));
            continue;
          }
          const postEl = await createPostElement(docSnap.id, data, postTime);
          postContainer.appendChild(postEl);
        }
      });
    }

    // Create post element for forum
    async function createPostElement(id, data, postTime) {
      const post = document.createElement("article");
      post.className = "bg-white p-4 rounded shadow space-y-2";

      // Header: user name and timestamp
      const header = document.createElement("header");
      header.className = "text-gray-900 font-semibold";
      header.textContent = data.fullName || "User";

      const subHeader = document.createElement("div");
      subHeader.className = "text-xs text-gray-500";
      const d = new Date(postTime);
      const jam =
        d.getHours().toString().padStart(2, "0") +
        ":" +
        d.getMinutes().toString().padStart(2, "0");
      const tanggal = d.getDate().toString().padStart(2, "0");
      const bulan = d.toLocaleString("id-ID", { month: "long" });
      const tahun = d.getFullYear();
      subHeader.textContent = `dibuat pada jam ${jam}, ${tanggal} ${bulan} ${tahun}`;

      // Description text
      const desc = document.createElement("p");
      desc.className = "text-gray-800 whitespace-pre-wrap";
      desc.textContent = data.deskripsi || "";

      // Image if exists
      let img = null;
      if (data.gambar) {
        img = document.createElement("img");
        img.src = data.gambar;
        img.alt = `Gambar postingan oleh ${data.fullName || "user"} berisi ${
          data.deskripsi || "gambar postingan"
        }`;
        img.className = "rounded max-h-64 w-full object-contain mt-2";
      }

      // Actions container
      const actions = document.createElement("div");
      actions.className = "flex gap-6 text-sm text-blue-600";

      // Like button with count
      const btnLike = document.createElement("button");
      btnLike.className = "hover:underline focus:outline-none flex items-center gap-1";
      btnLike.type = "button";
      const likeIcon = document.createElement("i");
      likeIcon.className = "fas fa-thumbs-up";
      btnLike.appendChild(likeIcon);
      const likeCountSpan = document.createElement("span");
      likeCountSpan.textContent = data.likeCount ?? 0;
      btnLike.appendChild(likeCountSpan);
      btnLike.onclick = async () => {
        if (!currentUser) {
          alert("Silakan login terlebih dahulu.");
          return;
        }
        // Increment likeCount and also add user uid to likedBy array to prevent multiple likes
        const postRef = doc(db, "statuses", id);
        const postSnap = await getDoc(postRef);
        if (!postSnap.exists()) return;
        const postData = postSnap.data();
        const likedBy = postData.likedBy || [];
        if (likedBy.includes(currentUser.uid)) {
          alert("Anda sudah menyukai postingan ini.");
          return;
        }
        await updateDoc(postRef, {
          likeCount: (postData.likeCount || 0) + 1,
          likedBy: [...likedBy, currentUser.uid],
        });
      };

      // Komentar button
      const btnKomentar = document.createElement("button");
      btnKomentar.textContent = "Komentar";
      btnKomentar.className = "hover:underline focus:outline-none";
      btnKomentar.type = "button";
      btnKomentar.onclick = () => openKomentar(id);

      // Report dropdown
      const reportWrapper = document.createElement("div");
      reportWrapper.className = "relative";

      const btnReport = document.createElement("button");
      btnReport.textContent = "Laporkan";
      btnReport.className = "hover:underline focus:outline-none";
      btnReport.type = "button";
      btnReport.onclick = (e) => {
        e.stopPropagation();
        toggleReportOptions(id, reportWrapper);
      };

      const reportOptions = document.createElement("div");
      reportOptions.className =
        "hidden absolute right-0 mt-1 w-48 bg-white border border-gray-300 rounded shadow-md z-50";
      reportOptions.innerHTML = `
        <button data-type="spam" class="block w-full text-left px-3 py-2 text-sm hover:bg-red-100">Spam</button>
        <button data-type="verbal" class="block w-full text-left px-3 py-2 text-sm hover:bg-red-100">Kekerasan Verbal</button>
        <button data-type="lain" class="block w-full text-left px-3 py-2 text-sm hover:bg-red-100">Lain-lain</button>
      `;
      reportWrapper.appendChild(btnReport);
      reportWrapper.appendChild(reportOptions);

      // Close report options if clicked outside
      document.addEventListener("click", () => {
        reportOptions.classList.add("hidden");
      });

      // Report option click handler
      reportOptions.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", () => {
          const type = btn.getAttribute("data-type");
          sendReport(id, type);
          reportOptions.classList.add("hidden");
        });
      });

      actions.appendChild(btnLike);
      actions.appendChild(btnKomentar);
      actions.appendChild(reportWrapper);

      post.appendChild(header);
      post.appendChild(subHeader);
      post.appendChild(desc);
      if (img) post.appendChild(img);
      post.appendChild(actions);

      return post;
    }

    // Toggle report options visibility
    function toggleReportOptions(postId, wrapper) {
      const options = wrapper.querySelector("div");
      if (options.classList.contains("hidden")) {
        options.classList.remove("hidden");
      } else {
        options.classList.add("hidden");
      }
    }

    // Send report to WhatsApp
    function sendReport(postId, type) {
      const waNumber = "628119118047";
      const text = encodeURIComponent(
        `Laporkan postingan ID: ${postId} dengan tipe laporan: ${type}`
      );
      window.open(`https://wa.me/${waNumber}?text=${text}`, "_blank");
    }

    // Open komentar modal and load comments
    async function openKomentar(postId) {
      if (!currentUser) {
        alert("Silakan login terlebih dahulu.");
        return;
      }
      currentPostId = postId;
      commentList.innerHTML = "";
      commentInput.value = "";
      commentModal.classList.remove("hidden");
      commentModal.classList.add("show");
      await loadComments(postId);
      commentInput.focus();
    }

    // Load comments for a post
    async function loadComments(postId) {
      commentList.innerHTML = "";
      const commentsRef = collection(db, "statuses", postId, "comments");
      const q = query(commentsRef, orderBy("timestamp", "asc"));
      onSnapshot(q, async (snapshot) => {
        commentList.innerHTML = "";
        for (const docSnap of snapshot.docs) {
          const comment = docSnap.data();
          comment.id = docSnap.id;
          const commentEl = await createCommentElement(comment, postId);
          commentList.appendChild(commentEl);
        }
        commentList.scrollTop = commentList.scrollHeight;
      });
    }

    // Create comment element with replies
    async function createCommentElement(comment, postId, level = 0) {
      const container = document.createElement("div");
      container.className = `border rounded p-2 bg-gray-50 ${
        level > 0 ? "ml-6" : ""
      }`;

      const header = document.createElement("div");
      header.className = "text-gray-900 font-semibold";
      header.textContent = comment.fullName || comment.nama || "User";

      const subHeader = document.createElement("div");
      subHeader.className = "text-xs text-gray-500";
      if (comment.timestamp?.seconds) {
        const d = new Date(comment.timestamp.seconds * 1000);
        const jam =
          d.getHours().toString().padStart(2, "0") +
          ":" +
          d.getMinutes().toString().padStart(2, "0");
        const tanggal = d.getDate().toString().padStart(2, "0");
        const bulan = d.toLocaleString("id-ID", { month: "long" });
        const tahun = d.getFullYear();
        subHeader.textContent = `dibuat pada jam ${jam}, ${tanggal} ${bulan} ${tahun}`;
      } else {
        subHeader.textContent = "";
      }

      const textP = document.createElement("p");
      textP.className = "mt-1 text-gray-800 whitespace-pre-wrap";
      textP.textContent = comment.text || "";

      // Reply button
      const actions = document.createElement("div");
      actions.className = "flex gap-4 text-xs text-blue-600 mt-1";

      const btnReply = document.createElement("button");
      btnReply.textContent = "Reply";
      btnReply.className = "hover:underline focus:outline-none";
      btnReply.type = "button";
      btnReply.onclick = () => openReplyInput(container, comment.id, postId);

      actions.appendChild(btnReply);

      container.appendChild(header);
      container.appendChild(subHeader);
      container.appendChild(textP);
      container.appendChild(actions);

      // Replies container
      const repliesContainer = document.createElement("div");
      repliesContainer.className = "mt-2 space-y-2";

      // Load replies subcollection
      const repliesRef = collection(
        db,
        "statuses",
        postId,
        "comments",
        comment.id,
        "replies"
      );
      const qReplies = query(repliesRef, orderBy("timestamp", "asc"));
      const repliesSnapshot = await getDocs(qReplies);
      for (const replyDoc of repliesSnapshot.docs) {
        const reply = replyDoc.data();
        reply.id = replyDoc.id;
        const replyEl = await createCommentElement(reply, postId, level + 1);
        repliesContainer.appendChild(replyEl);
      }
      if (repliesContainer.children.length > 0) {
        container.appendChild(repliesContainer);
      }

      return container;
    }

    // Open reply input below a comment
    function openReplyInput(container, commentId, postId) {
      // Prevent multiple reply inputs
      if (container.querySelector(".reply-input")) return;

      const replyForm = document.createElement("form");
      replyForm.className = "reply-input flex space-x-2 mt-2";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Tulis balasan...";
      input.required = true;
      input.className =
        "flex-grow border border-gray-300 rounded p-1 focus:outline-none focus:ring-2 focus:ring-blue-500";

      const btnSend = document.createElement("button");
      btnSend.type = "submit";
      btnSend.textContent = "Kirim";
      btnSend.className =
        "px-3 rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none";

      replyForm.appendChild(input);
      replyForm.appendChild(btnSend);

      replyForm.onsubmit = async (e) => {
        e.preventDefault();
        if (!currentUser) {
          alert("Silakan login terlebih dahulu.");
          return;
        }
        const replyText = input.value.trim();
        if (!replyText) return;
        // Add reply to Firestore under comment's replies subcollection
        const repliesRef = collection(
          db,
          "statuses",
          postId,
          "comments",
          commentId,
          "replies"
        );
        await addDoc(repliesRef, {
          uid: currentUser.uid,
          fullName: currentUser.displayName || "User",
          text: replyText,
          timestamp: serverTimestamp(),
        });
        input.value = "";
        replyForm.remove();
      };

      container.appendChild(replyForm);
      input.focus();
    }

    // Submit new comment to post
    commentForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser || !currentPostId) {
        alert("Silakan login terlebih dahulu.");
        return;
      }
      const text = commentInput.value.trim();
      if (!text) return;
      const commentsRef = collection(db, "statuses", currentPostId, "comments");
      await addDoc(commentsRef, {
        uid: currentUser.uid,
        fullName: currentUser.displayName || "User",
        text,
        timestamp: serverTimestamp(),
      });
      commentInput.value = "";
    };

    // Post form submit handler
    postForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Silakan login terlebih dahulu.");
        return;
      }
      postStatus.textContent = "";
      const text = postText.value.trim();
      if (!text) {
        postStatus.textContent = "Teks postingan tidak boleh kosong.";
        return;
      }
      postStatus.textContent = "Mengirim postingan...";
      let imageUrl = "";
      if (postImage.files.length > 0) {
        try {
          imageUrl = await uploadImageToImgur(postImage.files[0]);
        } catch (err) {
          postStatus.textContent = "Gagal mengupload gambar: " + err.message;
          return;
        }
      }
      try {
        await addDoc(collection(db, "statuses"), {
          uid: currentUser.uid,
          fullName: currentUser.displayName || "User",
          deskripsi: text,
          gambar: imageUrl,
          timestamp: serverTimestamp(),
          likeCount: 0,
          likedBy: [],
        });
        postStatus.textContent = "Postingan berhasil dikirim.";
        postText.value = "";
        postImage.value = "";
        postModal.classList.add("hidden");
        if (!forumSection.classList.contains("hidden")) {
          loadForumPosts();
        }
      } catch (err) {
        postStatus.textContent = "Gagal mengirim postingan: " + err.message;
      }
    };

    // Upload image to Imgur
    async function uploadImageToImgur(file) {
      const clientId = "0f3d0dc555fdb38";
      const formData = new FormData();
      formData.append("image", file);
      const res = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: `Client-ID ${clientId}`,
        },
        body: formData,
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.data.error || "Upload gagal");
      return data.data.link;
    }
  </script>
</body>
</html>
