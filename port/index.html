<html class="scroll-smooth" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   GMI Official App
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
  <style>
   body {
      font-family: 'Inter', sans-serif;
    }
    /* Scrollbar for modal comments */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(100, 100, 100, 0.5);
      border-radius: 3px;
    }
  </style>
 </head>
 <body class="bg-gray-50 min-h-screen flex flex-col">
  <script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    orderBy,
    limit,
    onSnapshot,
    addDoc,
    serverTimestamp,
    doc,
    updateDoc,
    arrayUnion,
    arrayRemove,
    deleteDoc,
    getDoc,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
    authDomain: "gmi-enterprise23.firebaseapp.com",
    projectId: "gmi-enterprise23",
    storageBucket: "gmi-enterprise23.firebasestorage.app",
    messagingSenderId: "974090028804",
    appId: "1:974090028804:web:43ae563ffd9433463c7251",
    measurementId: "G-S27YB5Z8PR",
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Global state
  let currentUser = null;
  let userData = null;
  let statusesUnsub = null;
  let commentsUnsubMap = new Map();

  // Elements
  const headerRightBtn = document.getElementById("header-options-btn");
  const headerOptionsMenu = document.getElementById("header-options-menu");
  const aboutAppContent = document.getElementById("aboutapp-content");
  const mainContent = document.getElementById("main-content");
  const footerButtons = document.querySelectorAll(".footer-btn");
  const iframeContainer = document.getElementById("iframe-container");
  const forumContainer = document.getElementById("forum-container");
  const profileContainer = document.getElementById("profile-container");
  const postInputBox = document.getElementById("post-input-box");
  const postInputArea = document.getElementById("post-input-area");
  const postImageInput = document.getElementById("post-image-input");
  const postSubmitBtn = document.getElementById("post-submit-btn");
  const commentsModal = document.getElementById("comments-modal");
  const commentsModalCloseBtn = document.getElementById("comments-modal-close");
  const commentsModalHeader = document.getElementById("comments-modal-header");
  const commentsList = document.getElementById("comments-list");
  const commentInput = document.getElementById("comment-input");
  const commentSendBtn = document.getElementById("comment-send-btn");
  const reportModal = document.getElementById("report-modal");
  const reportModalCloseBtn = document.getElementById("report-modal-close");
  const reportOptions = document.getElementById("report-options");
  const reportSendBtn = document.getElementById("report-send-btn");
  const reportReasonSelect = document.getElementById("report-reason-select");
  const referralCopyBtn = document.getElementById("referral-copy-btn");
  const userPointsText = document.getElementById("user-points-text");
  const userNameText = document.getElementById("user-name-text");
  const userEmailText = document.getElementById("user-email-text");
  const userReferralText = document.getElementById("user-referral-text");
  const loadingOverlay = document.getElementById("loading-overlay");

  // SPA pages
  const SPA_PAGES = {
    settings: `<div class="p-6 max-w-xl mx-auto text-gray-700">
      <h2 class="text-2xl font-semibold mb-4">Settings</h2>
      <p>Settings page content coming soon.</p>
    </div>`,
    contact: `<div class="p-6 max-w-xl mx-auto text-gray-700">
      <h2 class="text-2xl font-semibold mb-4">Contact</h2>
      <p>You can contact us at <a href="mailto:support@gmi.com" class="text-blue-600 underline">support@gmi.com</a>.</p>
    </div>`,
    aboutapp: `<div class="p-6 max-w-3xl mx-auto text-gray-800 space-y-6">
      <h2 class="text-3xl font-bold mb-4 text-center">Privacy Policy & Terms</h2>
      <section>
        <h3 class="text-xl font-semibold mb-2">Privacy Policy (Kebijakan Privasi)</h3>
        <p>Menjelaskan bagaimana data pengguna dikumpulkan, digunakan, dan dilindungi. Kami menghargai privasi Anda dan berkomitmen untuk melindungi informasi pribadi Anda sesuai dengan peraturan yang berlaku.</p>
      </section>
      <section>
        <h3 class="text-xl font-semibold mb-2">Terms of Service / Terms and Conditions (Syarat dan Ketentuan)</h3>
        <p>Menetapkan aturan dan batasan penggunaan layanan. Dengan menggunakan aplikasi ini, Anda setuju untuk mematuhi syarat dan ketentuan yang berlaku.</p>
      </section>
      <section>
        <h3 class="text-xl font-semibold mb-2">Cookie Policy</h3>
        <p>Informasi tentang penggunaan cookie, pelacakan, dan opsi persetujuan pengguna. Kami menggunakan cookie untuk meningkatkan pengalaman pengguna dan menganalisis penggunaan aplikasi.</p>
      </section>
      <section>
        <h3 class="text-xl font-semibold mb-2">Disclaimer (Penafian)</h3>
        <p>Menjelaskan batas tanggung jawab, terutama untuk layanan informasi atau konsultasi. Informasi yang disediakan dalam aplikasi ini adalah untuk tujuan umum dan bukan pengganti nasihat profesional.</p>
      </section>
      <section>
        <h3 class="text-xl font-semibold mb-2">End-User License Agreement (EULA)</h3>
        <p>Perjanjian lisensi antara pengembang dan pengguna akhir aplikasi. Dengan menggunakan aplikasi ini, Anda setuju dengan ketentuan lisensi yang ditetapkan.</p>
      </section>
    </div>`,
    newsupdates: `<div class="p-6 max-w-xl mx-auto text-gray-700">
      <h2 class="text-2xl font-semibold mb-4">News or Updates</h2>
      <ul class="list-disc list-inside space-y-2">
        <li>Update 1: New features added to the app.</li>
        <li>Update 2: Bug fixes and performance improvements.</li>
        <li>Update 3: Upcoming events and announcements.</li>
        <li>Update 4: Community guidelines updated.</li>
        <li>Update 5: New referral program launched.</li>
      </ul>
    </div>`,
  };

  // Redirect to login.html if not logged in
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;
    await loadUserData();
    initApp();
  });

  async function loadUserData() {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists()) {
      userData = userDoc.data();
    } else {
      // If user data not found, create minimal data
      userData = {
        fullName: currentUser.displayName || "User",
        email: currentUser.email,
        whatsapp: "",
        referral: "",
        address: "",
        createdAt: new Date(),
      };
      await setDoc(doc(db, "users", currentUser.uid), userData);
    }
  }

  // Header options toggle
  headerRightBtn.addEventListener("click", () => {
    headerOptionsMenu.classList.toggle("hidden");
  });

  // Close header options if clicked outside
  document.addEventListener("click", (e) => {
    if (
      !headerRightBtn.contains(e.target) &&
      !headerOptionsMenu.contains(e.target)
    ) {
      headerOptionsMenu.classList.add("hidden");
    }
  });

  // Handle header options SPA navigation
  headerOptionsMenu.querySelectorAll("button[data-spa]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const spaPage = btn.getAttribute("data-spa");
      if (spaPage === "@aboutapp") {
        showAboutApp();
      } else {
        showSPA(spaPage);
      }
      headerOptionsMenu.classList.add("hidden");
    });
  });

  // Show SPA content in mainContent
  function showSPA(page) {
    forumContainer.classList.add("hidden");
    profileContainer.classList.add("hidden");
    iframeContainer.classList.add("hidden");
    postInputBox.classList.add("hidden");
    mainContent.classList.remove("hidden");
    mainContent.innerHTML = SPA_PAGES[page] || "<p>Page not found.</p>";
  }

  // Show About App page
  function showAboutApp() {
    forumContainer.classList.add("hidden");
    profileContainer.classList.add("hidden");
    iframeContainer.classList.add("hidden");
    postInputBox.classList.add("hidden");
    mainContent.classList.remove("hidden");
    mainContent.innerHTML = SPA_PAGES.aboutapp;
  }

  // Footer buttons navigation
  footerButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      if (target === "home") {
        showHomeIframe();
      } else if (target === "forum") {
        showForum();
      } else if (target === "info") {
        showInfoIframe();
      } else if (target === "about") {
        showAboutIframe();
      } else if (target === "profile") {
        showProfile();
      }
    });
  });

  // Show home.html in iframe
  function showHomeIframe() {
    mainContent.classList.add("hidden");
    forumContainer.classList.add("hidden");
    profileContainer.classList.add("hidden");
    iframeContainer.classList.remove("hidden");
    iframeContainer.innerHTML = `<iframe src="home.html" class="w-full h-full border-0" title="Home Page"></iframe>`;
    postInputBox.classList.add("hidden");
  }

  // Show informasi.html in iframe
  function showInfoIframe() {
    mainContent.classList.add("hidden");
    forumContainer.classList.add("hidden");
    profileContainer.classList.add("hidden");
    iframeContainer.classList.remove("hidden");
    iframeContainer.innerHTML = `<iframe src="informasi.html" class="w-full h-full border-0" title="Informasi Page"></iframe>`;
    postInputBox.classList.add("hidden");
  }

  // Show tentang.html in iframe
  function showAboutIframe() {
    mainContent.classList.add("hidden");
    forumContainer.classList.add("hidden");
    profileContainer.classList.add("hidden");
    iframeContainer.classList.remove("hidden");
    iframeContainer.innerHTML = `<iframe src="tentang.html" class="w-full h-full border-0" title="Tentang Page"></iframe>`;
    postInputBox.classList.add("hidden");
  }

  // Show profile page
  function showProfile() {
    mainContent.classList.add("hidden");
    forumContainer.classList.add("hidden");
    iframeContainer.classList.add("hidden");
    profileContainer.classList.remove("hidden");
    postInputBox.classList.add("hidden");
    userPointsText.textContent = userData.points ? userData.points : "0";
    userNameText.textContent = userData.fullName || "";
    userEmailText.textContent = userData.email || "";
    userReferralText.textContent = userData.referral || "";
  }

  // Show forum page
  function showForum() {
    mainContent.classList.add("hidden");
    iframeContainer.classList.add("hidden");
    profileContainer.classList.add("hidden");
    forumContainer.classList.remove("hidden");
    postInputBox.classList.remove("hidden");
    loadForumPosts();
  }

  // Load forum posts from Firestore, only posts within 24 hours
  async function loadForumPosts() {
    if (statusesUnsub) {
      statusesUnsub();
      statusesUnsub = null;
    }
    forumContainer.innerHTML = `<p class="text-center text-gray-500 mt-6">Loading posts...</p>`;

    const now = Date.now();
    const cutoff = now - 24 * 60 * 60 * 1000;

    const statusesRef = collection(db, "statuses");
    const q = query(
      statusesRef,
      orderBy("timestamp", "desc")
    );

    statusesUnsub = onSnapshot(q, async (snapshot) => {
      // Filter posts older than 24 hours and delete them
      const batchDeletes = [];
      const posts = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (!data.timestamp) return;
        const ts = data.timestamp.toMillis();
        if (ts < cutoff) {
          batchDeletes.push(deleteDoc(doc(db, "statuses", docSnap.id)));
        } else {
          posts.push({ id: docSnap.id, ...data });
        }
      });
      if (batchDeletes.length > 0) {
        await Promise.all(batchDeletes);
      }
      renderForumPosts(posts);
    });
  }

  // Render forum posts
  function renderForumPosts(posts) {
    if (posts.length === 0) {
      forumContainer.innerHTML = `<p class="text-center text-gray-500 mt-6">No posts available.</p>`;
      return;
    }
    forumContainer.innerHTML = "";
    posts.forEach((post) => {
      const postDate = post.timestamp.toDate();
      const dateStr = postDate.toLocaleDateString("id-ID", {
        day: "2-digit",
        month: "long",
        year: "numeric",
      });
      const timeStr = postDate.toLocaleTimeString("id-ID", {
        hour: "2-digit",
        minute: "2-digit",
      });
      const postDiv = document.createElement("div");
      postDiv.className =
        "bg-white rounded-lg shadow p-4 mb-4 max-w-3xl mx-auto break-words";
      postDiv.dataset.postId = post.id;

      // Post header: user fullName, date, time
      const headerDiv = document.createElement("div");
      headerDiv.className = "mb-2";
      headerDiv.innerHTML = `
        <p class="font-semibold text-gray-800">${escapeHtml(post.fullName)}</p>
        <p class="text-xs text-gray-500">${timeStr}, ${dateStr}</p>
      `;

      // Post content text
      const contentP = document.createElement("p");
      contentP.className = "mt-2 text-gray-700 whitespace-pre-wrap";
      contentP.textContent = post.deskripsi || "";

      // Post image if exists
      let imgEl = null;
      if (post.gambar) {
        imgEl = document.createElement("img");
        imgEl.src = post.gambar;
        imgEl.alt = `User post image uploaded by ${escapeHtml(post.fullName)}`;
        imgEl.className = "mt-3 rounded max-h-96 w-full object-contain";
      }

      // Post actions: like, comment, report
      const actionsDiv = document.createElement("div");
      actionsDiv.className =
        "flex items-center justify-between mt-4 text-gray-600";

      // Like button and count
      const likeBtn = document.createElement("button");
      likeBtn.className =
        "flex items-center space-x-1 hover:text-blue-600 focus:outline-none";
      likeBtn.innerHTML = `<i class="fas fa-thumbs-up"></i> <span>${post.likeCount || 0}</span>`;
      likeBtn.title = "Like";
      likeBtn.addEventListener("click", () => {
        toggleLike(post.id);
      });

      // Comment button
      const commentBtn = document.createElement("button");
      commentBtn.className =
        "flex items-center space-x-1 hover:text-green-600 focus:outline-none";
      commentBtn.innerHTML = `<i class="fas fa-comment"></i> <span>Komentar</span>`;
      commentBtn.title = "Komentar";
      commentBtn.addEventListener("click", () => {
        openCommentsModal(post.id);
      });

      // Report button
      const reportBtn = document.createElement("button");
      reportBtn.className =
        "flex items-center space-x-1 hover:text-red-600 focus:outline-none";
      reportBtn.innerHTML = `<i class="fas fa-flag"></i> <span>Report</span>`;
      reportBtn.title = "Report";
      reportBtn.addEventListener("click", () => {
        openReportModal(post.id);
      });

      actionsDiv.appendChild(likeBtn);
      actionsDiv.appendChild(commentBtn);
      actionsDiv.appendChild(reportBtn);

      postDiv.appendChild(headerDiv);
      postDiv.appendChild(contentP);
      if (imgEl) postDiv.appendChild(imgEl);
      postDiv.appendChild(actionsDiv);

      forumContainer.appendChild(postDiv);
    });
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    if (!text) return "";
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Toggle like for a post
  async function toggleLike(postId) {
    if (!currentUser) return;
    const postRef = doc(db, "statuses", postId);
    const postSnap = await getDoc(postRef);
    if (!postSnap.exists()) return;
    const postData = postSnap.data();
    let likedBy = postData.likedBy || [];
    let likeCount = postData.likeCount || 0;
    if (likedBy.includes(currentUser.uid)) {
      // Unlike
      likedBy = likedBy.filter((uid) => uid !== currentUser.uid);
      likeCount = Math.max(0, likeCount - 1);
    } else {
      // Like
      likedBy.push(currentUser.uid);
      likeCount++;
    }
    await updateDoc(postRef, {
      likedBy,
      likeCount,
    });
  }

  // Open comments modal for a post
  let currentCommentPostId = null;
  commentsModalCloseBtn.addEventListener("click", closeCommentsModal);
  commentSendBtn.addEventListener("click", sendComment);

  function openCommentsModal(postId) {
    currentCommentPostId = postId;
    commentsModal.classList.remove("hidden");
    commentsList.innerHTML = `<p class="text-center text-gray-500 py-6">Loading comments...</p>`;
    loadComments(postId);
  }

  function closeCommentsModal() {
    commentsModal.classList.add("hidden");
    commentsList.innerHTML = "";
    commentInput.value = "";
    currentCommentPostId = null;
  }

  // Load comments and replies for a post
  async function loadComments(postId) {
    const commentsRef = collection(db, "statuses", postId, "comments");
    const q = query(commentsRef, orderBy("timestamp", "asc"));
    if (commentsUnsubMap.has(postId)) {
      commentsUnsubMap.get(postId)();
      commentsUnsubMap.delete(postId);
    }
    commentsUnsubMap.set(
      postId,
      onSnapshot(q, (snapshot) => {
        const comments = [];
        snapshot.forEach((docSnap) => {
          comments.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderComments(comments);
      })
    );
  }

  // Render comments and replies
  function renderComments(comments) {
    if (comments.length === 0) {
      commentsList.innerHTML = `<p class="text-center text-gray-500 py-6">Belum ada komentar.</p>`;
      return;
    }
    commentsList.innerHTML = "";
    comments.forEach((comment) => {
      const commentDate = comment.timestamp?.toDate();
      const dateStr = commentDate
        ? commentDate.toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric",
          })
        : "";
      const timeStr = commentDate
        ? commentDate.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
          })
        : "";
      const commentDiv = document.createElement("div");
      commentDiv.className = "mb-4 border-b border-gray-200 pb-2";

      // Comment header: user fullName, date, time
      const headerDiv = document.createElement("div");
      headerDiv.className = "flex justify-between items-center mb-1";
      headerDiv.innerHTML = `
        <p class="font-semibold text-gray-800">${escapeHtml(
          comment.fullName || "Anonymous"
        )}</p>
        <p class="text-xs text-gray-500">${timeStr}, ${dateStr}</p>
      `;

      // Comment text
      const textP = document.createElement("p");
      textP.className = "text-gray-700 whitespace-pre-wrap";
      textP.textContent = comment.text || "";

      // Reply button
      const replyBtn = document.createElement("button");
      replyBtn.className =
        "text-sm text-blue-600 hover:underline focus:outline-none mt-1";
      replyBtn.textContent = "Reply";
      replyBtn.addEventListener("click", () => {
        openReplyInput(comment.id);
      });

      // Replies container
      const repliesDiv = document.createElement("div");
      repliesDiv.className = "ml-6 mt-2 space-y-2";

      // Render replies if any
      if (comment.replies && Array.isArray(comment.replies)) {
        comment.replies.forEach((reply) => {
          const replyDate = reply.timestamp?.toDate();
          const rDateStr = replyDate
            ? replyDate.toLocaleDateString("id-ID", {
                day: "2-digit",
                month: "long",
                year: "numeric",
              })
            : "";
          const rTimeStr = replyDate
            ? replyDate.toLocaleTimeString("id-ID", {
                hour: "2-digit",
                minute: "2-digit",
              })
            : "";
          const replyDiv = document.createElement("div");
          replyDiv.className =
            "bg-gray-100 rounded p-2 border border-gray-300 break-words";
          replyDiv.innerHTML = `
            <p class="font-semibold text-gray-700">${escapeHtml(
              reply.fullName || "Anonymous"
            )}</p>
            <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(
              reply.text || ""
            )}</p>
            <p class="text-xs text-gray-500 text-right">${rTimeStr}, ${rDateStr}</p>
          `;
          repliesDiv.appendChild(replyDiv);
        });
      }

      commentDiv.appendChild(headerDiv);
      commentDiv.appendChild(textP);
      commentDiv.appendChild(replyBtn);
      commentDiv.appendChild(repliesDiv);

      commentsList.appendChild(commentDiv);
    });
  }

  // Open reply input below a comment
  function openReplyInput(commentId) {
    // Check if reply input already exists, remove if so
    const existingReplyInput = document.getElementById("reply-input-box");
    if (existingReplyInput) existingReplyInput.remove();

    // Find comment div
    const commentDiv = [...commentsList.children].find(
      (div) => div.dataset.commentId === commentId
    );
    // If not found, append to commentsList last
    const targetDiv = commentDiv || commentsList.lastChild;

    // Create reply input box
    const replyBox = document.createElement("div");
    replyBox.id = "reply-input-box";
    replyBox.className = "mt-2 flex space-x-2";

    const replyInput = document.createElement("input");
    replyInput.type = "text";
    replyInput.placeholder = "Tulis reply...";
    replyInput.className =
      "flex-grow border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500";

    const replySendBtn = document.createElement("button");
    replySendBtn.textContent = "Send";
    replySendBtn.className =
      "bg-blue-600 text-white px-4 rounded hover:bg-blue-700 focus:outline-none";
    replySendBtn.addEventListener("click", () => {
      sendReply(commentId, replyInput.value);
      replyInput.value = "";
      replyBox.remove();
    });

    replyBox.appendChild(replyInput);
    replyBox.appendChild(replySendBtn);

    if (targetDiv) {
      targetDiv.appendChild(replyBox);
      replyInput.focus();
    }
  }

  // Send comment to Firestore
  async function sendComment() {
    if (!currentCommentPostId) return;
    const text = commentInput.value.trim();
    if (!text) return;
    const commentsRef = collection(
      db,
      "statuses",
      currentCommentPostId,
      "comments"
    );
    await addDoc(commentsRef, {
      text,
      fullName: userData.fullName || "Anonymous",
      uid: currentUser.uid,
      timestamp: serverTimestamp(),
      replies: [],
    });
    commentInput.value = "";
  }

  // Send reply to a comment
  async function sendReply(commentId, text) {
    if (!currentCommentPostId || !commentId || !text.trim()) return;
    const commentRef = doc(
      db,
      "statuses",
      currentCommentPostId,
      "comments",
      commentId
    );
    const commentSnap = await getDoc(commentRef);
    if (!commentSnap.exists()) return;
    const commentData = commentSnap.data();
    const newReply = {
      text: text.trim(),
      fullName: userData.fullName || "Anonymous",
      uid: currentUser.uid,
      timestamp: serverTimestamp(),
    };
    const updatedReplies = commentData.replies ? [...commentData.replies] : [];
    updatedReplies.push(newReply);
    await updateDoc(commentRef, {
      replies: updatedReplies,
    });
  }

  // Report modal logic
  let currentReportPostId = null;
  reportModalCloseBtn.addEventListener("click", () => {
    reportModal.classList.add("hidden");
    reportReasonSelect.value = "";
  });
  reportSendBtn.addEventListener("click", () => {
    sendReport();
  });

  function openReportModal(postId) {
    currentReportPostId = postId;
    reportModal.classList.remove("hidden");
  }

  function sendReport() {
    const reason = reportReasonSelect.value;
    if (!reason) {
      alert("Please select a reason for reporting.");
      return;
    }
    // Open WhatsApp with prefilled message
    const waNumber = "+628119118047";
    const message = encodeURIComponent(
      `Report for post ID: ${currentReportPostId}\nReason: ${reason}`
    );
    window.open(`https://wa.me/${waNumber.replace(/\D/g, "")}?text=${message}`, "_blank");
    reportModal.classList.add("hidden");
    reportReasonSelect.value = "";
  }

  // Post input box logic
  postInputBox.addEventListener("click", () => {
    window.location.href = "update.html";
  });

  // Referral copy button
  referralCopyBtn.addEventListener("click", () => {
    if (!userReferralText.textContent) return;
    navigator.clipboard.writeText(userReferralText.textContent).then(() => {
      alert("Kode referral berhasil disalin!");
    });
  });

  // Initialize app default view
  function initApp() {
    showHomeIframe();
  }
  </script>
  <!-- Loading overlay -->
  <div class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden" id="loading-overlay">
   <i class="fas fa-spinner fa-spin text-4xl text-blue-600">
   </i>
  </div>
  <!-- Header -->
  <header class="flex items-center justify-between bg-white shadow px-4 py-3 sticky top-0 z-40">
   <div class="flex items-center space-x-3">
    <img alt="GMI Official Logo, stylized letters G M I in blue and white" class="w-10 h-10 rounded" height="40" loading="lazy" src="https://storage.googleapis.com/a1aa/image/840f54b7-f384-4cf0-98f1-fc6db0b6f9d4.jpg" width="40"/>
    <span class="font-semibold text-xl text-blue-700 select-none">
     gmi official
    </span>
   </div>
   <div class="relative">
    <button aria-label="Open options menu" class="text-2xl text-gray-600 hover:text-gray-900 focus:outline-none" id="header-options-btn" type="button">
     <i class="fas fa-ellipsis-v">
     </i>
    </button>
    <div aria-labelledby="header-options-btn" aria-orientation="vertical" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50" id="header-options-menu" role="menu" tabindex="-1">
     <div class="py-1" role="none">
      <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-spa="settings" role="menuitem" tabindex="-1" type="button">
       Settings
      </button>
      <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-spa="contact" role="menuitem" tabindex="-1" type="button">
       Contact
      </button>
      <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-spa="@aboutapp" role="menuitem" tabindex="-1" type="button">
       About Apps
      </button>
      <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-spa="rateus" role="menuitem" tabindex="-1" type="button">
       Rate Us
      </button>
      <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-spa="newsupdates" role="menuitem" tabindex="-1" type="button">
       News or Updates
      </button>
     </div>
    </div>
   </div>
  </header>
  <!-- Main content container -->
  <main class="flex-grow relative overflow-hidden">
   <!-- SPA main content -->
   <div class="hidden p-4 max-w-4xl mx-auto min-h-[calc(100vh-128px)] overflow-y-auto" id="main-content">
   </div>
   <!-- iframe container for home, info, about -->
   <div class="hidden w-full h-[calc(100vh-128px)]" id="iframe-container">
   </div>
   <!-- Forum container -->
   <section class="hidden p-4 max-w-4xl mx-auto min-h-[calc(100vh-168px)] overflow-y-auto" id="forum-container">
   </section>
   <!-- Profile container -->
   <section class="hidden p-6 max-w-md mx-auto min-h-[calc(100vh-168px)] bg-white rounded-lg shadow mt-4" id="profile-container">
    <h2 class="text-3xl font-extrabold text-blue-700 mb-6 text-center">
     Profil User
    </h2>
    <div class="mb-6 text-center">
     <p class="text-5xl font-extrabold text-gray-900" id="user-points-text">
      0
     </p>
     <p class="text-sm text-gray-500">
      Saldo Point
     </p>
    </div>
    <div class="space-y-4 text-gray-700">
     <div>
      <h3 class="font-semibold">
       Nama Lengkap
      </h3>
      <p class="text-lg" id="user-name-text">
      </p>
     </div>
     <div>
      <h3 class="font-semibold">
       Email
      </h3>
      <p class="text-lg break-all" id="user-email-text">
      </p>
     </div>
     <div>
      <h3 class="font-semibold flex items-center justify-between">
       Kode Referral
       <button class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 focus:outline-none" id="referral-copy-btn" type="button">
        Salin
       </button>
      </h3>
      <p class="text-lg break-all select-text" id="user-referral-text">
      </p>
     </div>
    </div>
   </section>
  </main>
  <!-- Post input box for forum -->
  <div class="fixed bottom-16 left-0 right-0 max-w-4xl mx-auto px-4" id="post-input-box">
   <div class="bg-white rounded-full shadow flex items-center px-4 py-3 cursor-pointer hover:shadow-md transition-shadow">
    <input class="flex-grow text-gray-700 text-lg focus:outline-none cursor-pointer" id="post-input-area" placeholder="Katakan sesuatu..." readonly="" type="text"/>
    <label class="ml-3 cursor-pointer text-gray-500 hover:text-gray-700" for="post-image-input" title="Upload gambar">
     <i class="fas fa-image text-2xl">
     </i>
    </label>
    <input accept="image/*" class="hidden" disabled="" id="post-image-input" type="file"/>
    <button class="ml-3 bg-blue-600 text-white px-4 py-2 rounded-full opacity-50 cursor-not-allowed" disabled="" id="post-submit-btn" type="button">
     Post
    </button>
   </div>
  </div>
  <!-- Comments modal -->
  <div aria-labelledby="comments-modal-header" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col justify-center items-center p-4 hidden z-50" id="comments-modal" role="dialog">
   <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] flex flex-col overflow-hidden">
    <header class="flex justify-between items-center border-b border-gray-300 px-4 py-3">
     <h3 class="text-xl font-semibold text-gray-800 text-center flex-grow" id="comments-modal-header">
      Komentar
     </h3>
     <button aria-label="Close comments modal" class="text-gray-600 hover:text-gray-900 focus:outline-none" id="comments-modal-close" type="button">
      <i class="fas fa-times text-2xl">
      </i>
     </button>
    </header>
    <main class="flex-grow overflow-y-auto p-4 scrollbar-thin" id="comments-list">
    </main>
    <footer class="border-t border-gray-300 px-4 py-3 flex space-x-2">
     <input class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="comment-input" placeholder="Tulis komentar..." type="text"/>
     <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none" id="comment-send-btn" type="button">
      Send
     </button>
    </footer>
   </div>
  </div>
  <!-- Report modal -->
  <div aria-labelledby="report-modal-header" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 hidden z-50" id="report-modal" role="dialog">
   <div class="bg-white rounded-lg max-w-md w-full p-6 space-y-4">
    <header class="flex justify-between items-center">
     <h3 class="text-xl font-semibold text-gray-800" id="report-modal-header">
      Laporkan Postingan
     </h3>
     <button aria-label="Close report modal" class="text-gray-600 hover:text-gray-900 focus:outline-none" id="report-modal-close" type="button">
      <i class="fas fa-times text-2xl">
      </i>
     </button>
    </header>
    <div>
     <label class="block font-semibold mb-2" for="report-reason-select">
      Pilih alasan laporan:
     </label>
     <select class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" id="report-reason-select">
      <option value="">
       -- Pilih alasan --
      </option>
      <option value="Spam">
       Spam
      </option>
      <option value="Kekerasan Verbal">
       Kekerasan Verbal
      </option>
      <option value="Konten Tidak Pantas">
       Konten Tidak Pantas
      </option>
      <option value="Lainnya">
       Lainnya
      </option>
     </select>
    </div>
    <div class="flex justify-end">
     <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 focus:outline-none" id="report-send-btn" type="button">
      Kirim
     </button>
    </div>
   </div>
  </div>
 </body>
</html>
