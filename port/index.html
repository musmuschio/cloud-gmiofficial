<html class="scroll-smooth" lang="id">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   GMI Official App
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
  <style>
   body {
      font-family: 'Inter', sans-serif;
    }
    /* Scrollbar for modal comments */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(100, 100, 100, 0.5);
      border-radius: 3px;
    }
  </style>
 </head>
 <body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="flex items-center justify-between bg-white shadow px-4 py-3 sticky top-0 z-50">
   <div class="flex items-center space-x-3">
    <img alt="Logo GMI Official, a stylized letter G with blue and green gradient" class="w-10 h-10 rounded" height="40" src="https://storage.googleapis.com/a1aa/image/58349bf2-2b1e-4995-120a-e500af541fc3.jpg" width="40"/>
    <span class="font-semibold text-xl text-gray-800 select-none">
     gmi official
    </span>
   </div>
   <div class="relative">
    <button aria-label="Open menu options" class="text-2xl text-gray-700 hover:text-gray-900 focus:outline-none" id="menuToggleBtn">
     <i class="fas fa-ellipsis-v">
     </i>
    </button>
    <div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50" id="menuOptions">
     <ul class="py-1 text-gray-700 text-sm">
      <li>
       <a class="block px-4 py-2 hover:bg-gray-100 cursor-pointer" data-spa="settings" href="#">
        Settings
       </a>
      </li>
      <li>
       <a class="block px-4 py-2 hover:bg-gray-100 cursor-pointer" data-spa="contact" href="#">
        Contact
       </a>
      </li>
      <li>
       <a class="block px-4 py-2 hover:bg-gray-100 cursor-pointer" data-spa="aboutapp" href="#">
        About Apps
       </a>
      </li>
      <li>
       <a class="block px-4 py-2 hover:bg-gray-100 cursor-pointer" data-spa="rateus" href="#">
        Rate Us
       </a>
      </li>
      <li>
       <a class="block px-4 py-2 hover:bg-gray-100 cursor-pointer" data-spa="news" href="#">
        News or Updates
       </a>
      </li>
     </ul>
    </div>
   </div>
  </header>
  <!-- Main SPA container -->
  <main class="flex-grow overflow-auto relative bg-white" id="app">
   <!-- Content will be injected here -->
  </main>
  <!-- Footer Navigation -->
  <footer class="bg-white border-t border-gray-200 flex justify-around items-center py-2 fixed bottom-0 left-0 right-0 z-40">
   <button aria-label="Beranda" class="flex flex-col items-center text-gray-600 hover:text-blue-600 focus:outline-none" id="btnHome">
    <i class="fas fa-home fa-lg">
    </i>
    <span class="text-xs mt-0.5">
     Beranda
    </span>
   </button>
   <button aria-label="Forum" class="flex flex-col items-center text-gray-600 hover:text-blue-600 focus:outline-none" id="btnForum">
    <i class="fas fa-comments fa-lg">
    </i>
    <span class="text-xs mt-0.5">
     Forum
    </span>
   </button>
   <button aria-label="Informasi" class="flex flex-col items-center text-gray-600 hover:text-blue-600 focus:outline-none" id="btnInfo">
    <i class="fas fa-info-circle fa-lg">
    </i>
    <span class="text-xs mt-0.5">
     Informasi
    </span>
   </button>
   <button aria-label="Tentang" class="flex flex-col items-center text-gray-600 hover:text-blue-600 focus:outline-none" id="btnAbout">
    <i class="fas fa-address-card fa-lg">
    </i>
    <span class="text-xs mt-0.5">
     Tentang
    </span>
   </button>
   <button aria-label="Profil" class="flex flex-col items-center text-gray-600 hover:text-blue-600 focus:outline-none" id="btnProfile">
    <i class="fas fa-user fa-lg">
    </i>
    <span class="text-xs mt-0.5">
     Profil
    </span>
   </button>
  </footer>
  <!-- Modal for Comments -->
  <div aria-labelledby="modalCommentsTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="modalComments" role="dialog">
   <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] flex flex-col">
    <header class="flex justify-between items-center border-b border-gray-200 px-4 py-2">
     <h2 class="text-lg font-semibold text-gray-800" id="modalCommentsTitle">
      Komentar
     </h2>
     <button aria-label="Close comments modal" class="text-gray-600 hover:text-gray-900 focus:outline-none text-xl" id="closeModalComments">
      Ã—
     </button>
    </header>
    <div class="flex-grow overflow-y-auto px-4 py-3 space-y-3 scrollbar-thin" id="commentsList">
     <!-- Comments will be dynamically inserted here -->
    </div>
    <form class="border-t border-gray-200 px-4 py-3 flex space-x-2" id="commentForm">
     <input autocomplete="off" class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="commentInput" placeholder="Tulis komentar..." required="" type="text"/>
     <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none" type="submit">
      Kirim
     </button>
    </form>
   </div>
  </div>
  <!-- Modal for Report -->
  <div aria-labelledby="modalReportTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="modalReport" role="dialog">
   <div class="bg-white rounded-lg max-w-md w-full p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-800" id="modalReportTitle">
     Laporkan Postingan
    </h2>
    <form class="space-y-4" id="reportForm">
     <fieldset>
      <legend class="font-semibold mb-2">
       Pilih alasan laporan:
      </legend>
      <div class="flex flex-col space-y-2">
       <label class="inline-flex items-center">
        <input class="form-radio" name="reportReason" required="" type="radio" value="Spam"/>
        <span class="ml-2">
         Spam
        </span>
       </label>
       <label class="inline-flex items-center">
        <input class="form-radio" name="reportReason" type="radio" value="Kekerasan Verbal"/>
        <span class="ml-2">
         Kekerasan Verbal
        </span>
       </label>
       <label class="inline-flex items-center">
        <input class="form-radio" name="reportReason" type="radio" value="Konten Tidak Pantas"/>
        <span class="ml-2">
         Konten Tidak Pantas
        </span>
       </label>
       <label class="inline-flex items-center">
        <input class="form-radio" name="reportReason" type="radio" value="Lainnya"/>
        <span class="ml-2">
         Lainnya
        </span>
       </label>
      </div>
     </fieldset>
     <div>
      <label class="block font-semibold mb-1" for="reportDetails">
       Detail (opsional):
      </label>
      <textarea class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="reportDetails" placeholder="Jelaskan lebih detail jika perlu" rows="3"></textarea>
     </div>
     <div class="flex justify-end space-x-3">
      <button class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100 focus:outline-none" id="cancelReportBtn" type="button">
       Batal
      </button>
      <button class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 focus:outline-none" type="submit">
       Kirim Laporan
      </button>
     </div>
    </form>
   </div>
  </div>
  <!-- Modal for Update Post -->
  <div aria-labelledby="modalUpdatePostTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="modalUpdatePost" role="dialog">
   <div class="bg-white rounded-lg max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-semibold mb-4 text-gray-800" id="modalUpdatePostTitle">
     Buat Postingan Baru
    </h2>
    <form class="space-y-4" id="updatePostForm">
     <div>
      <label class="block font-semibold mb-1" for="postText">
       Tulis sesuatu...
      </label>
      <textarea class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="postText" placeholder="Apa yang ingin Anda bagikan?" required="" rows="4"></textarea>
     </div>
     <div>
      <label class="block font-semibold mb-1" for="postImage">
       Upload Gambar (opsional)
      </label>
      <input accept="image/*" class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" id="postImage" type="file"/>
      <p class="text-xs text-gray-500 mt-1">
       Gambar akan diupload ke Imgur dan nama file akan disimpan di Firebase.
      </p>
     </div>
     <div class="flex justify-end space-x-3">
      <button class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100 focus:outline-none" id="cancelUpdatePostBtn" type="button">
       Batal
      </button>
      <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none" type="submit">
       Posting
      </button>
     </div>
    </form>
   </div>
  </div>
  <!-- Login Page -->
  <template id="loginPageTemplate">
   <div class="min-h-screen flex flex-col justify-center items-center bg-gray-50 px-4 py-8">
    <div class="w-full max-w-md bg-white rounded-lg shadow p-8">
     <h1 class="text-2xl font-semibold text-center mb-6 text-gray-800">
      Login
     </h1>
     <form class="space-y-5" id="loginForm">
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="loginUsername">
        Username
       </label>
       <input autocomplete="username" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="loginUsername" name="username" placeholder="Masukkan username" required="" type="text"/>
      </div>
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="loginPassword">
        Password
       </label>
       <input autocomplete="current-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="loginPassword" name="password" placeholder="Masukkan password" required="" type="password"/>
      </div>
      <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 focus:outline-none" type="submit">
       Login
      </button>
     </form>
     <div class="my-4 flex items-center justify-center space-x-3">
      <span class="border-b border-gray-300 w-1/5">
      </span>
      <span class="text-gray-500 text-sm">
       atau
      </span>
      <span class="border-b border-gray-300 w-1/5">
      </span>
     </div>
     <button class="w-full flex items-center justify-center space-x-3 border border-gray-300 rounded py-2 hover:bg-gray-100 focus:outline-none" id="googleLoginBtn">
      <img alt="Google logo, multicolor G letter" class="w-5 h-5" height="20" src="https://storage.googleapis.com/a1aa/image/81fcc7a4-0393-4408-0830-db068b1d5010.jpg" width="20"/>
      <span class="text-gray-700 font-semibold">
       Login dengan Google
      </span>
     </button>
     <p class="mt-6 text-center text-gray-600 text-sm">
      Belum punya akun?
      <button class="text-blue-600 font-semibold hover:underline focus:outline-none" id="goToRegisterBtn">
       Klik di sini!
      </button>
     </p>
    </div>
   </div>
  </template>
  <!-- Register Page -->
  <template id="registerPageTemplate">
   <div class="min-h-screen flex flex-col justify-center items-center bg-gray-50 px-4 py-8">
    <div class="w-full max-w-md bg-white rounded-lg shadow p-8">
     <h1 class="text-2xl font-semibold text-center mb-6 text-gray-800">
      Daftar Akun Baru
     </h1>
     <form class="space-y-5" id="registerForm">
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="registerFullName">
        Nama Lengkap
       </label>
       <input autocomplete="name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="registerFullName" name="fullname" placeholder="Masukkan nama lengkap" required="" type="text"/>
      </div>
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="registerAddress">
        Alamat
       </label>
       <textarea class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" id="registerAddress" name="address" placeholder="Masukkan alamat lengkap" required="" rows="2"></textarea>
      </div>
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="registerPassword">
        Password
       </label>
       <input autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="registerPassword" name="password" placeholder="Masukkan password" required="" type="password"/>
       <p class="text-xs text-red-600 mt-1">
        Tidak disarankan menggunakan sandi yang sama seperti sandi email atau sosial media.
       </p>
      </div>
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="registerPasswordVerify">
        Verifikasi Password
       </label>
       <input autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="registerPasswordVerify" name="passwordVerify" placeholder="Masukkan ulang password" required="" type="password"/>
      </div>
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="registerWhatsapp">
        Nomor WhatsApp
       </label>
       <input autocomplete="tel" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="registerWhatsapp" name="whatsapp" pattern="^\+?62[0-9]{8,15}$" placeholder="+6281234567890" required="" type="tel"/>
       <p class="text-xs text-gray-500 mt-1">
        Format nomor harus diawali +62 dan tanpa spasi.
       </p>
      </div>
      <div>
       <label class="block text-gray-700 font-semibold mb-1" for="registerReferral">
        Kode Referral (Opsional)
       </label>
       <input autocomplete="off" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="registerReferral" name="referral" placeholder="Masukkan kode referral jika ada" type="text"/>
      </div>
      <button class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 focus:outline-none" type="submit">
       Daftar
      </button>
     </form>
     <p class="mt-6 text-center text-gray-600 text-sm">
      Sudah punya akun?
      <button class="text-blue-600 font-semibold hover:underline focus:outline-none" id="goToLoginBtn">
       Klik di sini!
      </button>
     </p>
    </div>
   </div>
  </template>
  <!-- SPA Pages Templates -->
  <!-- Settings Page -->
  <template id="settingsPageTemplate">
   <div class="p-6 max-w-4xl mx-auto">
    <h1 class="text-3xl font-semibold mb-6 text-gray-800">
     Settings
    </h1>
    <p class="text-gray-700">
     Pengaturan aplikasi akan tersedia di sini.
    </p>
   </div>
  </template>
  <!-- Contact Page -->
  <template id="contactPageTemplate">
   <div class="p-6 max-w-4xl mx-auto">
    <h1 class="text-3xl font-semibold mb-6 text-gray-800">
     Contact
    </h1>
    <p class="text-gray-700">
     Hubungi kami melalui email: support@gmiofficial.id atau WhatsApp: +62 811-9118-047
    </p>
   </div>
  </template>
  <!-- About Apps Page -->
  <template id="aboutAppPageTemplate">
   <div class="p-6 max-w-4xl mx-auto space-y-8">
    <h1 class="text-3xl font-semibold mb-6 text-gray-800">
     About Apps
    </h1>
    <section>
     <h2 class="text-xl font-semibold mb-2">
      Privacy Policy (Kebijakan Privasi)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Menjelaskan bagaimana data pengguna dikumpulkan, digunakan, dan dilindungi. Kami berkomitmen untuk menjaga privasi Anda dan hanya menggunakan data sesuai kebutuhan layanan.
     </p>
    </section>
    <section>
     <h2 class="text-xl font-semibold mb-2">
      Terms of Service / Terms and Conditions (Syarat dan Ketentuan)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Menetapkan aturan dan batasan penggunaan layanan. Dengan menggunakan aplikasi ini, Anda setuju untuk mematuhi semua ketentuan yang berlaku.
     </p>
    </section>
    <section>
     <h2 class="text-xl font-semibold mb-2">
      Cookie Policy
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Informasi tentang penggunaan cookie, pelacakan, dan opsi persetujuan pengguna. Kami menggunakan cookie untuk meningkatkan pengalaman pengguna.
     </p>
    </section>
    <section>
     <h2 class="text-xl font-semibold mb-2">
      Disclaimer (Penafian)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Menjelaskan batas tanggung jawab, terutama untuk layanan informasi atau konsultasi. Informasi yang disediakan tidak menggantikan nasihat profesional.
     </p>
    </section>
    <section>
     <h2 class="text-xl font-semibold mb-2">
      End-User License Agreement (EULA)
     </h2>
     <p class="text-gray-700 leading-relaxed">
      Perjanjian lisensi antara pengembang dan pengguna akhir aplikasi. Penggunaan aplikasi ini tunduk pada ketentuan lisensi yang berlaku.
     </p>
    </section>
   </div>
  </template>
  <!-- Rate Us Page -->
  <template id="rateUsPageTemplate">
   <div class="p-6 max-w-4xl mx-auto text-center">
    <h1 class="text-3xl font-semibold mb-6 text-gray-800">
     Rate Us
    </h1>
    <p class="text-gray-700 mb-4">
     Jika Anda menyukai aplikasi ini, silakan berikan rating dan ulasan Anda.
    </p>
    <div class="flex justify-center space-x-2 text-yellow-400 text-4xl cursor-pointer" id="rateStars">
     <i class="far fa-star" data-star="1">
     </i>
     <i class="far fa-star" data-star="2">
     </i>
     <i class="far fa-star" data-star="3">
     </i>
     <i class="far fa-star" data-star="4">
     </i>
     <i class="far fa-star" data-star="5">
     </i>
    </div>
    <textarea class="mt-4 w-full max-w-md mx-auto border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none" id="rateReview" placeholder="Tulis ulasan Anda di sini..." rows="4"></textarea>
    <button class="mt-4 bg-yellow-400 text-white px-6 py-2 rounded hover:bg-yellow-500 focus:outline-none" id="submitRateBtn">
     Kirim Rating
    </button>
   </div>
  </template>
  <!-- News or Updates Page -->
  <template id="newsPageTemplate">
   <div class="p-6 max-w-4xl mx-auto space-y-6">
    <h1 class="text-3xl font-semibold mb-6 text-gray-800">
     News or Updates
    </h1>
    <article class="bg-white rounded-lg shadow p-4 border border-gray-200">
     <h2 class="text-xl font-semibold mb-2">
      Update 1: Peluncuran Aplikasi GMI Official
     </h2>
     <p class="text-gray-700 mb-2">
      Kami dengan bangga mengumumkan peluncuran resmi aplikasi GMI Official. Nikmati fitur-fitur terbaru dan kemudahan akses.
     </p>
     <time class="text-xs text-gray-500" datetime="2024-06-01">
      1 Juni 2024
     </time>
    </article>
    <article class="bg-white rounded-lg shadow p-4 border border-gray-200">
     <h2 class="text-xl font-semibold mb-2">
      Update 2: Fitur Forum Baru
     </h2>
     <p class="text-gray-700 mb-2">
      Forum kini mendukung komentar, like, dan laporan. Ayo bergabung dan berbagi cerita Anda!
     </p>
     <time class="text-xs text-gray-500" datetime="2024-06-10">
      10 Juni 2024
     </time>
    </article>
    <article class="bg-white rounded-lg shadow p-4 border border-gray-200">
     <h2 class="text-xl font-semibold mb-2">
      Update 3: Integrasi Imgur untuk Upload Gambar
     </h2>
     <p class="text-gray-700 mb-2">
      Kini Anda dapat mengupload gambar ke postingan dengan mudah melalui Imgur.
     </p>
     <time class="text-xs text-gray-500" datetime="2024-06-15">
      15 Juni 2024
     </time>
    </article>
    <article class="bg-white rounded-lg shadow p-4 border border-gray-200">
     <h2 class="text-xl font-semibold mb-2">
      Update 4: Sistem Poin dan Referral
     </h2>
     <p class="text-gray-700 mb-2">
      Dapatkan poin dengan mengajak teman menggunakan kode referral Anda.
     </p>
     <time class="text-xs text-gray-500" datetime="2024-06-20">
      20 Juni 2024
     </time>
    </article>
    <article class="bg-white rounded-lg shadow p-4 border border-gray-200">
     <h2 class="text-xl font-semibold mb-2">
      Update 5: Perbaikan Bug dan Peningkatan Performa
     </h2>
     <p class="text-gray-700 mb-2">
      Kami terus meningkatkan aplikasi agar lebih stabil dan cepat.
     </p>
     <time class="text-xs text-gray-500" datetime="2024-06-25">
      25 Juni 2024
     </time>
    </article>
   </div>
  </template>
  <!-- Home Page (iframe) -->
  <template id="homePageTemplate">
   <iframe class="w-full h-[calc(100vh-112px)] border-0" loading="lazy" src="home.html" title="Halaman Beranda GMI Official">
   </iframe>
  </template>
  <!-- Informasi Page (iframe) -->
  <template id="infoPageTemplate">
   <iframe class="w-full h-[calc(100vh-112px)] border-0" loading="lazy" src="informasi.html" title="Halaman Informasi GMI Official">
   </iframe>
  </template>
  <!-- Tentang Page (iframe) -->
  <template id="aboutPageTemplate">
   <iframe class="w-full h-[calc(100vh-112px)] border-0" loading="lazy" src="tentang.html" title="Halaman Tentang GMI Official">
   </iframe>
  </template>
  <!-- Forum Page -->
  <template id="forumPageTemplate">
   <div class="max-w-4xl mx-auto p-4 pb-20">
    <div aria-label="Klik untuk membuat postingan baru" class="mb-6 p-4 bg-white rounded-lg shadow border border-gray-300 cursor-pointer text-gray-500 hover:bg-gray-50" id="postInputBox" role="button" tabindex="0">
     Katakan sesuatu...
    </div>
    <div class="space-y-6" id="postsContainer">
     <!-- Posts will be dynamically inserted here -->
    </div>
   </div>
  </template>
  <!-- Profile Page -->
  <template id="profilePageTemplate">
   <div class="max-w-md mx-auto p-6 bg-white rounded-lg shadow mt-6">
    <h1 class="text-3xl font-semibold mb-6 text-gray-800 text-center">
     Profil Saya
    </h1>
    <div class="text-center mb-6">
     <div class="text-5xl font-extrabold text-blue-600" id="profilePoints">
      0
     </div>
     <div class="text-gray-600 text-sm">
      Saldo Point
     </div>
    </div>
    <div class="space-y-4 text-gray-700">
     <div>
      <span class="font-semibold">
       Nama:
      </span>
      <span id="profileName">
       -
      </span>
     </div>
     <div>
      <span class="font-semibold">
       Email:
      </span>
      <span id="profileEmail">
       -
      </span>
     </div>
     <div>
      <span class="font-semibold">
       Kode Referral:
      </span>
      <div class="flex items-center space-x-2 mt-1">
       <input class="flex-grow border border-gray-300 rounded px-3 py-2 bg-gray-100 text-gray-700 select-all" id="profileReferralCode" readonly="" type="text"/>
       <button aria-label="Salin kode referral" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 focus:outline-none" id="copyReferralBtn">
        <i class="fas fa-copy">
        </i>
       </button>
      </div>
     </div>
    </div>
   </div>
  </template>
  <!-- Firebase and App Script -->
  <script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      GoogleAuthProvider,
      signInWithPopup,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      query,
      where,
      orderBy,
      limit,
      onSnapshot,
      serverTimestamp,
      deleteDoc,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23",
      storageBucket: "gmi-enterprise23.firebasestorage.app",
      messagingSenderId: "974090028804",
      appId: "1:974090028804:web:43ae563ffd9433463c7251",
      measurementId: "G-S27YB5Z8PR",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Imgur Client ID
    const IMGUR_CLIENT_ID = "0f3d0dc555fdb38";

    // DOM references
    const appContainer = document.getElementById("app");
    const menuToggleBtn = document.getElementById("menuToggleBtn");
    const menuOptions = document.getElementById("menuOptions");

    // State
    let currentUser = null;
    let currentPage = null;
    let postsUnsubscribe = null;
    let commentsUnsubscribe = null;
    let currentPostIdForComments = null;

    // Utility: Generate referral code (random 8 chars alphanumeric uppercase)
    function generateReferralCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Utility: Format date/time for posts
    function formatDateTime(timestamp) {
      const d = timestamp.toDate();
      return d.toLocaleDateString("id-ID") + " " + d.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
    }

    // Utility: Format relative time (for 24h post expiration)
    function timeSince(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return seconds + " detik lalu";
      const intervals = [
        { label: "menit", seconds: 60 },
        { label: "jam", seconds: 3600 },
        { label: "hari", seconds: 86400 },
      ];
      let counter;
      for (let i = intervals.length - 1; i >= 0; i--) {
        counter = Math.floor(seconds / intervals[i].seconds);
        if (counter > 0) {
          return counter + " " + intervals[i].label + " lalu";
        }
      }
      return "Baru saja";
    }

    // Show/hide menu options
    menuToggleBtn.addEventListener("click", () => {
      if (menuOptions.classList.contains("hidden")) {
        menuOptions.classList.remove("hidden");
      } else {
        menuOptions.classList.add("hidden");
      }
    });

    // Close menu if clicked outside
    document.addEventListener("click", (e) => {
      if (!menuToggleBtn.contains(e.target) && !menuOptions.contains(e.target)) {
        menuOptions.classList.add("hidden");
      }
    });

    // SPA navigation from menu options
    menuOptions.querySelectorAll("a[data-spa]").forEach((el) => {
      el.addEventListener("click", (e) => {
        e.preventDefault();
        const page = el.getAttribute("data-spa");
        menuOptions.classList.add("hidden");
        navigateTo(page);
      });
    });

    // SPA navigation buttons in footer
    document.getElementById("btnHome").addEventListener("click", () => navigateTo("home"));
    document.getElementById("btnForum").addEventListener("click", () => navigateTo("forum"));
    document.getElementById("btnInfo").addEventListener("click", () => navigateTo("info"));
    document.getElementById("btnAbout").addEventListener("click", () => navigateTo("about"));
    document.getElementById("btnProfile").addEventListener("click", () => navigateTo("profile"));

    // Navigation function
    async function navigateTo(page) {
      if (!currentUser && page !== "login" && page !== "register") {
        // Redirect to login if not logged in
        page = "login";
      }
      currentPage = page;
      appContainer.innerHTML = "";
      if (postsUnsubscribe) {
        postsUnsubscribe();
        postsUnsubscribe = null;
      }
      if (commentsUnsubscribe) {
        commentsUnsubscribe();
        commentsUnsubscribe = null;
      }
      switch (page) {
        case "login":
          renderLoginPage();
          break;
        case "register":
          renderRegisterPage();
          break;
        case "settings":
          renderTemplate("settingsPageTemplate");
          break;
        case "contact":
          renderTemplate("contactPageTemplate");
          break;
        case "aboutapp":
          renderTemplate("aboutAppPageTemplate");
          break;
        case "rateus":
          renderTemplate("rateUsPageTemplate");
          setupRateUs();
          break;
        case "news":
          renderTemplate("newsPageTemplate");
          break;
        case "home":
          renderTemplate("homePageTemplate");
          break;
        case "info":
          renderTemplate("infoPageTemplate");
          break;
        case "about":
          renderTemplate("aboutPageTemplate");
          break;
        case "forum":
          renderForumPage();
          break;
        case "profile":
          renderProfilePage();
          break;
        default:
          appContainer.innerHTML = `<div class="p-6 text-center text-gray-700">Halaman tidak ditemukan.</div>`;
      }
      window.scrollTo(0, 0);
    }

    // Render template by id
    function renderTemplate(templateId) {
      const template = document.getElementById(templateId);
      if (template) {
        appContainer.appendChild(template.content.cloneNode(true));
      }
    }

    // Render Login Page
    function renderLoginPage() {
      renderTemplate("loginPageTemplate");
      const loginForm = document.getElementById("loginForm");
      const googleLoginBtn = document.getElementById("googleLoginBtn");
      const goToRegisterBtn = document.getElementById("goToRegisterBtn");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = loginForm.loginUsername.value.trim();
        const password = loginForm.loginPassword.value;
        if (!username || !password) return alert("Username dan password harus diisi.");

        // Firebase email login: we will treat username as email for simplicity
        try {
          await signInWithEmailAndPassword(auth, username, password);
          // onAuthStateChanged will handle UI update
        } catch (err) {
          alert("Login gagal: " + err.message);
        }
      });

      googleLoginBtn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          // onAuthStateChanged will handle UI update
        } catch (err) {
          alert("Login Google gagal: " + err.message);
        }
      });

      goToRegisterBtn.addEventListener("click", () => {
        navigateTo("register");
      });
    }

    // Render Register Page
    function renderRegisterPage() {
      renderTemplate("registerPageTemplate");
      const registerForm = document.getElementById("registerForm");
      const goToLoginBtn = document.getElementById("goToLoginBtn");

      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fullname = registerForm.fullname.value.trim();
        const address = registerForm.address.value.trim();
        const password = registerForm.password.value;
        const passwordVerify = registerForm.passwordVerify.value;
        const whatsapp = registerForm.whatsapp.value.trim();
        const referral = registerForm.referral.value.trim();

        if (!fullname || !address || !password || !passwordVerify || !whatsapp) {
          return alert("Semua field wajib diisi kecuali kode referral.");
        }
        if (password !== passwordVerify) {
          return alert("Password dan verifikasi password tidak cocok.");
        }
        if (!/^\+?62[0-9]{8,15}$/.test(whatsapp)) {
          return alert("Nomor WhatsApp harus diawali +62 dan valid.");
        }

        // For registration, we will create email from username (fullname + random) for Firebase Auth
        // But since user inputs no email, we will create a fake email with referral code or fullname + timestamp
        // Or better: ask user to input email? But requirement only username/password
        // So we will create email as fullname + timestamp @gmiofficial.local (fake domain)
        // But Firebase requires real email for Google login, so for email/password login, we use this fake email

        // To simplify, we will ask user to input username as email in login, so here we create email from fullname + timestamp
        // This is a workaround for demo purposes.

        const email = fullname.toLowerCase().replace(/\s+/g, "") + Date.now() + "@gmiofficial.local";

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          // Create user document in Firestore
          const userDocRef = doc(db, "users", user.uid);
          const userReferralCode = referral || generateReferralCode();

          await setDoc(userDocRef, {
            fullname,
            address,
            whatsapp,
            referralCode: userReferralCode,
            email: email,
            createdAt: serverTimestamp(),
            points: 0,
            id: user.uid,
          });

          alert("Pendaftaran berhasil. Silakan login menggunakan username dan password Anda.");
          navigateTo("login");
        } catch (err) {
          alert("Pendaftaran gagal: " + err.message);
        }
      });

      goToLoginBtn.addEventListener("click", () => {
        navigateTo("login");
      });
    }

    // Render Forum Page
    function renderForumPage() {
      renderTemplate("forumPageTemplate");
      const postInputBox = document.getElementById("postInputBox");
      const postsContainer = document.getElementById("postsContainer");

      // Load posts from Firestore, only posts within 24 hours
      const postsRef = collection(db, "posts");
      const now = new Date();
      const cutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);

      // Query posts ordered by createdAt desc, only last 24h
      const q = query(postsRef, orderBy("createdAt", "desc"));

      // Real-time listener
      postsUnsubscribe = onSnapshot(q, async (snapshot) => {
        postsContainer.innerHTML = "";
        const posts = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (!data.createdAt) return;
          const createdAtDate = data.createdAt.toDate();
          if (createdAtDate < cutoff) {
            // Delete expired post
            deleteDoc(doc(db, "posts", docSnap.id));
            return;
          }
          posts.push({ id: docSnap.id, ...data });
        });

        if (posts.length === 0) {
          postsContainer.innerHTML = `<p class="text-center text-gray-500">Belum ada postingan.</p>`;
          return;
        }

        for (const post of posts) {
          const postEl = createPostElement(post);
          postsContainer.appendChild(postEl);
        }
      });

      // Click on "Katakan sesuatu..." to open modal for new post
      postInputBox.addEventListener("click", () => {
        openUpdatePostModal();
      });
      postInputBox.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openUpdatePostModal();
        }
      });
    }

    // Create post DOM element
    function createPostElement(post) {
      const postDiv = document.createElement("div");
      postDiv.className =
        "bg-white rounded-lg shadow border border-gray-300 p-4 space-y-3";

      // User name and timestamp
      const headerDiv = document.createElement("div");
      headerDiv.className = "flex justify-between items-center text-gray-700 text-sm";

      const userNameSpan = document.createElement("span");
      userNameSpan.textContent = post.userFullname || "User";

      const timeSpan = document.createElement("time");
      timeSpan.dateTime = post.createdAt.toDate().toISOString();
      timeSpan.textContent = timeSince(post.createdAt.toDate());

      headerDiv.appendChild(userNameSpan);
      headerDiv.appendChild(timeSpan);

      // Post text
      const textP = document.createElement("p");
      textP.className = "text-gray-800 whitespace-pre-wrap";
      textP.textContent = post.text || "";

      postDiv.appendChild(headerDiv);
      postDiv.appendChild(textP);

      // Post image if exists
      if (post.imageUrl) {
        const img = document.createElement("img");
        img.src = post.imageUrl;
        img.alt = `Gambar postingan oleh ${post.userFullname || "user"}`;
        img.className = "w-full max-h-96 object-contain rounded-md";
        postDiv.appendChild(img);
      }

      // Like, Comment, Report buttons
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "flex space-x-6 text-gray-600 text-sm";

      // Like button
      const likeBtn = document.createElement("button");
      likeBtn.className = "flex items-center space-x-1 hover:text-blue-600 focus:outline-none";
      likeBtn.setAttribute("aria-label", "Like postingan");
      const likeIcon = document.createElement("i");
      likeIcon.className = "far fa-thumbs-up";
      const likeCountSpan = document.createElement("span");
      likeCountSpan.textContent = post.likes ? Object.keys(post.likes).length : 0;
      likeBtn.appendChild(likeIcon);
      likeBtn.appendChild(likeCountSpan);

      // Comment button
      const commentBtn = document.createElement("button");
      commentBtn.className = "flex items-center space-x-1 hover:text-blue-600 focus:outline-none";
      commentBtn.setAttribute("aria-label", "Komentar postingan");
      const commentIcon = document.createElement("i");
      commentIcon.className = "far fa-comment";
      const commentCountSpan = document.createElement("span");
      commentCountSpan.textContent = post.comments ? Object.keys(post.comments).length : 0;
      commentBtn.appendChild(commentIcon);
      commentBtn.appendChild(commentCountSpan);

      // Report button
      const reportBtn = document.createElement("button");
      reportBtn.className = "flex items-center space-x-1 hover:text-red-600 focus:outline-none";
      reportBtn.setAttribute("aria-label", "Laporkan postingan");
      const reportIcon = document.createElement("i");
      reportIcon.className = "fas fa-flag";
      const reportTextSpan = document.createElement("span");
      reportTextSpan.textContent = "Report";
      reportBtn.appendChild(reportIcon);
      reportBtn.appendChild(reportTextSpan);

      actionsDiv.appendChild(likeBtn);
      actionsDiv.appendChild(commentBtn);
      actionsDiv.appendChild(reportBtn);

      postDiv.appendChild(actionsDiv);

      // Like button click handler
      likeBtn.addEventListener("click", async () => {
        if (!currentUser) return alert("Silakan login untuk menyukai postingan.");
        const postRef = doc(db, "posts", post.id);
        const userId = currentUser.uid;
        const likes = post.likes || {};
        if (likes[userId]) {
          // Unlike
          delete likes[userId];
        } else {
          likes[userId] = true;
        }
        try {
          await updateDoc(postRef, { likes });
        } catch (err) {
          alert("Gagal memperbarui like: " + err.message);
        }
      });

      // Comment button click handler
      commentBtn.addEventListener("click", () => {
        if (!currentUser) return alert("Silakan login untuk mengomentari postingan.");
        openCommentsModal(post.id);
      });

      // Report button click handler
      reportBtn.addEventListener("click", () => {
        if (!currentUser) return alert("Silakan login untuk melaporkan postingan.");
        openReportModal(post.id);
      });

      return postDiv;
    }

    // Open comments modal for a post
    function openCommentsModal(postId) {
      currentPostIdForComments = postId;
      const modal = document.getElementById("modalComments");
      const commentsList = document.getElementById("commentsList");
      const commentForm = document.getElementById("commentForm");
      const commentInput = document.getElementById("commentInput");
      commentsList.innerHTML = `<p class="text-center text-gray-500">Memuat komentar...</p>`;
      modal.classList.remove("hidden");
      commentInput.value = "";
      commentInput.focus();

      // Load comments realtime
      const commentsRef = collection(db, "posts", postId, "comments");
      const q = query(commentsRef, orderBy("createdAt", "asc"));

      if (commentsUnsubscribe) commentsUnsubscribe();
      commentsUnsubscribe = onSnapshot(q, (snapshot) => {
        commentsList.innerHTML = "";
        if (snapshot.empty) {
          commentsList.innerHTML = `<p class="text-center text-gray-500">Belum ada komentar.</p>`;
          return;
        }
        snapshot.forEach((docSnap) => {
          const comment = docSnap.data();
          const commentEl = createCommentElement(postId, docSnap.id, comment);
          commentsList.appendChild(commentEl);
        });
      });

      // Submit comment
      commentForm.onsubmit = async (e) => {
        e.preventDefault();
        const text = commentInput.value.trim();
        if (!text) return;
        const commentsRef = collection(db, "posts", postId, "comments");
        try {
          await addDoc(commentsRef, {
            userId: currentUser.uid,
            userFullname: currentUser.displayName || currentUser.email || "User",
            text,
            createdAt: serverTimestamp(),
            replies: {},
            likes: {},
          });
          commentInput.value = "";
        } catch (err) {
          alert("Gagal mengirim komentar: " + err.message);
        }
      };
    }

    // Create comment element with replies and like button
    function createCommentElement(postId, commentId, comment) {
      const container = document.createElement("div");
      container.className = "border-b border-gray-200 pb-2";

      const header = document.createElement("div");
      header.className = "flex justify-between items-center text-gray-700 text-sm mb-1";

      const userSpan = document.createElement("span");
      userSpan.textContent = comment.userFullname || "User";

      const timeSpan = document.createElement("time");
      timeSpan.dateTime = comment.createdAt ? comment.createdAt.toDate().toISOString() : "";
      timeSpan.textContent = comment.createdAt ? timeSince(comment.createdAt.toDate()) : "";

      header.appendChild(userSpan);
      header.appendChild(timeSpan);

      const textP = document.createElement("p");
      textP.className = "text-gray-800 whitespace-pre-wrap mb-1";
      textP.textContent = comment.text || "";

      // Actions: Like, Reply
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "flex space-x-4 text-gray-600 text-xs";

      // Like button
      const likeBtn = document.createElement("button");
      likeBtn.className = "flex items-center space-x-1 hover:text-blue-600 focus:outline-none";
      likeBtn.setAttribute("aria-label", "Like komentar");
      const likeIcon = document.createElement("i");
      likeIcon.className = "far fa-thumbs-up";
      const likeCountSpan = document.createElement("span");
      likeCountSpan.textContent = comment.likes ? Object.keys(comment.likes).length : 0;
      likeBtn.appendChild(likeIcon);
      likeBtn.appendChild(likeCountSpan);

      // Reply button
      const replyBtn = document.createElement("button");
      replyBtn.className = "hover:text-blue-600 focus:outline-none";
      replyBtn.textContent = "Reply";

      actionsDiv.appendChild(likeBtn);
      actionsDiv.appendChild(replyBtn);

      container.appendChild(header);
      container.appendChild(textP);
      container.appendChild(actionsDiv);

      // Replies container
      const repliesContainer = document.createElement("div");
      repliesContainer.className = "ml-4 mt-2 space-y-2";
      container.appendChild(repliesContainer);

      // Load replies realtime
      const repliesRef = collection(db, "posts", postId, "comments", commentId, "replies");
      const q = query(repliesRef, orderBy("createdAt", "asc"));
      onSnapshot(q, (snapshot) => {
        repliesContainer.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const reply = docSnap.data();
          const replyEl = document.createElement("div");
          replyEl.className = "border-l border-gray-300 pl-3 text-gray-700 text-sm";
          replyEl.innerHTML = `<span class="font-semibold">${reply.userFullname || "User"}</span>: ${reply.text}`;
          repliesContainer.appendChild(replyEl);
        });
      });

      // Like button click handler
      likeBtn.addEventListener("click", async () => {
        if (!currentUser) return alert("Silakan login untuk menyukai komentar.");
        const commentRef = doc(db, "posts", postId, "comments", commentId);
        const userId = currentUser.uid;
        const likes = comment.likes || {};
        if (likes[userId]) {
          delete likes[userId];
        } else {
          likes[userId] = true;
        }
        try {
          await updateDoc(commentRef, { likes });
        } catch (err) {
          alert("Gagal memperbarui like komentar: " + err.message);
        }
      });

      // Reply button click handler
      replyBtn.addEventListener("click", () => {
        if (!currentUser) return alert("Silakan login untuk membalas komentar.");
        // Show reply input below this comment
        if (container.querySelector(".replyInput")) return; // already open

        const replyForm = document.createElement("form");
        replyForm.className = "replyInput mt-2 flex space-x-2";

        const replyInput = document.createElement("input");
        replyInput.type = "text";
        replyInput.placeholder = "Tulis balasan...";
        replyInput.required = true;
        replyInput.className =
          "flex-grow border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500";

        const replySubmit = document.createElement("button");
        replySubmit.type = "submit";
        replySubmit.textContent = "Kirim";
        replySubmit.className =
          "bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 focus:outline-none";

        replyForm.appendChild(replyInput);
        replyForm.appendChild(replySubmit);
        container.appendChild(replyForm);

        replyInput.focus();

        replyForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const text = replyInput.value.trim();
          if (!text) return;
          const repliesRef = collection(db, "posts", postId, "comments", commentId, "replies");
          try {
            await addDoc(repliesRef, {
              userId: currentUser.uid,
              userFullname: currentUser.displayName || currentUser.email || "User",
              text,
              createdAt: serverTimestamp(),
            });
            replyInput.value = "";
            replyForm.remove();
          } catch (err) {
            alert("Gagal mengirim balasan: " + err.message);
          }
        });
      });

      return container;
    }

    // Open report modal for a post
    function openReportModal(postId) {
      const modal = document.getElementById("modalReport");
      modal.classList.remove("hidden");

      const reportForm = document.getElementById("reportForm");
      const cancelReportBtn = document.getElementById("cancelReportBtn");

      cancelReportBtn.onclick = () => {
        modal.classList.add("hidden");
        reportForm.reset();
      };

      reportForm.onsubmit = (e) => {
        e.preventDefault();
        const reason = reportForm.reportReason.value;
        const details = reportForm.reportDetails.value.trim();

        if (!reason) {
          alert("Silakan pilih alasan laporan.");
          return;
        }

        // Kirim laporan ke WhatsApp via link
        const waNumber = "+628119118047";
        let message = `Laporan dari pengguna ${currentUser.email || currentUser.uid}:\nAlasan: ${reason}`;
        if (details) message += `\nDetail: ${details}`;
        message += `\nLink Postingan: https://gmiofficial.id/posts/${postId}`;

        const waUrl = `https://wa.me/${waNumber.replace(/\D/g, "")}?text=${encodeURIComponent(message)}`;
        window.open(waUrl, "_blank");

        alert("Laporan telah dikirim ke WhatsApp admin.");
        modal.classList.add("hidden");
        reportForm.reset();
      };
    }

    // Open update post modal
    function openUpdatePostModal() {
      const modal = document.getElementById("modalUpdatePost");
      modal.classList.remove("hidden");

      const updatePostForm = document.getElementById("updatePostForm");
      const cancelUpdatePostBtn = document.getElementById("cancelUpdatePostBtn");
      const postText = document.getElementById("postText");
      const postImage = document.getElementById("postImage");

      postText.value = "";
      postImage.value = "";

      cancelUpdatePostBtn.onclick = () => {
        modal.classList.add("hidden");
      };

      updatePostForm.onsubmit = async (e) => {
        e.preventDefault();
        const text = postText.value.trim();
        if (!text) return alert("Teks postingan tidak boleh kosong.");

        modal.classList.add("hidden");

        // Upload image to Imgur if exists
        let imageUrl = null;
        if (postImage.files.length > 0) {
          const file = postImage.files[0];
          try {
            imageUrl = await uploadImageToImgur(file);
          } catch (err) {
            alert("Gagal mengupload gambar: " + err.message);
            return;
          }
        }

        // Save post to Firestore
        try {
          const postRef = await addDoc(collection(db, "posts"), {
            userId: currentUser.uid,
            userFullname: currentUser.displayName || currentUser.email || "User",
            text,
            imageUrl,
            likes: {},
            comments: {},
            createdAt: serverTimestamp(),
          });
          // Post saved
        } catch (err) {
          alert("Gagal membuat postingan: " + err.message);
        }
      };
    }

    // Upload image to Imgur
    async function uploadImageToImgur(file) {
      const formData = new FormData();
      formData.append("image", file);

      const res = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID " + IMGUR_CLIENT_ID,
        },
        body: formData,
      });

      const data = await res.json();
      if (!data.success) {
        throw new Error(data.data.error || "Upload gagal");
      }
      return data.data.link;
    }

    // Render Profile Page
    async function renderProfilePage() {
      renderTemplate("profilePageTemplate");
      const profilePoints = document.getElementById("profilePoints");
      const profileName = document.getElementById("profileName");
      const profileEmail = document.getElementById("profileEmail");
      const profileReferralCode = document.getElementById("profileReferralCode");
      const copyReferralBtn = document.getElementById("copyReferralBtn");

      if (!currentUser) {
        appContainer.innerHTML = `<div class="p-6 text-center text-gray-700">Silakan login terlebih dahulu.</div>`;
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        if (!userDoc.exists()) {
          appContainer.innerHTML = `<div class="p-6 text-center text-gray-700">Data pengguna tidak ditemukan.</div>`;
          return;
        }
        const userData = userDoc.data();
        profilePoints.textContent = userData.points || 0;
        profileName.textContent = userData.fullname || "-";
        profileEmail.textContent = userData.email || "-";
        profileReferralCode.value = userData.referralCode || "";

        copyReferralBtn.onclick = () => {
          profileReferralCode.select();
          profileReferralCode.setSelectionRange(0, 99999);
          navigator.clipboard.writeText(profileReferralCode.value);
          alert("Kode referral disalin ke clipboard.");
        };
      } catch (err) {
        appContainer.innerHTML = `<div class="p-6 text-center text-red-600">Gagal memuat data profil: ${err.message}</div>`;
      }
    }

    // Setup Rate Us page star rating
    function setupRateUs() {
      const stars = document.getElementById("rateStars");
      const reviewTextarea = document.getElementById("rateReview");
      const submitBtn = document.getElementById("submitRateBtn");
      let currentRating = 0;

      stars.querySelectorAll("i").forEach((star) => {
        star.addEventListener("click", () => {
          currentRating = parseInt(star.getAttribute("data-star"));
          updateStars();
        });
      });

      function updateStars() {
        stars.querySelectorAll("i").forEach((star) => {
          const starValue = parseInt(star.getAttribute("data-star"));
          if (starValue <= currentRating) {
            star.classList.remove("far");
            star.classList.add("fas");
          } else {
            star.classList.remove("fas");
            star.classList.add("far");
          }
        });
      }

      submitBtn.onclick = () => {
        if (currentRating === 0) {
          alert("Silakan pilih rating terlebih dahulu.");
          return;
        }
        const review = reviewTextarea.value.trim();
        alert(`Terima kasih atas rating ${currentRating} bintang dan ulasan Anda!`);
        reviewTextarea.value = "";
        currentRating = 0;
        updateStars();
      };
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        // Load user displayName if not set
        if (!user.displayName) {
          // Try to get fullname from Firestore
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const data = userDoc.data();
              if (data.fullname) {
                user.displayName = data.fullname;
              }
            }
          } catch {}
        }
        if (!currentPage || currentPage === "login" || currentPage === "register") {
          navigateTo("home");
        } else {
          navigateTo(currentPage);
        }
      } else {
        navigateTo("login");
      }
    });

    // Close modals handlers
    document.getElementById("closeModalComments").addEventListener("click", () => {
      document.getElementById("modalComments").classList.add("hidden");
      if (commentsUnsubscribe) {
        commentsUnsubscribe();
        commentsUnsubscribe = null;
      }
      currentPostIdForComments = null;
    });

    // Keyboard accessibility for modals (Escape to close)
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (!document.getElementById("modalComments").classList.contains("hidden")) {
          document.getElementById("modalComments").classList.add("hidden");
          if (commentsUnsubscribe) {
            commentsUnsubscribe();
            commentsUnsubscribe = null;
          }
          currentPostIdForComments = null;
        }
        if (!document.getElementById("modalReport").classList.contains("hidden")) {
          document.getElementById("modalReport").classList.add("hidden");
          document.getElementById("reportForm").reset();
        }
        if (!document.getElementById("modalUpdatePost").classList.contains("hidden")) {
          document.getElementById("modalUpdatePost").classList.add("hidden");
          document.getElementById("updatePostForm").reset();
        }
      }
    });
  </script>
 </body>
</html>
