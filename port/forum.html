<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Post dengan Like dan Komentar</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f0f0f0; }
  #posts { max-width: 600px; margin: auto; }
  article { background: #fff; border: 1px solid #ddd; padding: 16px; margin-bottom: 16px; border-radius: 8px; }
  img { max-width: 100%; border-radius: 8px; margin-top: 8px; }
  button.like-btn { cursor: pointer; background: none; border: none; color: green; font-weight: normal; }
  button.like-btn.liked { font-weight: bold; color: darkgreen; }
  #login-form { max-width: 300px; margin: auto 0 40px; }
  #login-form input { width: 100%; padding: 8px; margin: 4px 0; }
  #login-status { margin-bottom: 20px; text-align: center; }
  #logout-btn { cursor: pointer; background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; }
  .comments { margin-top: 12px; font-size: 0.9em; }
  .comment { border-top: 1px solid #eee; padding: 6px 0; }
  .comment .user { font-weight: bold; }
  .comment .text { margin-left: 8px; display: inline-block; }
  .comment-form { margin-top: 8px; }
  .comment-form textarea { width: 100%; height: 50px; padding: 6px; resize: vertical; }
  .comment-form button { margin-top: 4px; }
</style>
</head>
<body>

<div id="login-status">
  <div id="user-info" style="display:none;">
    Logged in as <span id="user-email"></span>
    <button id="logout-btn">Logout</button>
  </div>
  <div id="login-form">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="login-btn">Login</button>
  </div>
</div>

<div id="posts"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, doc, getDocs, getDoc, setDoc, deleteDoc, serverTimestamp,
    onSnapshot, query, orderBy, addDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // Konfigurasi Firebase (ganti dengan config kamu)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const postsDiv = document.getElementById("posts");
  const loginForm = document.getElementById("login-form");
  const userInfoDiv = document.getElementById("user-info");
  const userEmailSpan = document.getElementById("user-email");
  const logoutBtn = document.getElementById("logout-btn");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginBtn = document.getElementById("login-btn");

  loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      alert("Isi email dan password.");
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, password);
      emailInput.value = "";
      passwordInput.value = "";
    } catch (e) {
      alert("Login gagal: " + e.message);
    }
  };

  logoutBtn.onclick = async () => {
    await signOut(auth);
  };

  onAuthStateChanged(auth, user => {
    if (user) {
      loginForm.style.display = "none";
      userInfoDiv.style.display = "block";
      userEmailSpan.textContent = user.email;
      loadPostsRealtime();
    } else {
      loginForm.style.display = "block";
      userInfoDiv.style.display = "none";
      postsDiv.innerHTML = "<p>Silakan login untuk melihat dan memberi like postingan.</p>";
    }
  });

  // Buat elemen komentar
  function createCommentElement(commentId, username, text) {
    const div = document.createElement("div");
    div.classList.add("comment");
    div.id = `comment-${commentId}`;

    const userSpan = document.createElement("span");
    userSpan.classList.add("user");
    userSpan.textContent = username + ": ";

    const textSpan = document.createElement("span");
    textSpan.classList.add("text");
    textSpan.textContent = text;

    div.appendChild(userSpan);
    div.appendChild(textSpan);

    return div;
  }

  // Fungsi buat elemen post dengan like dan komentar
  function createPostElement(postId, username, description, imageUrl, likeCount, userHasLiked) {
    const postEl = document.createElement("article");

    const header = document.createElement("h3");
    header.textContent = username;
    postEl.appendChild(header);

    const desc = document.createElement("p");
    desc.textContent = description;
    postEl.appendChild(desc);

    if (imageUrl) {
      const img = document.createElement("img");
      img.src = imageUrl;
      postEl.appendChild(img);
    }

    // Tombol like
    const likeBtn = document.createElement("button");
    likeBtn.className = "like-btn";
    likeBtn.textContent = `Like (${likeCount})`;
    if (userHasLiked) likeBtn.classList.add("liked");

    likeBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("Silakan login dulu untuk memberi like.");
        return;
      }
      const likeRef = doc(db, "posts", postId, "likes", user.uid);

      try {
        if (userHasLiked) {
          await deleteDoc(likeRef);
          likeCount--;
          userHasLiked = false;
          likeBtn.classList.remove("liked");
        } else {
          await setDoc(likeRef, { createdAt: serverTimestamp() });
          likeCount++;
          userHasLiked = true;
          likeBtn.classList.add("liked");
        }
        likeBtn.textContent = `Like (${likeCount})`;
      } catch (e) {
        console.error("Error updating like:", e);
      }
    };
    postEl.appendChild(likeBtn);

    // Container komentar
    const commentsContainer = document.createElement("div");
    commentsContainer.classList.add("comments");
    postEl.appendChild(commentsContainer);

    // Form komentar
    const commentForm = document.createElement("form");
    commentForm.classList.add("comment-form");
    commentForm.innerHTML = `
      <textarea placeholder="Tulis komentar..." required></textarea>
      <button type="submit">Kirim</button>
    `;
    postEl.appendChild(commentForm);

    // Tangani submit komentar
    commentForm.onsubmit = async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("Silakan login dulu untuk mengirim komentar.");
        return;
      }
      const textarea = commentForm.querySelector("textarea");
      const text = textarea.value.trim();
      if (!text) return;

      try {
        await addDoc(collection(db, "posts", postId, "comments"), {
          uid: user.uid,
          text,
          createdAt: serverTimestamp(),
        });
        textarea.value = "";
      } catch (e) {
        console.error("Gagal kirim komentar:", e);
      }
    };

    // Load komentar realtime
    const commentsCol = collection(db, "posts", postId, "comments");
    const q = query(commentsCol, orderBy("createdAt", "asc"));
    onSnapshot(q, async (commentsSnap) => {
      commentsContainer.innerHTML = ""; // kosongkan komentar dulu

      // Ambil username untuk setiap komentar
      const commentDocs = commentsSnap.docs;
      for (const commentDoc of commentDocs) {
        const commentData = commentDoc.data();
        const userDoc = await getDoc(doc(db, "users", commentData.uid));
        const commentUsername = userDoc.exists() ? userDoc.data().username : "Anonim";

        const commentEl = createCommentElement(commentDoc.id, commentUsername, commentData.text);
        commentsContainer.appendChild(commentEl);
      }
    });

    return postEl;
  }

  // Load post realtime dengan komentar dan like
  function loadPostsRealtime() {
    const postsCol = collection(db, "posts");

    onSnapshot(postsCol, async snapshot => {
      postsDiv.innerHTML = "";

      const posts = snapshot.docs;
      for (const postDoc of posts) {
        const postData = postDoc.data();
        const postId = postDoc.id;

        const userDoc = await getDoc(doc(db, "users", postData.uid));
        const username = userDoc.exists() ? userDoc.data().username : "Anonim";

        const likesCol = collection(db, "posts", postId, "likes");
        const likesSnapshot = await getDocs(likesCol);
        const likeCount = likesSnapshot.size;

        let userHasLiked = false;
        const user = auth.currentUser;
        if (user) {
          const userLikeDoc = await getDoc(doc(db, "posts", postId, "likes", user.uid));
          userHasLiked = userLikeDoc.exists();
        }

        const postEl = createPostElement(
          postId,
          username,
          postData.description,
          postData.imageUrl || null,
          likeCount,
          userHasLiked
        );

        postsDiv.appendChild(postEl);
      }
      if (posts.length === 0) {
        postsDiv.innerHTML = "<p>Belum ada postingan.</p>";
      }
    });
  }

</script>

</body>
</html>
