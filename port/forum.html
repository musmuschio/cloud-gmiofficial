<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forum Komentar Realtime</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getDatabase,
      ref,
      push,
      onValue
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    const postsDiv = document.getElementById("posts");
    const commentModal = document.getElementById("commentModal");
    const commentList = document.getElementById("commentList");
    const commentForm = document.getElementById("commentForm");
    const commentInput = document.getElementById("commentInput");
    const closeCommentModalBtn = document.getElementById("closeCommentModal");
    const commentReplyForm = document.getElementById("commentReplyForm");
    const commentReplyInput = document.getElementById("commentReplyInput");

    let currentPostId = null;
    let currentReplyToId = null;

    function clearPosts() {
      postsDiv.innerHTML = "";
    }

    function createPostElement(id, username, description, imageUrl) {
      const postEl = document.createElement("div");
      postEl.className = "bg-white shadow-md p-4 rounded-xl mb-4";

      const nameEl = document.createElement("h2");
      nameEl.textContent = username;
      nameEl.className = "text-lg font-semibold";

      const descEl = document.createElement("p");
      descEl.textContent = description;
      descEl.className = "mt-1 whitespace-pre-line";

      const btnContainer = document.createElement("div");
      btnContainer.className = "mt-3 flex flex-wrap gap-3 items-center";

      const commentBtn = document.createElement("button");
      commentBtn.textContent = "ðŸ’¬ Komentar";
      commentBtn.className =
        "bg-blue-500 hover:bg-blue-600 transition text-white px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-400";
      commentBtn.onclick = () => openComments(id);

      const reportLink = document.createElement("a");
      reportLink.href = `https://wa.me/6281234567890?text=Lapor postingan oleh ${encodeURIComponent(
        username
      )}`;
      reportLink.textContent = "ðŸš¨ Laporkan";
      reportLink.className =
        "text-red-500 underline hover:text-red-700 transition";

      postEl.appendChild(nameEl);
      postEl.appendChild(descEl);
      if (imageUrl) {
        const img = document.createElement("img");
        img.src = imageUrl;
        img.alt =
          "Gambar postingan yang relevan dengan konten, berwarna cerah dan menarik";
        img.className = "mt-3 rounded max-w-full h-auto object-cover";
        postEl.appendChild(img);
      }

      btnContainer.appendChild(commentBtn);
      btnContainer.appendChild(reportLink);
      postEl.appendChild(btnContainer);

      return postEl;
    }

    function loadPosts() {
      const postsRef = collection(db, "posts");

      onSnapshot(postsRef, (snapshot) => {
        clearPosts();
        snapshot.forEach((doc) => {
          const data = doc.data();
          const postEl = createPostElement(
            doc.id,
            data.username || "Anonim",
            data.description || "",
            data.imageUrl || ""
          );
          postsDiv.appendChild(postEl);
        });
      });
    }

    function openComments(postId) {
      currentPostId = postId;
      currentReplyToId = null;
      commentModal.classList.remove("hidden");
      loadComments(postId);
      commentReplyForm.classList.add("hidden");
      commentReplyInput.value = "";
      commentInput.focus();
    }

    function closeComments() {
      commentModal.classList.add("hidden");
      commentList.innerHTML = "";
      currentReplyToId = null;
      commentReplyForm.classList.add("hidden");
      commentReplyInput.value = "";
      commentInput.value = "";
    }

    function loadComments(postId) {
      const commentsRef = ref(rtdb, `comments/${postId}`);

      onValue(commentsRef, (snapshot) => {
        commentList.innerHTML = "";
        const data = snapshot.val();
        if (data) {
          const commentsArray = Object.entries(data);
          commentsArray.sort((a, b) => a[1].createdAt - b[1].createdAt);
          commentsArray.forEach(([commentId, commentData]) => {
            const commentEl = document.createElement("div");
            commentEl.className =
              "mb-3 border border-gray-200 rounded p-3 bg-gray-50";

            const userLine = document.createElement("p");
            userLine.className = "font-semibold text-gray-800";
            userLine.textContent = commentData.username;

            const textLine = document.createElement("p");
            textLine.className = "mt-1 text-gray-700 whitespace-pre-line";
            textLine.textContent = commentData.text;

            const replyBtn = document.createElement("button");
            replyBtn.textContent = "Balas";
            replyBtn.className =
              "text-sm text-blue-600 hover:underline mt-2 focus:outline-none";
            replyBtn.onclick = () => replyToComment(commentId);

            const repliesContainer = document.createElement("div");
            repliesContainer.className = "ml-5 mt-2 space-y-1 text-gray-700 text-sm";

            if (commentData.replies) {
              // Sort replies by createdAt ascending
              const repliesArray = Object.entries(commentData.replies);
              repliesArray.sort((a, b) => a[1].createdAt - b[1].createdAt);
              repliesArray.forEach(([_, reply]) => {
                const replyEl = document.createElement("p");
                replyEl.innerHTML = `<strong>${reply.username}</strong>: ${reply.text}`;
                repliesContainer.appendChild(replyEl);
              });
            }

            commentEl.appendChild(userLine);
            commentEl.appendChild(textLine);
            commentEl.appendChild(replyBtn);
            commentEl.appendChild(repliesContainer);

            commentList.appendChild(commentEl);
          });
        } else {
          const noCommentEl = document.createElement("p");
          noCommentEl.className = "text-gray-500 italic";
          noCommentEl.textContent = "Belum ada komentar.";
          commentList.appendChild(noCommentEl);
        }
      });
    }

    function replyToComment(commentId) {
      currentReplyToId = commentId;
      commentReplyForm.classList.remove("hidden");
      commentReplyInput.focus();
    }

    window.replyToComment = replyToComment;

    function submitComment(e) {
      e.preventDefault();
      const text = commentInput.value.trim();
      if (!text || !currentPostId) return;

      const commentRef = ref(rtdb, `comments/${currentPostId}`);
      push(commentRef, {
        username: "User",
        text,
        createdAt: Date.now()
      });

      commentInput.value = "";
    }

    function submitReply(e) {
      e.preventDefault();
      const text = commentReplyInput.value.trim();
      if (!text || !currentReplyToId || !currentPostId) return;

      const replyRef = ref(
        rtdb,
        `comments/${currentPostId}/${currentReplyToId}/replies`
      );
      push(replyRef, {
        username: "User",
        text,
        createdAt: Date.now()
      });

      commentReplyInput.value = "";
      commentReplyForm.classList.add("hidden");
      currentReplyToId = null;
    }

    commentForm.addEventListener("submit", submitComment);
    commentReplyForm.addEventListener("submit", submitReply);
    closeCommentModalBtn.addEventListener("click", closeComments);

    function closeModalByClickOutside(e) {
      const modalContent = document.querySelector("#commentModal > div");
      if (!modalContent.contains(e.target)) {
        closeComments();
      }
    }
    window.closeModalByClickOutside = closeModalByClickOutside;

    loadPosts();
  </script>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col">
  <main class="flex-grow max-w-3xl w-full mx-auto">
    <div id="posts"></div>
  </main>

  <!-- Modal Komentar -->
  <div
    id="commentModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center overflow-auto py-10 px-4"
    onclick="closeModalByClickOutside(event)"
    aria-modal="true"
    role="dialog"
    aria-labelledby="modalTitle"
  >
    <div
      class="bg-white p-6 rounded-xl max-w-md w-full shadow-lg relative flex flex-col"
      onclick="event.stopPropagation()"
    >
      <button
        id="closeCommentModal"
        class="absolute top-3 right-3 text-red-600 hover:text-red-800 text-2xl font-bold focus:outline-none"
        aria-label="Tutup modal komentar"
      >
        &times;
      </button>
      <h2 id="modalTitle" class="text-xl font-bold mb-4 text-gray-900">Komentar</h2>
      <div
        id="commentList"
        class="max-h-72 overflow-y-auto mb-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"
        tabindex="0"
        aria-live="polite"
      ></div>
      <form id="commentForm" class="flex gap-2 mb-3" aria-label="Form tambah komentar">
        <input
          id="commentInput"
          type="text"
          placeholder="Tulis komentar..."
          class="flex-1 p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
          aria-required="true"
          aria-describedby="commentInputDesc"
        />
        <button
          type="submit"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          Kirim
        </button>
      </form>
      <form
        id="commentReplyForm"
        class="hidden flex gap-2"
        aria-label="Form balas komentar"
      >
        <input
          id="commentReplyInput"
          type="text"
          placeholder="Balas komentar..."
          class="flex-1 p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-400"
          aria-required="true"
          aria-describedby="commentReplyInputDesc"
        />
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-4 rounded focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          Balas
        </button>
      </form>
    </div>
  </div>
</body>
</html>
