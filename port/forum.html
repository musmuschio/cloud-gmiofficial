<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // Konfigurasi Firebase kamu
    const firebaseConfig = {
      apiKey: "AIzaSyBrhBBX1CIt5JzCh25tPUwqHJjIVIeyef8",
      authDomain: "gmi-official21-74326.firebaseapp.com",
      projectId: "gmi-official21-74326",
      storageBucket: "gmi-official21-74326.appspot.com",
      messagingSenderId: "496607636364",
      appId: "1:496607636364:web:5c0428ccad6952faa544a9",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <button
    onclick="window.location.href='update.html'"
    class="mb-6 px-5 py-3 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 transition flex items-center gap-2"
    aria-label="Upload Status"
  >
    <i class="fas fa-plus"></i> Upload Status
  </button>
  <div id="forum" class="w-full max-w-3xl space-y-6"></div>

  <script>
    const forumDiv = document.getElementById("forum");

    function timeDiffExpired(timestamp) {
      const now = new Date();
      const createdAt = timestamp.toDate();
      return now - createdAt > 24 * 60 * 60 * 1000;
    }

    function renderStatus(doc) {
      const data = doc.data();
      if (timeDiffExpired(data.createdAt)) return; // skip jika sudah lewat 24 jam

      const statusDiv = document.createElement("div");
      statusDiv.className = "bg-white p-5 rounded-lg shadow";

      statusDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center gap-3">
            <img src="https://placehold.co/40x40/png?text=U" alt="Avatar pengguna ${data.username}" class="rounded-full w-10 h-10 object-cover" />
            <b class="text-lg text-gray-800">${data.username}</b>
          </div>
          <span class="text-xs text-gray-400">${data.createdAt.toDate().toLocaleString('id-ID')}</span>
        </div>
        <p class="text-gray-700 mb-4 whitespace-pre-line">${data.description}</p>
        <div class="flex flex-wrap gap-3 mb-4">
          <button onclick="likeStatus('${doc.id}')" class="flex items-center gap-2 px-3 py-1 rounded-md bg-green-100 text-green-700 hover:bg-green-200 transition">
            <i class="fas fa-thumbs-up"></i> Like (${data.likes?.length || 0})
          </button>
          <button onclick="dislikeStatus('${doc.id}')" class="flex items-center gap-2 px-3 py-1 rounded-md bg-red-100 text-red-700 hover:bg-red-200 transition">
            <i class="fas fa-thumbs-down"></i> Dislike (${data.dislikes?.length || 0})
          </button>
          <button onclick="shareStatus('${doc.id}')" class="flex items-center gap-2 px-3 py-1 rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition">
            <i class="fas fa-share-alt"></i> Share
          </button>
          <button onclick="reportStatus('${data.username}')" class="flex items-center gap-2 px-3 py-1 rounded-md bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition">
            <i class="fas fa-flag"></i> Laporkan
          </button>
        </div>
        <div class="comment-box">
          <div class="flex gap-2 mb-3">
            <input type="text" placeholder="Komentar..." id="comment-${doc.id}" class="flex-grow border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button onclick="addComment('${doc.id}')" class="bg-blue-600 text-white px-4 rounded-md hover:bg-blue-700 transition">Kirim</button>
          </div>
          <div id="comments-${doc.id}" class="space-y-4"></div>
        </div>
      `;
      forumDiv.appendChild(statusDiv);

      loadComments(doc.id);
    }

    // Load status
    db.collection("statuses").orderBy("createdAt", "desc").onSnapshot(snapshot => {
      forumDiv.innerHTML = "";
      snapshot.docs.forEach(renderStatus);
    });

    // Like
    function likeStatus(id) {
      const userId = auth.currentUser?.uid;
      if (!userId) return alert("Login dulu");

      const ref = db.collection("statuses").doc(id);
      ref.update({
        likes: firebase.firestore.FieldValue.arrayUnion(userId),
        dislikes: firebase.firestore.FieldValue.arrayRemove(userId)
      });
    }

    // Dislike
    function dislikeStatus(id) {
      const userId = auth.currentUser?.uid;
      if (!userId) return alert("Login dulu");

      const ref = db.collection("statuses").doc(id);
      ref.update({
        dislikes: firebase.firestore.FieldValue.arrayUnion(userId),
        likes: firebase.firestore.FieldValue.arrayRemove(userId)
      });
    }

    // Share (bisa modifikasi dengan navigator.share jika mobile)
    function shareStatus(id) {
      const url = window.location.href.split('?')[0] + "?status=" + id;
      navigator.clipboard.writeText(url);
      alert("Link status disalin!");
    }

    // Report
    function reportStatus(username) {
      const pesan = `melaporkan status atas nama ${username}`;
      const waLink = `https://wa.me/628119118047?text=${encodeURIComponent(pesan)}`;
      window.open(waLink, "_blank");
    }

    // Tambah Komentar
    function addComment(statusId) {
      const commentInput = document.getElementById(`comment-${statusId}`);
      const comment = commentInput.value.trim();
      const user = auth.currentUser;
      if (!user) return alert("Login dulu");
      if (!comment) return;

      db.collection("statuses").doc(statusId).collection("comments").add({
        userId: user.uid,
        username: user.displayName || user.email,
        comment,
        createdAt: new Date()
      }).then(() => {
        commentInput.value = "";
        loadComments(statusId); // refresh komentar
      });
    }

    // Load komentar + reply
    function loadComments(statusId) {
      const commentsDiv = document.getElementById(`comments-${statusId}`);
      commentsDiv.innerHTML = "";
      db.collection("statuses").doc(statusId).collection("comments")
        .orderBy("createdAt").get().then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "bg-gray-50 p-3 rounded-md shadow-sm";
            div.innerHTML = `
              <b class="text-gray-800">${data.username}</b>: <span class="text-gray-700">${data.comment}</span>
              <div class="reply-box mt-2">
                <div class="flex gap-2 mb-2">
                  <input type="text" placeholder="Balas..." id="reply-${statusId}-${doc.id}" class="flex-grow border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                  <button onclick="replyComment('${statusId}', '${doc.id}')" class="bg-blue-600 text-white px-3 rounded-md hover:bg-blue-700 transition">Balas</button>
                </div>
                <div id="replies-${statusId}-${doc.id}" class="space-y-1 pl-4 border-l border-gray-300"></div>
              </div>
            `;
            commentsDiv.appendChild(div);
            loadReplies(statusId, doc.id);
          });
        });
    }

    // Balas Komentar
    function replyComment(statusId, commentId) {
      const replyInput = document.getElementById(`reply-${statusId}-${commentId}`);
      const replyText = replyInput.value.trim();
      const user = auth.currentUser;
      if (!user) return alert("Login dulu");
      if (!replyText) return;

      db.collection("statuses").doc(statusId)
        .collection("comments").doc(commentId)
        .collection("replies").add({
          userId: user.uid,
          username: user.displayName || user.email,
          reply: replyText,
          createdAt: new Date()
        }).then(() => {
          replyInput.value = "";
          loadReplies(statusId, commentId);
        });
    }

    // Load reply
    function loadReplies(statusId, commentId) {
      const repliesDiv = document.getElementById(`replies-${statusId}-${commentId}`);
      repliesDiv.innerHTML = "";
      db.collection("statuses").doc(statusId).collection("comments")
        .doc(commentId).collection("replies")
        .orderBy("createdAt").get().then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            const p = document.createElement("p");
            p.className = "text-gray-600 text-sm";
            p.innerHTML = `↪️ <b>${data.username}</b>: ${data.reply}`;
            repliesDiv.appendChild(p);
          });
        });
    }
  </script>
</body>
</html>
