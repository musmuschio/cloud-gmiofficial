<html class="scroll-smooth" lang="id">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   FORUM
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter&amp;display=swap" rel="stylesheet"/>
  <style>
   body {
      font-family: 'Inter', sans-serif;
    }
  </style>
 </head>
 <body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-green-600 text-white flex items-center justify-between px-5 py-3 shadow-md sticky top-0 z-30">
   <div class="flex items-center space-x-3">
    <img alt="Logo FORUM berupa lingkaran hijau dengan tulisan FORUM di tengah" class="h-10 w-10 object-contain rounded-full" height="40" src="https://storage.googleapis.com/a1aa/image/c8d86706-e7b9-461e-8b0f-ad684bfca71b.jpg" width="40"/>
    <h1 class="font-extrabold text-xl sm:text-2xl select-none">
     FORUM
    </h1>
   </div>
   <button aria-label="Posting" class="bg-white text-green-600 font-semibold px-4 py-2 rounded-md shadow hover:bg-green-50 transition" onclick="window.location.href='update.html'">
    Posting
   </button>
  </header>
  <main class="flex-grow max-w-3xl mx-auto w-full px-4 py-6 space-y-6" id="posts">
  </main>
  <!-- Modal Login/Daftar -->
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50" id="loginModal">
   <div class="bg-white rounded-xl shadow-lg w-full max-w-sm p-6" id="loginModalContent">
    <h3 class="text-2xl font-semibold mb-5 text-center text-green-700" id="formTitle">
     Login / Daftar
    </h3>
    <form class="space-y-4" id="authForm" onsubmit="return false;">
     <input aria-label="Username saat daftar" autocomplete="username" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="username" placeholder="Username (saat daftar)" type="text"/>
     <input aria-label="Alamat saat daftar" autocomplete="street-address" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="alamat" placeholder="Alamat (saat daftar)" type="text"/>
     <input aria-label="Email" autocomplete="email" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="email" placeholder="Email" required="" type="email"/>
     <input aria-label="Password" autocomplete="current-password" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" id="password" placeholder="Password" required="" type="password"/>
     <div class="flex justify-between space-x-3">
      <button aria-label="Login" class="flex-1 bg-green-600 text-white font-semibold rounded-md py-2 hover:bg-green-700 transition" onclick="login()" type="button">
       Login
      </button>
      <button aria-label="Daftar" class="flex-1 bg-green-100 text-green-700 font-semibold rounded-md py-2 hover:bg-green-200 transition" onclick="register()" type="button">
       Daftar
      </button>
     </div>
    </form>
   </div>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBrhBBX1CIt5JzCh25tPUwqHJjIVIeyef8",
    authDomain: "gmi-official21-74326.firebaseapp.com",
    projectId: "gmi-official21-74326",
    storageBucket: "gmi-official21-74326.appspot.com",
    messagingSenderId: "496607636364",
    appId: "1:496607636364:web:5c0428ccad6952faa544a9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const postsDiv = document.getElementById("posts");
  const loginModal = document.getElementById("loginModal");

  // Fungsi untuk membuat elemen postingan
  function createPostElement(id, username, description, imageUrl) {
    const postEl = document.createElement("article");
    postEl.className = "bg-white rounded-lg shadow-md p-5 space-y-3";

    const userHeader = document.createElement("div");
    userHeader.className = "flex items-center space-x-3";

    const userIcon = document.createElement("div");
    userIcon.className = "flex items-center justify-center bg-green-100 text-green-700 rounded-full w-10 h-10 text-lg font-bold select-none";
    userIcon.textContent = username.charAt(0).toUpperCase();

    const userNameEl = document.createElement("p");
    userNameEl.className = "font-semibold text-green-800 text-lg truncate";
    userNameEl.textContent = username;

    userHeader.appendChild(userIcon);
    userHeader.appendChild(userNameEl);

    const descEl = document.createElement("p");
    descEl.className = "text-gray-800 whitespace-pre-wrap break-words";
    descEl.textContent = description;

    postEl.appendChild(userHeader);
    postEl.appendChild(descEl);

    if (imageUrl) {
      const imgEl = document.createElement("img");
      imgEl.src = imageUrl;
      imgEl.alt = `Gambar postingan oleh ${username}`;
      imgEl.className = "w-full max-h-96 object-cover rounded-md mt-2";
      postEl.appendChild(imgEl);
    }

    const btnContainer = document.createElement("div");
    btnContainer.className = "flex space-x-3";

    const commentBtn = document.createElement("button");
    commentBtn.type = "button";
    commentBtn.className = "flex items-center space-x-2 text-green-600 hover:text-green-800 font-semibold transition";
    commentBtn.setAttribute("aria-label", `Komentar untuk postingan oleh ${username}`);
    commentBtn.innerHTML = `<i class="fas fa-comments"></i><span>Komentar</span>`;
    commentBtn.onclick = () => openComments(id);

    btnContainer.appendChild(commentBtn);
    postEl.appendChild(btnContainer);

    return postEl;
  }

  // Fungsi untuk membuka modal komentar
  async function openComments(postId) {
    const commentsModal = document.createElement("div");
    commentsModal.className = "fixed inset-0 bg-white flex flex-col p-6 z-50";
    const commentsContainer = document.createElement("div");
    commentsContainer.className = "overflow-y-auto space-y-4";

    const closeBtn = document.createElement("button");
    closeBtn.className = "self-end text-red-600 font-semibold";
    closeBtn.textContent = "Tutup";
    closeBtn.onclick = () => commentsModal.remove();

    const newCommentInput = document.createElement("textarea");
    newCommentInput.className = "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500";
    newCommentInput.placeholder = "Tulis komentar...";

    const submitCommentBtn = document.createElement("button");
    submitCommentBtn.className = "bg-green-600 text-white font-semibold rounded-md py-2 mt-2";
    submitCommentBtn.textContent = "Kirim Komentar";
    submitCommentBtn.onclick = async () => {
      const user = auth.currentUser;
      if (user) {
        await addDoc(collection(db, "comments"), {
          postId: postId,
          uid: user.uid,
          content: newCommentInput.value,
          timestamp: new Date()
        });
        loadComments(postId);
        newCommentInput.value = "";  // Clear input
      } else {
        alert("Silakan login terlebih dahulu.");
      }
    };

    commentsModal.appendChild(closeBtn);
    commentsModal.appendChild(newCommentInput);
    commentsModal.appendChild(submitCommentBtn);
    commentsModal.appendChild(commentsContainer);
    document.body.appendChild(commentsModal);

    await loadComments(postId);
  }

  // Fungsi untuk memuat komentar
  async function loadComments(postId) {
    const commentsContainer = document.querySelector("div[aria-live='commentsContainer']");
    commentsContainer.innerHTML = ""; // Clear previous comments

    const q = query(collection(db, "comments"), orderBy("timestamp", "desc"));
    const querySnapshot = await getDocs(q);

    for (const docSnap of querySnapshot.docs) {
      const data = docSnap.data();
      if (data.postId === postId) {
        const userRef = doc(db, "users", data.uid);
        const userSnap = await getDoc(userRef);
        const username = userSnap.exists() ? userSnap.data().username : "Anonim";

        const commentEl = document.createElement("div");
        commentEl.className = "bg-gray-100 p-3 rounded-md space-y-2";

        const userNameEl = document.createElement("p");
        userNameEl.className = "font-semibold text-green-800";
        userNameEl.textContent = username;

        const contentEl = document.createElement("p");
        contentEl.className = "text-gray-800";
        contentEl.textContent = data.content;

        commentEl.appendChild(userNameEl);
        commentEl.appendChild(contentEl);

        commentsContainer.appendChild(commentEl);
      }
    }
  }

  // Cek login
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      loginModal.classList.remove("hidden");
      loginModal.classList.add("flex");
    } else {
      loginModal.classList.add("hidden");
      loginModal.classList.remove("flex");
      await loadPosts();
    }
  });

  // Login
  window.login = async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    try {
      await signInWithEmailAndPassword(auth, email, password);
      loginModal.classList.add("hidden");
      loginModal.classList.remove("flex");
      location.reload();
    } catch (e) {
      alert("Login gagal: " + e.message);
    }
  };

  // Register
  window.register = async () => {
    const username = document.getElementById("username").value.trim();
    const alamat = document.getElementById("alamat").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!username || !alamat || !email || !password) {
      alert("Lengkapi semua data!");
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      await setDoc(doc(db, "users", user.uid), {
        username,
        email,
        alamat
      });

      loginModal.classList.add("hidden");
      loginModal.classList.remove("flex");
      location.reload();
    } catch (e) {
      alert("Registrasi gagal: " + e.message);
    }
  };
</script>

 </body>
</html>
