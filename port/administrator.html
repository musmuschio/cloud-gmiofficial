<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - GMI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      updateDoc,
      deleteDoc,
      addDoc,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBggKVSzDyI-meBSL3BMjA736Ss-j_My0E",
      authDomain: "gmi-enterprise23.firebaseapp.com",
      projectId: "gmi-enterprise23",
      storageBucket: "gmi-enterprise23.firebasestorage.app",
      messagingSenderId: "974090028804",
      appId: "1:974090028804:web:43ae563ffd9433463c7251",
      measurementId: "G-S27YB5Z8PR",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.addEventListener("DOMContentLoaded", () => {
      const userList = document.getElementById("userList");
      const statusList = document.getElementById("statusList");
      const form = document.getElementById("postForm");
      const judulInput = document.getElementById("judul");
      const isiInput = document.getElementById("isi");

      // Load Users
      const usersQuery = query(collection(db, "users"), orderBy("createdAt", "desc"));
      onSnapshot(usersQuery, (snapshot) => {
        userList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const u = docSnap.data();
          const createdAt = u.createdAt?.seconds
            ? new Date(u.createdAt.seconds * 1000)
            : null;
          const createdAtStr = createdAt
            ? createdAt.toLocaleString("id-ID", {
                day: "numeric",
                month: "long",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              })
            : "-";

          const tr = document.createElement("tr");
          tr.className = "border-b";

          tr.innerHTML = `
            <td class="p-2">
              <input type="text" class="w-full border rounded px-2 py-1 text-sm" value="${u.fullName || ""}" id="name-${docSnap.id}" />
            </td>
            <td class="p-2">
              <input type="email" class="w-full border rounded px-2 py-1 text-sm" value="${u.email || ""}" id="email-${docSnap.id}" />
            </td>
            <td class="p-2">
              <input type="text" class="w-full border rounded px-2 py-1 text-sm" value="${u.whatsapp || ""}" id="wa-${docSnap.id}" />
            </td>
            <td class="p-2">
              <input type="text" class="w-full border rounded px-2 py-1 text-sm bg-gray-100 cursor-not-allowed" value="${u.referral || "-"}" disabled />
            </td>
            <td class="p-2">
              <input type="number" min="0" class="w-full border rounded px-2 py-1 text-sm" value="${u.point || 0}" id="point-${docSnap.id}" />
            </td>
            <td class="p-2 text-sm text-gray-600">${createdAtStr}</td>
            <td class="p-2 flex space-x-2">
              <button aria-label="Simpan user" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded text-sm flex items-center justify-center" data-id="${docSnap.id}" data-action="save" type="button">
                <i class="fas fa-save"></i>
              </button>
              <button aria-label="Hapus user" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded text-sm flex items-center justify-center" data-id="${docSnap.id}" data-action="delete" type="button">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          `;
          userList.appendChild(tr);
        });
      });

      // Load Statuses
      const statusesQuery = query(collection(db, "statuses"), orderBy("timestamp", "desc"));
      onSnapshot(statusesQuery, (snapshot) => {
        statusList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const s = docSnap.data();
          const timestamp = s.timestamp?.seconds
            ? new Date(s.timestamp.seconds * 1000)
            : null;
          const timeStr = timestamp
            ? timestamp.toLocaleString("id-ID", {
                day: "numeric",
                month: "long",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              })
            : "-";

          const li = document.createElement("li");
          li.className =
            "border border-gray-300 rounded p-3 mb-2 bg-white shadow-sm";
          li.innerHTML = `
            <p class="font-semibold text-gray-800">${s.userName || "-"}</p>
            <p class="text-gray-700 whitespace-pre-line">${s.description || ""}</p>
            <p class="text-xs text-gray-500 mt-1">${timeStr}</p>
          `;
          statusList.appendChild(li);
        });
      });

      // Event delegation for user save/delete buttons
      userList.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        if (!id || !action) return;

        if (action === "save") {
          try {
            const name = document.getElementById(`name-${id}`).value.trim();
            const email = document.getElementById(`email-${id}`).value.trim();
            const wa = document.getElementById(`wa-${id}`).value.trim();
            const pointVal = document.getElementById(`point-${id}`).value;
            const point = parseInt(pointVal);
            if (!name || !email || isNaN(point) || point < 0) {
              alert("Mohon isi data dengan benar.");
              return;
            }
            await updateDoc(doc(db, "users", id), {
              fullName: name,
              email: email,
              whatsapp: wa,
              point: point,
            });
            alert("User diperbarui");
          } catch (err) {
            alert("Gagal memperbarui user: " + err.message);
          }
        } else if (action === "delete") {
          if (confirm("Hapus user ini?")) {
            try {
              await deleteDoc(doc(db, "users", id));
              alert("User dihapus");
            } catch (err) {
              alert("Gagal menghapus user: " + err.message);
            }
          }
        }
      });

      // Post Berita
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const judul = judulInput.value.trim();
        const isi = isiInput.value.trim();
        if (!judul || !isi) {
          alert("Judul dan isi berita harus diisi.");
          return;
        }
        try {
          await addDoc(collection(db, "news"), {
            title: judul,
            content: isi,
            createdAt: serverTimestamp(),
          });
          alert("Berita terkirim");
          judulInput.value = "";
          isiInput.value = "";
        } catch (err) {
          alert("Gagal mengirim berita: " + err.message);
        }
      });
    });

    const flyerForm = document.getElementById("flyerForm");
const flyerTitle = document.getElementById("flyerTitle");
const flyerContent = document.getElementById("flyerContent");
const flyerImage = document.getElementById("flyerImage");

flyerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const title = flyerTitle.value.trim();
  const content = flyerContent.value.trim();
  const image = flyerImage.value.trim();

  if (!title || !content) {
    alert("Judul dan deskripsi flyer wajib diisi.");
    return;
  }

  try {
    await addDoc(collection(db, "informasi"), {
      title,
      content,
      image: image || null,
      createdAt: serverTimestamp(),
    });
    alert("Flyer berhasil dikirim ke halaman informasi.");
    flyerTitle.value = "";
    flyerContent.value = "";
    flyerImage.value = "";
  } catch (err) {
    alert("Gagal mengirim flyer: " + err.message);
  }
});


    // Memantau pengguna affiliate
const affiliateList = document.getElementById("affiliateList");
onSnapshot(usersQuery, (snapshot) => {
  affiliateList.innerHTML = "";
  snapshot.forEach((docSnap) => {
    const u = docSnap.data();
    if (u.isAffiliate) {
      const li = document.createElement("li");
      li.className = "p-2 border-b text-sm";
      li.innerHTML = `<strong>${u.fullName}</strong> - ${u.email} (${u.point || 0} poin)`;
      affiliateList.appendChild(li);
    }
  });
});

  </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 flex flex-col max-w-6xl mx-auto">
  <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Admin Panel GMI</h1>

  <div class="mb-6 border-b border-gray-300">
    <nav class="flex space-x-4" aria-label="Tabs" role="tablist" id="tabs">
      <button
        role="tab"
        aria-selected="true"
        aria-controls="dashboard"
        id="tab-dashboard"
        class="px-4 py-2 font-semibold text-blue-700 border-b-2 border-blue-700 focus:outline-none"
        type="button"
      >
        Dashboard
      </button>
      <button
        role="tab"
        aria-selected="false"
        aria-controls="postingan"
        id="tab-postingan"
        class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-700 border-b-2 border-transparent focus:outline-none"
        type="button"
      >
        Postingan
      </button>
      <button
        role="tab"
        aria-selected="false"
        aria-controls="kirim"
        id="tab-kirim"
        class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-700 border-b-2 border-transparent focus:outline-none"
        type="button"
      >
        Kirim Berita
      </button>
    </nav>
  </div>

  <section
    id="dashboard"
    role="tabpanel"
    aria-labelledby="tab-dashboard"
    class="tab-panel"
  >
    <h2 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Affiliate Terdaftar</h2>
    <ul id="affiliateList" class="bg-white border rounded shadow p-4 max-h-60 overflow-y-auto text-gray-700"></ul>
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Data Pengguna</h2>
    <div class="overflow-x-auto border rounded shadow bg-white">
      <table class="min-w-full border-collapse table-auto">
        <thead class="bg-blue-100 text-blue-800 font-semibold">
          <tr>
            <th class="p-2 border border-blue-200 text-left">Nama</th>
            <th class="p-2 border border-blue-200 text-left">Email</th>
            <th class="p-2 border border-blue-200 text-left">WA</th>
            <th class="p-2 border border-blue-200 text-left">Referral</th>
            <th class="p-2 border border-blue-200 text-left">Point</th>
            <th class="p-2 border border-blue-200 text-left">Waktu</th>
            <th class="p-2 border border-blue-200 text-left">Aksi</th>
          </tr>
        </thead>
        <tbody id="userList" class="text-gray-700"></tbody>
      </table>
    </div>
  </section>

  <section
    id="postingan"
    role="tabpanel"
    aria-labelledby="tab-postingan"
    class="hidden tab-panel"
  >
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Postingan Status</h2>
    <ul id="statusList" class="max-h-[400px] overflow-y-auto"></ul>
  </section>

  <section
    id="kirim"
    role="tabpanel"
    aria-labelledby="tab-kirim"
    class="hidden tab-panel"
  >
    <hr class="my-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Posting Flyer ke Informasi</h2>
    <form id="flyerForm" class="space-y-4 mb-6">
    <input type="text" id="flyerTitle" placeholder="Judul flyer" required class="w-full p-2 border rounded" />
    <textarea id="flyerContent" placeholder="Deskripsi flyer" required class="w-full p-2 border rounded"></textarea>
    <input type="url" id="flyerImage" placeholder="URL gambar flyer (Opsional)" class="w-full p-2 border rounded" />
    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Kirim Flyer</button>
    </form>

    <h2 class="text-xl font-semibold mb-4 text-gray-800">Kirim Berita ke Home</h2>
    <form id="postForm" class="max-w-xl space-y-4 bg-white p-6 rounded shadow">
      <input
        type="text"
        id="judul"
        placeholder="Judul Berita"
        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        required
      />
      <textarea
        id="isi"
        placeholder="Isi Berita"
        rows="6"
        class="w-full border border-gray-300 rounded px-3 py-2 resize-y focus:outline-none focus:ring-2 focus:ring-blue-500"
        required
      ></textarea>
      <button
        type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        Kirim
      </button>
    </form>
  </section>

  <script>
  const now = Date.now();
  const loginTime = parseInt(localStorage.getItem("adminLoginTime"));
  const isLoggedIn = localStorage.getItem("adminLogin");

  const validDuration = 6 * 60 * 60 * 1000;

  if (isLoggedIn !== "true" || (now - loginTime > validDuration)) {
    alert("Sesi admin kedaluwarsa. Silakan login ulang.");
    localStorage.removeItem("adminLogin");
    localStorage.removeItem("adminLoginTime");
    window.location.href = "kloterAdmin.html";
  }
    // Tabs functionality
    const tabs = document.querySelectorAll("[role=tab]");
    const tabPanels = document.querySelectorAll("[role=tabpanel]");

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => {
          t.setAttribute("aria-selected", "false");
          t.classList.remove("border-blue-700", "text-blue-700");
          t.classList.add("border-transparent", "text-gray-600");
        });
        tab.setAttribute("aria-selected", "true");
        tab.classList.add("border-blue-700", "text-blue-700");
        tab.classList.remove("border-transparent", "text-gray-600");

        const target = tab.getAttribute("aria-controls");
        tabPanels.forEach((panel) => {
          if (panel.id === target) {
            panel.classList.remove("hidden");
          } else {
            panel.classList.add("hidden");
          }
        });
      });
    });
  </script>
</body>
</html>
